<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√≥digo Grabado</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Base para temas (CSS Variables) */
        :root {
            /* Tema por defecto: Principal (Azul y Gris Oscuro) */
            --bg-body: #111827; /* gray-900 */
            --bg-primary: #1F2937; /* gray-800 */
            --bg-secondary: #374151; /* gray-700 */
            --text-body: #F9FAFB; /* gray-50 */
            --text-secondary: #D1D5DB; /* gray-300 */
            --color-header: #2563EB; /* blue-600 */
            --color-accent: #3B82F6; /* blue-500 */
            --color-danger: #F43F5E; /* rose-500 */
            --color-success: #10B981; /* emerald-500 */
            --color-info: #60A5FA; /* blue-400 */
        }

        /* ---------------- TEMA 1: HACKER (Verde y Negro) ---------------- */
        .theme-hacker {
            --bg-body: #000000;
            --bg-primary: #0A0A0A;
            --bg-secondary: #1F1F1F;
            --text-body: #00FF00; /* Neon Green */
            --text-secondary: #00B300;
            --color-header: #008000;
            --color-accent: #00B300;
            --color-danger: #FF0000; /* Red for errors */
            --color-success: #00FF00;
            --color-info: #00B300;
        }
        /* ---------------- TEMA 2: TRADICIONAL (Blanco y Negro) ---------------- */
        .theme-light {
            --bg-body: #FFFFFF;
            --bg-primary: #F3F4F6; /* gray-100 */
            --bg-secondary: #D1D5DB; /* gray-300 */
            --text-body: #1F2937; /* gray-800 */
            --text-secondary: #4B5563; /* gray-600 */
            --color-header: #1D4ED8; /* blue-700 */
            --color-accent: #3B82F6; /* blue-500 */
            --color-danger: #DC2626; /* Red */
            --color-success: #059669; /* emerald-600 */
            --color-info: #60A5FA;
        }
        /* ---------------- TEMA 3: ALERTA (Rojo y Negro) ---------------- */
        .theme-alert {
            --bg-body: #1F0000;
            --bg-primary: #330000;
            --bg-secondary: #4B0000;
            --text-body: #FEE2E2; /* Red-100 */
            --text-secondary: #FCA5A5; /* Red-300 */
            --color-header: #B91C1C;
            --color-accent: #DC2626; /* Red-600 */
            --color-danger: #FDE047; /* Yellow for errors */
            --color-success: #4ADE80; /* Green for success */
            --color-info: #F87171;
        }
        
        /* Mapeo de variables CSS a clases de Tailwind (Alta Especificidad) */
        body {
            background-color: var(--bg-body) !important;
            color: var(--text-body) !important;
        }
        /* Color del Header */
        header { background-color: var(--color-header) !important; }

        /* Colores de Fondo Principales (Secciones y Cartas) */
        .bg-gray-800 { background-color: var(--bg-primary) !important; }
        .bg-gray-700 { background-color: var(--bg-secondary) !important; }
        .text-gray-100 { color: var(--text-body) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        
        /* Colores de Botones y Acentos Din√°micos (Clase 'theme-accent') */
        .theme-accent { background-color: var(--color-accent) !important; }
        .theme-accent-hover:hover { background-color: var(--color-accent) !important; }
        .theme-accent-text { color: var(--color-accent) !important; }
        .theme-highlight-border { border-color: var(--color-accent) !important; }

        /* Colores de Mensajes de Estado */
        .bg-rose-200 { background-color: var(--color-danger); opacity: 0.2; }
        .text-rose-800 { color: var(--color-danger); }
        .bg-emerald-200 { background-color: var(--color-success); opacity: 0.2; }
        .text-emerald-800 { color: var(--color-success); }
        .bg-blue-200 { background-color: var(--color-info); opacity: 0.2; }
        .text-blue-800 { color: var(--color-info); }
        
        /* Estilo para el men√∫ desplegable */
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        /* Ajuste para el estilo de respuesta Markdown (prose) */
        .prose :where(code):not(:where([class~="not-prose"] *)) {
            padding: 0.2em 0.4em;
            border-radius: 0.3em;
            background-color: var(--bg-secondary);
            color: var(--text-body);
        }
    </style>
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, getDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
// Configuraci√≥n de Firebase (Se mantiene la configuraci√≥n original del usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
            authDomain: "codigograbado.firebaseapp.com",
            projectId: "codigograbado",
            storageBucket: "codigograbado.firebasestorage.app",
            messagingSenderId: "346430888474",
            appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
 
            measurementId: "G-626THBS8CJ"
        };
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, loggedInUser = null;
        let functionsList = [];
        let editingId = null;
        let confirmActionCallback = null;
        
        let isSyntaxValid = false;
        let isContextualMode = false; 
        let dbSchema = null; 
// SE ELIMINAN LAS CREDENCIALES CODIFICADAS DEL SUPER ADMIN
        const SUPER_ADMIN_KEY = 'DT10VazC;#9i';
// Rutas de Firestore
        const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
        const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
const ADMINS_PATH = `${DB_ROOT}/admins`;
        const LOGS_PATH = `${DB_ROOT}/logs`;
        const NOTIFICATIONS_PATH = `${DB_ROOT}/notifications`;
// ************************************************************
        // ********* FUNCI√ìN DE MANEJO DE TEMAS *******
        // ************************************************************
        const initializeTheme = () => {
             const savedTheme = localStorage.getItem('theme') || 'default';
             setTheme(savedTheme);
        };
        
        const setTheme = (themeName) => {
             const body = document.body;
             // Remover todas las clases de tema existentes
             body.classList.remove('theme-hacker', 'theme-light', 'theme-alert');

             if (themeName !== 'default') {
                body.classList.add(`theme-${themeName}`);
             }
             localStorage.setItem('theme', themeName);

             // Reaplicar clases a elementos clave para forzar la actualizaci√≥n de Tailwind
             updateDynamicElements(); 
        };

        const updateDynamicElements = () => {
            // Actualiza botones principales
            document.querySelectorAll('.btn-primary-bg').forEach(el => {
                el.classList.add('theme-accent');
                el.classList.add('theme-accent-hover');
                el.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-sky-600', 'hover:bg-sky-700');
            });

            // Actualiza la barra de navegaci√≥n y botones dropdown
            document.querySelector('header').classList.add('theme-accent-bg');
            document.querySelectorAll('.dropdown-button-accent').forEach(el => {
                el.classList.add('theme-accent');
                el.classList.add('theme-accent-hover');
            });
        };
        // ************************************************************
        
        // --- Funciones del Modal de Esquema DB ---
        const showDBSchemaModal = () => {
            document.getElementById('dbSchemaModal').classList.remove('hidden');
            document.getElementById('dbSchemaModal').classList.add('flex');
            document.getElementById('dbSchemaInput').value = dbSchema || '';
        };

        const hideDBSchemaModal = () => {
            document.getElementById('dbSchemaModal').classList.add('hidden');
            document.getElementById('dbSchemaModal').classList.remove('flex');
        };

        const updateDBSchema = (schema, changeMode = true) => {
            dbSchema = schema;
            localStorage.setItem('dbSchema', schema);
            
            if (changeMode) {
                isContextualMode = true;
                localStorage.setItem('isContextualMode', 'true');
                showMessage('Esquema guardado. ¬°Modo Asistencia Contextual activado! Ahora puedes hacer consultas espec√≠ficas.', 'success');
                toggleContextualView();
            }
        };

        const clearDBSchema = () => {
            dbSchema = null;
            isContextualMode = false;
            localStorage.removeItem('dbSchema');
            localStorage.removeItem('isContextualMode');
            showMessage('Esquema borrado. Modo Asistencia Contextual desactivado.', 'info');
            toggleContextualView();
        };

        const toggleContextualView = () => {
            const defaultSection = document.getElementById('defaultQuerySection'); 
            const contextualSection = document.getElementById('contextualQuerySection'); 
            const contextualSchemaText = document.getElementById('contextualSchemaText');
            
            // Actualizar el texto del bot√≥n del men√∫
            document.getElementById('modeToggleText').textContent = isContextualMode 
                ? 'Desactivar Modo Contextual' 
                : 'Activar Modo Contextual (Estructura DB)';
            
            // Actualizar la vista principal
            if (isContextualMode) {
                defaultSection.classList.add('hidden');
                contextualSection.classList.remove('hidden');
                contextualSchemaText.textContent = 'Cargado.';
            } else {
                defaultSection.classList.remove('hidden');
                contextualSection.classList.add('hidden');
                contextualSchemaText.textContent = 'Inactivo.';
            }
        }
        // --- Fin Funciones de Esquema DB ---


        // --- Funciones del Modal de Confirmaci√≥n ---
        const showConfirmModal = (message, onConfirm) => {
            document.getElementById('confirmModalMessage').textContent = message;
document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
            confirmActionCallback = onConfirm;
        };

        const hideConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden');
document.getElementById('confirmModal').classList.remove('flex');
            confirmActionCallback = null;
        };

        const handleConfirm = (isConfirmed) => {
            if (isConfirmed && confirmActionCallback) {
                confirmActionCallback();
}
            hideConfirmModal();
        };
// --- Fin Funciones del Modal de Confirmaci√≥n ---


        // Funci√≥n para inicializar Firebase
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
db = getFirestore(app);
                auth = getAuth(app); 
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
} else {
                    await signInAnonymously(auth);
}
                
                userId = auth.currentUser.uid;
document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;
                
                console.log("Firebase inicializado y autenticaci√≥n exitosa.");
                fetchFunctions();
} catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
showMessage("Error: No se pudo conectar a la base de datos.", 'error');
            }
        };
const showMessage = (message, type = 'info') => {
            const statusMessage = document.getElementById('statusMessage');
let targetElement = statusMessage; 
            if (!targetElement) {
                targetElement = document.getElementById('recommendationResults');
}

            if (!targetElement) return;
targetElement.innerHTML = `<div class="mt-4 text-center p-3 rounded-lg font-medium" id="tempStatusMessage">${message}</div>`;
            const tempStatusMessage = document.getElementById('tempStatusMessage');

            tempStatusMessage.className = 'mt-4 text-center p-3 rounded-lg font-medium';
if (type === 'error') {
                tempStatusMessage.classList.add('bg-rose-200', 'text-rose-800');
} else if (type === 'success') {
                tempStatusMessage.classList.add('bg-emerald-200', 'text-emerald-800');
} else {
                // Tema Blueberry Oscuro: Info messages are light blue
                tempStatusMessage.classList.add('bg-blue-200', 'text-blue-800');
}

            if (targetElement !== statusMessage) {
                setTimeout(() => {
                    targetElement.innerHTML = '';
                }, 5000);
}
        };
        
// ************************************************************
// ********* FUNCIONES DE AUTENTICACI√ìN (MOVIDAS AL TOP) *******
// ************************************************************
const sendWelcomeMessage = async (lastLogin, username) => {
    const welcomeMessageDiv = document.getElementById('welcomeMessage');
    let actionsSummary = '';
    
    // L√≥gica de logs aqu√≠... 
    
    const diffMs = lastLogin ?
    new Date() - lastLogin.toDate() : null;
    const diffDays = diffMs ?
    Math.floor(diffMs / (1000 * 60 * 60 * 24)) : null;
    const timeAgo = diffDays !== null ?
    `${diffDays} d√≠a(s)` : 'primera vez';

    welcomeMessageDiv.textContent = 'Generando mensaje de bienvenida...';

    const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // CLAVE EXPUESTA
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    const prompt = `Genera un mensaje de bienvenida para un administrador de una base de datos de comandos de SQL.
    El nombre del usuario es "${username}". Su √∫ltima sesi√≥n fue hace "${timeAgo}".
    El mensaje debe ser breve, motivador y debe recordarle revisar el panel de logs.
    Incluye el siguiente resumen de su actividad: "${actionsSummary}". Termina el mensaje con la frase "¬°Buen c√≥digo!".`;
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: "Genera un mensaje de bienvenida amigable y motivador." }] },
    };
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || `¬°Bienvenido de nuevo, ${username}!`;
        welcomeMessageDiv.textContent = text;
    } catch (error) {
        console.error("Error al generar el mensaje de bienvenida:", error);
        welcomeMessageDiv.textContent = `¬°Bienvenido de nuevo, ${username}! Te recordamos que revises el panel de logs. ¬°Buen c√≥digo!`;
    }
};

const logout = async () => {
    try {
        if (auth.currentUser) {
            await signOut(auth);
        }
        
        loggedInUser = null;
        // Ocultar secciones de administraci√≥n
        document.getElementById('addFunctionSection').classList.add('hidden');
        document.getElementById('fixErrorSection').classList.add('hidden');
        document.getElementById('notificationsSection').classList.add('hidden');
        
        // Mostrar/Ocultar elementos del men√∫
        document.getElementById('adminDropdownLogin').classList.remove('hidden');
        document.getElementById('adminDropdownLogout').classList.add('hidden');
        document.getElementById('adminDropdownManagement').classList.add('hidden');
        document.getElementById('welcomeMessage').classList.add('hidden');


        await signInAnonymously(auth);
        userId = auth.currentUser.uid;
        document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;

        displayFunctions(); 

        showMessage('Sesi√≥n cerrada correctamente.', 'info');
    } catch (error) {
        console.error("Error al cerrar sesi√≥n o al re-autenticar an√≥nimamente:", error);
        showMessage('Error al cerrar sesi√≥n.', 'error');
    }
};

const login = async (event) => {
    event.preventDefault();
    const loginEmail = document.getElementById('loginEmail').value.trim();
    const loginPassword = document.getElementById('loginPassword').value;
    const loginMessage = document.getElementById('loginMessage');
    
    loginMessage.textContent = '';
    loggedInUser = null;
    let userFound = false;
    let uid = null;

    try {
        const userCredential = await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
        const user = userCredential.user;
        uid = user.uid;

        loggedInUser = { 
            uid: uid,
            username: loginEmail.split('@')[0], 
            isAdmin: true, 
            lastLogin: null 
        };
        userFound = true;
        // L√≥gica de logs aqu√≠... 

    } catch (e) {
        console.error("Error de autenticaci√≥n:", e);
        const errorCode = e.code || '';
        
        if (errorCode === 'auth/invalid-credential' || errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
            loginMessage.textContent = 'Credenciales incorrectas.';
        } else {
            loginMessage.textContent = 'Error de autenticaci√≥n.\nVerifica tus datos.';
        }
        loginMessage.classList.add('text-rose-500');
        return;
    }


    if (userFound) {
        closeAdminModal();
        // Cierra el modal al iniciar sesi√≥n
        
        // Mostrar botones de administraci√≥n en el men√∫
        document.getElementById('adminDropdownLogin').classList.add('hidden');
        document.getElementById('adminDropdownLogout').classList.remove('hidden');
        document.getElementById('adminDropdownManagement').classList.remove('hidden');


        document.getElementById('addFunctionSection').classList.remove('hidden');
        document.getElementById('fixErrorSection').classList.remove('hidden');
        
        displayFunctions();
        // Refresca botones de editar/eliminar

        const userDataRef = doc(db, ADMINS_PATH, loggedInUser.uid);
        await sendWelcomeMessage(loggedInUser.lastLogin, loggedInUser.username);
        
        await setDoc(userDataRef, { 
            lastLogin: new Date(),
            username: loggedInUser.username,
            uid: loggedInUser.uid,
            isAdmin: true 
        
        }, { merge: true });
        showMessage(`¬°Bienvenido, ${loggedInUser.username}! Has iniciado sesi√≥n con √©xito.`, 'success');
        document.getElementById('welcomeMessage').classList.remove('hidden');
    }
};

const createAdmin = async (event) => {
    event.preventDefault();
    const newAdminEmail = document.getElementById('newAdminEmail').value.trim();
    const newAdminPassword = document.getElementById('newAdminPassword').value;
    const newAdminUsername = document.getElementById('newAdminUsername').value.trim();
    const secretKey = document.getElementById('secretKey').value;
    const adminMessage = document.getElementById('adminMessage');
    adminMessage.textContent = '';
    adminMessage.className = 'mt-4 text-center text-sm';
    
    const isPromotingExistingUser = secretKey === SUPER_ADMIN_KEY;
    if (!newAdminEmail || !newAdminPassword || !newAdminUsername) {
        adminMessage.textContent = 'Todos los campos son obligatorios.';
        adminMessage.classList.add('text-rose-500');
        return;
    }
    
    let uid = null;
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
        uid = userCredential.user.uid;
    } catch (e) {
        if (e.code === 'auth/email-already-in-use') {
            if (isPromotingExistingUser) {
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                    uid = userCredential.user.uid;
                    await signOut(auth);
                    adminMessage.textContent = 'Advertencia: El email ya exist√≠a.\nSe asignar√°n permisos de administrador.';
                    adminMessage.classList.add('text-yellow-500');
                } catch (signInError) {
                    let displayError = 'Error: El email ya est√° registrado, pero la contrase√±a no coincide.\nNo se puede obtener el UID para asignar permisos.';
                    adminMessage.textContent = displayError;
                    adminMessage.classList.add('text-rose-500');
                    return;
                }
            } else {
                adminMessage.textContent = 'Error: El email ya est√° registrado.\nPara promocionar a un usuario existente, ingrese la clave secreta.';
                adminMessage.classList.add('text-rose-500');
                return;
            }
        } else if (e.code === 'auth/weak-password') {
            adminMessage.textContent = 'Error: La contrase√±a debe tener al menos 6 caracteres.';
            adminMessage.classList.add('text-rose-500');
            return;
        } else {
            console.error("Error al crear usuario Auth:", e);
            adminMessage.textContent = `Error (${e.code || 'unknown-error'}): No se pudo crear la cuenta de usuario.`;
            adminMessage.classList.add('text-rose-500');
            return;
        }
    }
    
    if (!uid) { return; } 

    try {
        await setDoc(doc(db, ADMINS_PATH, uid), {
            uid: uid,
            username: newAdminUsername,
            email: newAdminEmail,
            isAdmin: true, 
            lastLogin: null
        }, { merge: true });
        if (!adminMessage.classList.contains('text-yellow-500')) {
            adminMessage.textContent = `Administrador ${newAdminUsername} creado con √©xito.\nAhora puede iniciar sesi√≥n con su email y contrase√±a.`;
            adminMessage.classList.add('text-emerald-500');
        }
        document.getElementById('createAdminForm').reset();
    } catch (e) {
        console.error("Error al registrar administrador en Firestore:", e);
        adminMessage.textContent = 'Error: Se cre√≥ la cuenta de Auth, pero fall√≥ el registro de permisos en Firestore.';
        adminMessage.classList.add('text-rose-500');
    }
};
// ************************************************************

const fetchFunctions = () => {
            if (!db) return;
const q = collection(db, FUNCTIONS_PATH);
            onSnapshot(q, (snapshot) => {
                functionsList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
               
displayFunctions();
            }, (error) => {
                console.error("Error al obtener comandos:", error);
                showMessage("Error al cargar los comandos.", 'error');
            });
};

const displayFunctions = (functionsToDisplay = functionsList) => {
    const listElement = document.getElementById('functionsList');
    const searchList = document.getElementById('searchFunctionsList');
    listElement.innerHTML = '';
    searchList.innerHTML = '';

    const isUserLoggedIn = loggedInUser !== null;
    if (functionsToDisplay.length === 0) {
        listElement.innerHTML = '<p class="text-center text-gray-500">No se encontraron comandos.</p>';
    }

    functionsToDisplay.forEach(func => {
        const funcItem = document.createElement('div');
        funcItem.className = 'p-4 rounded-lg shadow-md mb-4 bg-gray-700';
        
        funcItem.innerHTML = `
            <h3 class="text-xl font-bold text-gray-100">${func.name}</h3>
            <p class="text-sm text-gray-300 mb-2"><strong>Descripci√≥n:</strong> ${func.description}</p>
            <div class="p-3 rounded-lg border border-gray-600 overflow-x-auto bg-gray-800">
                <pre class="whitespace-pre-wrap font-mono text-gray-100"><code>${func.syntax}</code></pre>
            </div>
            <div class="mt-4 flex space-x-2 ${isUserLoggedIn ? '' : 'hidden'}">
                <button class="edit-btn bg-sky-600 
hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg 
transition duration-200 text-sm" data-id="${func.id}">Editar</button>
                <button class="delete-btn bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Eliminar</button>
            </div>
        `;
        listElement.appendChild(funcItem);

        if (isUserLoggedIn) {
            // Se usa func.id y el nombre de las funciones globales aqu√≠
            funcItem.querySelector('.edit-btn').addEventListener('click', () => editFunction(func));
            funcItem.querySelector('.delete-btn').addEventListener('click', () => deleteFunction(func.id));
        }

        const searchItem = document.createElement('li');
        searchItem.className = 'hover:bg-blue-700 cursor-pointer p-2 rounded-md transition duration-150 text-gray-100'; 
        searchItem.textContent = func.name;
        searchItem.onclick = () => {
            document.getElementById('descriptionSearch').value = func.description;
            document.getElementById('descriptionSearch').focus();
            showMessage(`Descripci√≥n del comando "${func.name}" cargada en el generador de consultas.`, 'info');
        };
        searchList.appendChild(searchItem);
    });
};

const validateFunctionWithAI = async () => {
    const name = document.getElementById('funcName').value.trim();
    const description = document.getElementById('funcDescription').value.trim();
    const syntax = document.getElementById('funcSyntax').value.trim();
    const validationMessageDiv = document.getElementById('validationMessage');
    const validateButton = document.getElementById('validateSyntaxButton');
    
    if (!loggedInUser) {
        validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Debes iniciar sesi√≥n para pre-validar la sintaxis.</p>`;
        return;
    }

    if (!name || !description || !syntax) {
        validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Completa los campos Nombre, Descripci√≥n y Sintaxis para validar.</p>`;
        return;
    }

    validateButton.textContent = 'Validando...';
    validateButton.disabled = true;
    validationMessageDiv.innerHTML = `<p class="mt-2 text-center p-3 rounded-lg font-medium bg-blue-200 text-blue-800">Analizando sintaxis con IA...</p>`;
    isSyntaxValid = false;
    
    const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; 
    
    let prompt = `Eres un experto en SQL.
    El usuario est√° intentando guardar un comando SQL.
    1. **Comando/Concepto Intendado:** "${name}"
    2. **Descripci√≥n:** "${description}"
    3. **Sintaxis proporcionada:** "${syntax}"

    Eval√∫a si la 'Sintaxis proporcionada' es un comando SQL bien formado (DDL, DML, TCL, o una funci√≥n SQL) y que est√© razonablemente relacionado con el 'Comando/Concepto Intendado'.
    - Si la Sintaxis es un comando SQL v√°lido, responde con: SI:VALIDA
    - Si la Sintaxis NO es un comando SQL v√°lido (ej. est√° incompleto o es err√≥neo), analiza la sintaxis y la descripci√≥n para sugerir el comando SQL que el usuario probablemente pretend√≠a usar.
    Responde con: NO:Sugerencia de Comando: [Comando/Correcci√≥n sugerida]`;


    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: "Responde estrictamente con 'SI:VALIDA' o 'NO:Sugerencia de Comando: [COMANDO SUGERIDO/CORRECCI√ìN]'. No uses comillas ni explicaciones adicionales." }] },
    };
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        
        const responseText = text.trim().toUpperCase();
        if (responseText.startsWith('SI:VALIDA')) {
            isSyntaxValid = true;
            validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-emerald-800 bg-emerald-200 p-3 rounded-lg">¬°Validaci√≥n exitosa! La sintaxis es un comando SQL v√°lido. Puedes guardar.</p>`;
        } else if (responseText.startsWith('NO:SUGERENCIA DE COMANDO:')) {
            const suggestion = responseText.replace('NO:SUGERENCIA DE COMANDO:', '').trim();
            const userMessage = `Error de Sintaxis: Lo que ingresaste NO es un comando SQL v√°lido.
            Sugerencia de la IA: **${suggestion}**.\nPor favor, ajusta la sintaxis y vuelve a validar.`;
            validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">${userMessage}</p>`;
        } else {
            validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Error: La sintaxis no es v√°lida.\nInt√©ntalo de nuevo.</p>`;
        }
    } catch (error) {
        console.error("Error al validar con IA:", error);
        validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Error de conexi√≥n: No se pudo validar con la IA.</p>`;
    } finally {
        validateButton.textContent = 'Pre-validar Sintaxis con IA ‚ú®';
        validateButton.disabled = false;
    }
};

// ************************************************************
// ********* FUNCI√ìN PRINCIPAL DE CONSULTA SQL (CONTEXTUAL/DEFAULT) *****
// ************************************************************
const runSQLQuery = async (description, isContextual) => {
    // Determinar elementos de la interfaz seg√∫n el modo
    const button = isContextual ? document.getElementById('contextualQueryButton') : document.getElementById('descriptionSearchButton');
    const resultsDiv = isContextual ? document.getElementById('contextualQueryResults') : document.getElementById('recommendationResults');
    const originalButtonText = button.textContent;
    
    if (!description) {
        showMessage('Por favor, describe tu necesidad para generar la consulta.', 'error');
        return;
    }

    button.textContent = 'Generando...';
    button.disabled = true;
    resultsDiv.innerHTML = '';
    
    resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-blue-200 text-blue-800">Generando consulta SQL...</p>`;
    
    const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // <-- CLAVE A√öN EXPUESTA
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    let systemInstructionText = "Genera exclusivamente c√≥digo SQL para bases de datos relacionales, sin ning√∫n texto, explicaci√≥n o comentarios. Si la solicitud no es de SQL, responde con 'NO:SQL'.";
    let prompt = `Eres un experto en SQL. Genera una consulta SQL (solo el c√≥digo, no expliques nada) basada en la siguiente descripci√≥n. 
Si la descripci√≥n NO est√° relacionada con SQL, bases de datos, o programaci√≥n, responde estrictamente con: NO:SQL. 
Descripci√≥n: "${description}".`;

    if (isContextual) {
        // Modo Contextual: La IA recibe el esquema para consultas espec√≠ficas.
        prompt = `Eres un experto en SQL que act√∫a como asistente de un programador. Tienes acceso a esta estructura de base de datos (DB): 
        --- DB SCHEMA ---
        ${dbSchema}
        --- END SCHEMA ---
        Bas√°ndote SOLAMENTE en el esquema proporcionado, genera la consulta SQL que responde a la siguiente solicitud. Si no es posible con el esquema dado, dilo. No incluyas comentarios ni explicaciones. Solicitud: "${description}".`;
        systemInstructionText = "Genera exclusivamente c√≥digo SQL, sin explicaciones ni comentarios, que resuelva la solicitud usando el esquema provisto. Si la respuesta no es SQL, responde con 'NO:SQL'.";
    }

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstructionText }] },
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            throw new Error(`Error en la API: ${response.statusText}`);
        }

        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        
        const responseText = text.trim();

        if (responseText.toUpperCase() === 'NO:SQL') {
             resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-rose-200 text-rose-800">
                ‚ö†Ô∏è Te recuerdo que este sitio est√° dise√±ado para temas relacionados con **SQL y programaci√≥n**. Este tipo de consultas no pueden ser resueltas aqu√≠.
            </p>`;
             return;
        }

        const sqlCode = responseText.replace(/```sql|```/g, '').trim();
        
        resultsDiv.innerHTML = `
            <h3 class="text-xl font-bold mt-4 mb-2 text-gray-100">Consulta Generada:</h3>
            <div class="bg-gray-800 p-4 rounded-lg border border-blue-400 overflow-x-auto">
                <pre class="whitespace-pre-wrap font-mono text-gray-100"><code>${sqlCode}</code></pre>
            </div>
        `;
        showMessage('Consulta SQL generada con √©xito.', 'success');
        
    } catch (error) {
        console.error("Error al generar la consulta SQL:", error);
        resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-rose-200 text-rose-800">Error al generar la consulta: ${error.message}. Intenta de nuevo.</p>`;
    } finally {
        button.textContent = isContextual ? 'Generar Consulta Contextual üí°' : 'Generar Consulta SQL ‚ú®';
        button.disabled = false;
    }
};

// Modifica las funciones de interfaz para llamar a runSQLQuery:
const generateSQLQuery = async () => {
    const description = document.getElementById('descriptionSearch').value.trim();
    return runSQLQuery(description, false); // Modo Normal
};

const generateContextualQuery = async () => {
    const description = document.getElementById('contextualQueryInput').value.trim();
    if (!dbSchema) {
        showMessage('Error: Debes activar el Modo Contextual y cargar el esquema de la DB primero.', 'error');
        return;
    }
    return runSQLQuery(description, true); // Modo Contextual
};
// ************************************************************

const addOrUpdateFunction = async (event) => {
    event.preventDefault();
    const name = document.getElementById('funcName').value.trim();
    const description = document.getElementById('funcDescription').value.trim();
    const syntax = document.getElementById('funcSyntax').value.trim();
    const button = document.getElementById('addFunctionButton');
    const originalButtonText = editingId ? 'Actualizar Comando' : 'Guardar Comando';
    
    if (!loggedInUser) {
        showMessage('Debes iniciar sesi√≥n para realizar esta acci√≥n.', 'error');
        return;
    }

    if (!name || !description || !syntax) {
        showMessage('Todos los campos son obligatorios.', 'error');
        return;
    }
    
    if (!isSyntaxValid && !editingId) {
        document.getElementById('validationMessage').innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">¬°Atenci√≥n!\nLa sintaxis no ha sido pre-validada o la validaci√≥n fall√≥.
Usa el bot√≥n "Pre-validar" antes de guardar.</p>`;
        return;
    }

    button.textContent = 'Guardando...';
    button.disabled = true;
    try {
        if (editingId) {
            await updateDoc(doc(db, FUNCTIONS_PATH, editingId), {
                name,
                description,
                syntax,
            });
            // CREACI√ìN DE LOG
            await addDoc(collection(db, LOGS_PATH), {
                action: "edited",
                user: loggedInUser.username,
                functionName: name,
                timestamp: new Date()
            });
            showMessage(`Comando actualizado con √©xito.`, 'success');
            editingId = null;
            document.getElementById('addFunctionButton').textContent = 'Guardar Comando';
        } else {
            await addDoc(collection(db, FUNCTIONS_PATH), {
                name,
                description,
                syntax,
                createdAt: new Date()
            });
            // CREACI√ìN DE LOG
            await addDoc(collection(db, LOGS_PATH), {
                action: "added",
                user: loggedInUser.username,
                functionName: name,
                timestamp: new Date()
            });
            showMessage(`Comando agregado con √©xito.`, 'success');
        }
        document.getElementById('addFunctionForm').reset();
        document.getElementById('validationMessage').innerHTML = ''; 
        isSyntaxValid = false; 
    } catch (e) {
        console.error("Error al agregar/actualizar documento: ", e);
        showMessage("Error al guardar el comando. Verifica la consola de Firebase.", 'error');
    } finally {
        button.textContent = originalButtonText;
        button.disabled = false;
    }
};

const editFunction = (func) => {
    editingId = func.id;
    document.getElementById('funcName').value = func.name;
    document.getElementById('funcDescription').value = func.description;
    document.getElementById('funcSyntax').value = func.syntax;
    document.getElementById('addFunctionButton').textContent = 'Actualizar Comando';
    document.getElementById('addFunctionSection').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('validationMessage').innerHTML = '<p class="mt-2 text-center text-blue-800 bg-blue-200 p-3 rounded-lg">Modo Edici√≥n: La validaci√≥n previa se omite al guardar.</p>';
    isSyntaxValid = true;
};

const deleteFunction = async (id) => {
    if (!loggedInUser) {
        showMessage('Debes iniciar sesi√≥n para realizar esta acci√≥n.', 'error');
        return;
    }
    
    showConfirmModal('¬øEst√°s seguro de que quieres eliminar este comando? Esta acci√≥n no se puede deshacer.', async () => {
        try {
            const docRef = doc(db, FUNCTIONS_PATH, id);
            
            const funcSnap = await getDoc(docRef);
            if (funcSnap.exists()) {
                await deleteDoc(docRef);
                // CREACI√ìN DE LOG
                await addDoc(collection(db, LOGS_PATH), {
                    action: "deleted",
                    user: loggedInUser.username,
                    functionName: funcSnap.data().name,
                    timestamp: new Date()
                });

                showMessage('Comando eliminado \ncon √©xito.', 'success');
            }
        } catch (e) {
            console.error("Error al eliminar documento: ", e);
            showMessage("Error al eliminar el comando.", 'error');
        }
    });
};

const createAdmin = async (event) => {
    event.preventDefault();
    const newAdminEmail = document.getElementById('newAdminEmail').value.trim();
    const newAdminPassword = document.getElementById('newAdminPassword').value;
    const newAdminUsername = document.getElementById('newAdminUsername').value.trim();
    const secretKey = document.getElementById('secretKey').value;
    const adminMessage = document.getElementById('adminMessage');
    adminMessage.textContent = '';
    adminMessage.className = 'mt-4 text-center text-sm';
    
    const isPromotingExistingUser = secretKey === SUPER_ADMIN_KEY;
    if (!newAdminEmail || !newAdminPassword || !newAdminUsername) {
        adminMessage.textContent = 'Todos los campos son obligatorios.';
        adminMessage.classList.add('text-rose-500');
        return;
    }
    
    let uid = null;
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
        uid = userCredential.user.uid;
    } catch (e) {
        if (e.code === 'auth/email-already-in-use') {
            if (isPromotingExistingUser) {
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                    uid = userCredential.user.uid;
                    await signOut(auth);
                    adminMessage.textContent = 'Advertencia: El email ya exist√≠a.\nSe asignar√°n permisos de administrador.';
                    adminMessage.classList.add('text-yellow-500');
                } catch (signInError) {
                    let displayError = 'Error: El email ya est√° registrado, pero la contrase√±a no coincide.\nNo se puede obtener el UID para asignar permisos.';
                    adminMessage.textContent = displayError;
                    adminMessage.classList.add('text-rose-500');
                    return;
                }
            } else {
                adminMessage.textContent = 'Error: El email ya est√° registrado.\nPara promocionar a un usuario existente, ingrese la clave secreta.';
                adminMessage.classList.add('text-rose-500');
                return;
            }
        } else if (e.code === 'auth/weak-password') {
            adminMessage.textContent = 'Error: La contrase√±a debe tener al menos 6 caracteres.';
            adminMessage.classList.add('text-rose-500');
            return;
        } else {
            console.error("Error al crear usuario Auth:", e);
            adminMessage.textContent = `Error (${e.code || 'unknown-error'}): No se pudo crear la cuenta de usuario.`;
            adminMessage.classList.add('text-rose-500');
            return;
        }
    }
    
    if (!uid) { return; } 

    try {
        await setDoc(doc(db, ADMINS_PATH, uid), {
            uid: uid,
            username: newAdminUsername,
            email: newAdminEmail,
            isAdmin: true, 
            lastLogin: null
        }, { merge: true });
        if (!adminMessage.classList.contains('text-yellow-500')) {
            adminMessage.textContent = `Administrador ${newAdminUsername} creado con √©xito.\nAhora puede iniciar sesi√≥n con su email y contrase√±a.`;
            adminMessage.classList.add('text-emerald-500');
        }
        document.getElementById('createAdminForm').reset();
    } catch (e) {
        console.error("Error al registrar administrador en Firestore:", e);
        adminMessage.textContent = 'Error: Se cre√≥ la cuenta de Auth, pero fall√≥ el registro de permisos en Firestore.';
        adminMessage.classList.add('text-rose-500');
    }
};

// ************************************************************
// ********* FUNCI√ìN PARA CORREGIR SINTAXIS (FIX) ************
// ************************************************************
const fixSyntaxWithAI = async () => {
    const syntax = document.getElementById('errorInput').value.trim();
    const correctionKey = document.getElementById('correctionKey').value.trim();
    const resultDiv = document.getElementById('correctionResult');
    const button = document.getElementById('fixButton');

    if (!syntax) {
        resultDiv.innerHTML = `<p class="mt-4 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Por favor, ingresa el c√≥digo SQL a corregir.</p>`;
        return;
    }

    if (correctionKey !== SUPER_ADMIN_KEY) {
        resultDiv.innerHTML = `<p class="mt-4 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Clave de Promoci√≥n incorrecta.\nDebes ser administrador para usar esta funci√≥n.</p>`;
        return;
    }

    button.textContent = 'Corrigiendo...';
    button.disabled = true;
    resultDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-blue-200 text-blue-800">Analizando y corrigiendo sintaxis con IA...</p>`;

    const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    const prompt = `Eres un experto en optimizaci√≥n y correcci√≥n de c√≥digo SQL.
Corrige cualquier error de sintaxis en el siguiente c√≥digo y, si es posible, ofr√©ceme una versi√≥n optimizada.
Devuelve S√ìLO el c√≥digo SQL final corregido y optimizado. No uses comentarios ni ninguna explicaci√≥n. C√≥digo SQL: ${syntax}`;
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: "Corrige y optimiza el c√≥digo SQL, devolviendo exclusivamente la consulta SQL resultante." }] },
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text ||
            'No se pudo generar una correcci√≥n.';

        const correctedCode = text.replace(/```sql|```/g, '').trim();
        resultDiv.innerHTML = `
            <h3 class="text-xl font-bold mt-4 mb-2 text-gray-100">C√≥digo Corregido/Optimizado:</h3>
            <div class="bg-emerald-100 p-4 rounded-lg border border-emerald-400 overflow-x-auto">
                <pre class="whitespace-pre-wrap font-mono text-emerald-800"><code>${correctedCode}</code></pre>
            </div>
        `;
    } catch (error) {
        console.error("Error al corregir con IA:", error);
        resultDiv.innerHTML = `<p class="mt-4 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Error al conectar con la IA para la correcci√≥n.</p>`;
    } finally {
        button.textContent = 'Corregir Sintaxis ‚ú®';
        button.disabled = false;
    }
};
// ************************************************************

// ************************************************************
// ********* FUNCI√ìN PARA CONSULTA GENERAL DE PROGRAMACI√ìN *****
// ************************************************************
const generateGeneralQuery = async () => {
    const description = document.getElementById('generalQueryInput').value.trim();
    const button = document.getElementById('generalQueryButton');
    const resultsDiv = document.getElementById('generalQueryResults');
    
    if (!description) {
        resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-rose-200 text-rose-800">Por favor, ingresa tu consulta general.</p>`;
        return;
    }

    button.textContent = 'Generando Respuesta...';
    button.disabled = true;
    resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-blue-200 text-blue-800">Buscando respuesta conceptual con IA...</p>`;

    const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // <-- CLAVE A√öN EXPUESTA
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const prompt = `Eres un asistente experto en programaci√≥n y conceptos de software. Responde a la siguiente consulta de manera concisa y educativa.
    Consulta: "${description}".`;

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: "Responde de manera profesional sobre conceptos de programaci√≥n, SQL, bases de datos o tecnolog√≠a en general. Usa Markdown para el formato." }] },
    };
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo generar una respuesta. Intenta de nuevo.';
        
        // Formatear la respuesta de la IA (Usando marked.parse)
        resultsDiv.innerHTML = `
            <h3 class="text-xl font-bold mt-4 mb-2 text-gray-100">Respuesta Conceptual:</h3>
            <div class="bg-gray-800 p-4 rounded-lg border border-sky-400 overflow-x-auto prose prose-invert text-gray-100">
                ${marked.parse(text)}
            </div>
        `;
        
    } catch (error) {
        console.error("Error al generar consulta general:", error);
        resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-rose-200 text-rose-800">Error al conectar con la IA para la consulta general.</p>`;
    } finally {
        button.textContent = 'Obtener Respuesta Conceptual üí°';
        button.disabled = false;
    }
};
// ************************************************************

const searchFunctions = (event) => {
            const searchTerm = event.target.value.toLowerCase();
const filteredFunctions = functionsList.filter(func => 
                func.name.toLowerCase().includes(searchTerm) || 
                func.description.toLowerCase().includes(searchTerm) || 
                func.syntax.toLowerCase().includes(searchTerm)
            );
displayFunctions(filteredFunctions);
        };

        // ************************************************************
        // ********* FUNCIONES PARA EL MODAL DE ADMINISTRACI√ìN *********
        // ************************************************************
        const showAdminLogin = () => {
            document.getElementById('adminLoginModal').classList.remove('hidden');
document.getElementById('adminLoginModal').classList.add('flex');
            document.getElementById('adminLoginContainer').classList.remove('hidden');
            document.getElementById('createAdminContainer').classList.add('hidden');
        };

        const showAdminManagement = () => {
             document.getElementById('adminLoginModal').classList.remove('hidden');
document.getElementById('adminLoginModal').classList.add('flex');
             document.getElementById('adminLoginContainer').classList.add('hidden');
             document.getElementById('createAdminContainer').classList.remove('hidden');
        };

        const closeAdminModal = () => {
            document.getElementById('adminLoginModal').classList.add('hidden');
document.getElementById('adminLoginModal').classList.remove('flex');
        };


        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initFirebase();
            
            // Inicializar el modo contextual al cargar
            dbSchema = localStorage.getItem('dbSchema') || null;
            isContextualMode = localStorage.getItem('isContextualMode') === 'true' && dbSchema !== null;
            toggleContextualView();

            // ************************************************************
            // ********* EVENT LISTENERS CORREGIDOS *************************
            // ************************************************************
            document.getElementById('showLoginButton').addEventListener('click', showAdminLogin);
   
             // ESTE ES EL LISTENER QUE ESTABA FALLANDO POR REFERENCEERROR
             document.getElementById('logoutButton').addEventListener('click', logout); 
            document.getElementById('showAdminManagementButton').addEventListener('click', showAdminManagement);
            document.getElementById('closeAdminModalButton').addEventListener('click', closeAdminModal);
            
            // Listeners para el cambio de tema
            document.getElementById('theme-default').addEventListener('click', () => setTheme('default'));
            document.getElementById('theme-hacker').addEventListener('click', () => setTheme('hacker'));
            document.getElementById('theme-light').addEventListener('click', () => setTheme('light'));
            document.getElementById('theme-alert').addEventListener('click', () => setTheme('alert'));
            
            // Listeners para el Modo Contextual
            document.getElementById('activateContextualModeBtn').addEventListener('click', () => {
                if (isContextualMode) {
                    clearDBSchema();
                } else {
                    showDBSchemaModal();
                }
            });
            document.getElementById('dbSchemaForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const schema = document.getElementById('dbSchemaInput').value.trim();
                if (schema) {
                    updateDBSchema(schema, true);
                    hideDBSchemaModal();
                } else {
                    showMessage('El esquema no puede estar vac√≠o.', 'error');
                }
            });
            document.getElementById('cancelSchemaBtn').addEventListener('click', hideDBSchemaModal);
            document.getElementById('contextualQueryButton').addEventListener('click', generateContextualQuery);


            // Listeners de formularios y botones que fallaban
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('addFunctionForm').addEventListener('submit', addOrUpdateFunction);
            document.getElementById('validateSyntaxButton').addEventListener('click', validateFunctionWithAI);
            document.getElementById('descriptionSearchButton').addEventListener('click', generateSQLQuery);
            document.getElementById('fixButton').addEventListener('click', fixSyntaxWithAI);

            // Listener de Consulta General
            document.getElementById('generalQueryButton').addEventListener('click', generateGeneralQuery); 

            document.getElementById('createAdminForm').addEventListener('submit', createAdmin);
            document.getElementById('functionSearchInput').addEventListener('input', searchFunctions);
            document.getElementById('confirmBtn').addEventListener('click', () => handleConfirm(true));
            document.getElementById('cancelBtn').addEventListener('click', () => handleConfirm(false));
const resetValidation = () => {
                isSyntaxValid = false;
document.getElementById('validationMessage').innerHTML = '';
                document.getElementById('statusMessage').innerHTML = '';
            };
            document.getElementById('funcName').addEventListener('input', resetValidation);
            document.getElementById('funcDescription').addEventListener('input', resetValidation);
            document.getElementById('funcSyntax').addEventListener('input', resetValidation);

            // Inicializar colores din√°micos despu√©s de cargar listeners
            updateDynamicElements();
        });
</script>
</head>
<body class="bg-gray-900 font-sans leading-normal tracking-normal text-gray-100">

    <header class="bg-blue-700 shadow-xl sticky top-0 z-10 theme-accent-bg">
        <div class="container mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-white">C√≥digo Grabado</h1>
            
            <div class="flex items-center space-x-4">
                
                <div class="dropdown inline-block relative">
                    <button class="dropdown-button-accent text-white font-semibold py-2 px-4 rounded inline-flex items-center hover:theme-accent-hover transition duration-200">
                        <span class="mr-1">Temas</span>
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </button>
                    <ul class="dropdown-menu absolute hidden text-gray-100 pt-1 left-0 z-20 w-48 shadow-xl border border-gray-600 bg-gray-800 rounded-lg overflow-hidden transition-colors duration-300">
                        <li><a id="theme-default" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">Principal (Azul)</a></li>
                        <li><a id="theme-hacker" class="bg-green-700 hover:bg-green-800 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">Hacker (Verde)</a></li>
                        <li><a id="theme-light" class="bg-white hover:bg-gray-200 text-gray-800 py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">Cl√°sico (Blanco)</a></li>
                        <li><a id="theme-alert" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">Alerta (Rojo)</a></li>
                    </ul>
                </div>

                <div class="dropdown inline-block relative">
                    <button class="dropdown-button-accent text-white font-semibold py-2 px-4 rounded inline-flex items-center hover:theme-accent-hover transition duration-200">
                        <span class="mr-1">Admin</span>
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 
20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
 
                    </button>
                    <ul class="dropdown-menu absolute hidden text-gray-100 pt-1 right-0 z-20 w-64 shadow-xl border border-gray-600 bg-gray-800 rounded-lg overflow-hidden transition-colors duration-300">
                        
          
          
      <li id="adminDropdownLogin">
                            <a id="showLoginButton" class="btn-primary-bg text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">
                                Iniciar Sesi√≥n
             
          </a>
                        </li>
                        
                        <li id="adminDropdownContextual" class="">
                            <a id="activateContextualModeBtn" class="bg-sky-600 hover:bg-sky-700 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm font-medium transition-colors duration-300">
                                <span id="modeToggleText">Activar Modo Contextual (Estructura DB)</span>
                            </a>
                        </li>

                        <li id="adminDropdownManagement" class="hidden">
                            <a id="showAdminManagementButton" class="bg-gray-700 hover:bg-gray-600 text-gray-100 py-2 
px-4 block whitespace-no-wrap cursor-pointer text-sm font-medium transition-colors duration-300">
  
                                Crear Admin
                            </a>
                        </li>
      
            
                        <li id="adminDropdownLogout" class="hidden">
                            <a id="logoutButton" class="bg-rose-500 hover:bg-rose-600 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">
                         
     
    Cerrar Sesi√≥n
                            </a>
                        </li>

                        <li class="p-2 border-t border-gray-600 text-xs text-gray-400">
          
     
                          <p id="userIdDisplay">Tu ID de usuario: ...</p>
                        </li>
                    </ul>
                </div>
     
        </div>
        </div>
 
    </header>


    <div class="container mx-auto p-4 md:p-8">
        
        <div id="welcomeMessage" class="text-center mt-4 mb-8 text-xl text-blue-300 font-semibold hidden transition-colors duration-300 theme-accent-text"></div>

        <div id="adminLoginModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-600 max-w-md w-full relative text-gray-100">
     
            <button id="closeAdminModalButton" 
class="absolute top-3 right-3 text-gray-400 hover:text-white">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>

                <div id="adminLoginContainer">
              
              <h2 class="text-2xl font-bold mb-4 text-gray-100 
text-center">Inicio de Sesi√≥n (Admin)</h2>
                    <p class="text-sm text-gray-400 text-center mb-4">Ingresa con tu email y contrase√±a de administrador.</p>
                    <form id="loginForm">
                        <div class="mb-4">
         
          
                      <label for="loginEmail" class="block text-sm font-medium text-gray-300 mb-1">Email:</label>
                            <input type="email" id="loginEmail" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required>
                        </div>
 
                    
     <div class="mb-4">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-300 mb-1">Contrase√±a:</label>
                            <input type="password" id="loginPassword" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required>
   
                   
    </div>
                        <button type="submit" class="w-full btn-primary-bg text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                            Ingresar
           
              </button>
      
                    </form>
                    <p id="loginMessage" class="mt-4 text-center text-sm"></p>
                </div>

                <div id="createAdminContainer" class="hidden">
   
                  <h2 class="text-2xl font-bold mb-4 text-gray-100 text-center">Crear Nuevo 
Usuario Administrador</h2>
                    <p class="text-sm text-gray-400 mb-4">Crea una nueva cuenta de Auth y asigna permisos de administrador en Firestore.</p>
                    <form id="createAdminForm">
                   
      <div class="mb-4">
                 
                       <label for="newAdminEmail" class="block text-sm font-medium text-gray-300 mb-1">Email del Administrador:</label>
                            <input type="email" id="newAdminEmail" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required>
        
                 </div>
                 
                <div class="mb-4">
                            <label for="newAdminPassword" class="block text-sm font-medium text-gray-300 mb-1">Contrase√±a (M√≠nimo 6 caracteres):</label>
             
                <input type="password" id="newAdminPassword" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required>
               
                      </div>
                        <div class="mb-4">
             
                <label for="newAdminUsername" class="block text-sm font-medium text-gray-300 mb-1">Nombre de Usuario (Para logs):</label>
                           
                          <input type="text" id="newAdminUsername" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required>
            
             </div>
                        <div class="mb-4">
                            <label for="secretKey" class="block text-sm font-medium text-gray-300 mb-1">Clave de Promoci√≥n (Opcional, 
para usuarios existentes):</label>
                       
      <input type="password" id="secretKey" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100">
                        </div>
                        <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 
focus:ring-sky-500 focus:ring-offset-2 transition duration-200">
                       
      Crear y Promover Administrador
                        </button>
                        <p id="adminMessage" class="mt-4 text-center text-sm"></p>
              
                   </form>
       
          </div>
            </div>
        </div>
        
        <div id="dbSchemaModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-600 max-w-lg w-full relative text-gray-100">
                <h3 class="text-2xl font-bold mb-4 text-gray-100 text-center">Ingresar Estructura de la Base de Datos (DB)</h3>
                <p class="text-sm text-gray-400 mb-4">Pega aqu√≠ el c√≥digo DDL (CREATE TABLE) o la estructura de las tablas de tu base de datos para obtener asistencia contextualizada. Esto solo se guarda en tu navegador.</p>
                <form id="dbSchemaForm">
                    <textarea id="dbSchemaInput" rows="10" class="w-full p-3 border border-gray-600 bg-gray-700 rounded-md text-gray-100 font-mono" placeholder="Ej: CREATE TABLE Productos (id INT, nombre VARCHAR(100), precio DECIMAL(10,2));"></textarea>
                    <div class="mt-4 flex justify-end space-x-3">
                        <button type="button" id="cancelSchemaBtn" class="bg-gray-600 hover:bg-gray-500 text-gray-100 font-bold py-2 px-4 rounded-lg transition duration-200">
                            Cancelar
                        </button>
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Guardar Esquema y Activar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <section class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 lg:col-span-1 h-fit text-gray-100">

                    <div id="defaultQuerySection" class="relative">
                        <h2 class="text-2xl font-bold mb-4 text-gray-100">Generar C√≥digo SQL</h2>
                        <div class="mb-4">
                            <label for="descriptionSearch" class="block text-sm font-medium text-gray-300 mb-1">Describe tu necesidad:</label>
                            <textarea id="descriptionSearch" rows="3" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100" placeholder="Ej: Obtener el promedio de ventas de productos por categor√≠a en el √∫ltimo mes."></textarea>
                        </div>
                        <button id="descriptionSearchButton" class="w-full btn-primary-bg text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                            Generar Consulta SQL ‚ú®
                        </button>
                        <div id="recommendationResults" class="mt-4"></div>
                        <h3 class="text-xl font-bold mt-8 mb-2 text-gray-100">Comandos R√°pidos (Clic para usar)</h3> 
                        <ul id="searchFunctionsList" class="p-2 rounded-lg max-h-48 overflow-y-auto border border-gray-600 bg-gray-700">
                            <p class="text-center text-gray-400 text-sm py-2">Cargando sugerencias...</p>
                        </ul>
                    </div>

                    <div id="contextualQuerySection" class="hidden relative">
                        <h2 class="text-2xl font-bold mb-4 text-sky-400">Asistencia Contextual (DB)</h2>
                        <p class="text-sm text-gray-400 mb-4 border-b border-gray-600 pb-2">Asistencia con el Esquema: <span id="contextualSchemaText" class="text-sky-300 font-semibold">Inactivo.</span></p>
                        
                        <div class="mb-4">
                            <label for="contextualQueryInput" class="block text-sm font-medium text-gray-300 mb-1">Pregunta sobre tu DB:</label>
                            <textarea id="contextualQueryInput" rows="3" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md focus:ring-blue-500 focus:border-blue-500 text-gray-100" placeholder="Ej: Mu√©strame el nombre del producto m√°s caro que se vendi√≥ en el √∫ltimo mes."></textarea>
                        </div>
                        <button id="contextualQueryButton" class="w-full btn-primary-bg text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                            Generar Consulta Contextual üí°
                        </button>
                        <div id="contextualQueryResults" class="mt-4"></div>
                        
                    </div>

                </section>
                <section class="lg:col-span-2">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 mb-8 text-gray-100">
                        <h2 class="text-2xl font-bold mb-4 text-gray-100">Listado de Comandos SQL</h2> 
                  
       
                       <div class="mb-4">
                            <label for="functionSearchInput" class="block text-sm font-medium text-gray-300 mb-1">Buscar comandos:</label>
                            <input type="text" id="functionSearchInput" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md focus:ring-sky-500 focus:border-sky-500 text-gray-100" placeholder="Ej: SELECT, ADD, AVG, cadena">
     
        
                      </div>
                        <div id="functionsList">
                            <p class="text-center text-gray-400">Cargando comandos...</p>
               
          </div>
       
                      </div>
                </section>
            </main>
            
            <section id="generalQuerySection" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 mb-8 text-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-100">Consulta General de Programaci√≥n</h2> 
                <p class="text-sm text-gray-400 mb-4">Usa esta secci√≥n para preguntas conceptuales sobre programaci√≥n, SQL o bases de datos (Ej: "¬øQu√© es un √≠ndice en SQL?" o "¬øC√≥mo funciona un ORM?").</p>
                <div class="mb-4">
                    <label for="generalQueryInput" class="block text-sm font-medium text-gray-300 mb-1">Ingresa tu consulta:</label> 
                    <textarea id="generalQueryInput" rows="3" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" placeholder="Ej: ¬øCu√°l es la diferencia entre UNION y UNION ALL?"></textarea>
                </div>
                <button id="generalQueryButton" type="button" class="w-full btn-primary-bg text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                    Obtener Respuesta Conceptual üí°
                </button>
                <div id="generalQueryResults" class="mt-4"></div>
            </section>
            <section id="notificationsSection" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 mb-8 hidden 
text-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-100">Notificaciones del 
Administrador</h2>
                <div id="notificationsList" class="max-h-64 overflow-y-auto p-3 rounded-lg border border-blue-700 bg-gray-700">
                    <p class="text-center text-gray-400 text-sm py-2">Esta funcionalidad est√° deshabilitada en la interfaz.\nLa actividad se registra en Firestore Logs.</p>
                </div>
  
           </section>
            
            <section id="fixErrorSection" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 mb-8 hidden text-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-100">Corregir y Optimizar SQL con IA</h2>
   
              <div class="mb-4">
             
               <label for="errorInput" class="block text-sm font-medium text-gray-300 mb-1">Ingresa el c√≥digo SQL con errores o para optimizar:</label>
                    <textarea id="errorInput" rows="4" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md font-mono focus:ring-sky-500 focus:border-sky-500 text-gray-100" placeholder="Ej: SELECT nombre FROM usuarios WHERE edad > 25"></textarea>
         
              </div>
               
  <div class="mb-4">
                    <label for="correctionKey" class="block text-sm font-medium text-gray-300 mb-1">Clave de Promoci√≥n (DT10VazC;#9i):</label>
                    <input type="password" id="correctionKey" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md focus:ring-sky-500 focus:border-sky-500 text-gray-100">
              
               </div>
         
               <button id="fixButton" type="button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 transition duration-200">
                        Corregir Sintaxis ‚ú®
                    </button>
                    
 <div id="correctionResult"></div>
         
        </section>

            <section id="addFunctionSection" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-600 mt-8 hidden text-gray-100">
                <h2 class="text-2xl font-bold mb-4 text-gray-100">Agregar Nuevo Comando/Concepto</h2> 
                <form id="addFunctionForm">
                 
              
                   <div class="mb-4">
                        <label for="funcName" class="block text-sm font-medium text-gray-300 mb-1">Nombre del Comando/Concepto (Ej: SELECT, UPDATE, AVG, DDL):</label> 
                        <input type="text" id="funcName" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required>
                    </div>
  
 
                      <div class="mb-4">
                        <label for="funcDescription" class="block text-sm font-medium text-gray-300 mb-1">Descripci√≥n breve:</label>
                        <textarea id="funcDescription" rows="3" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-md text-gray-100" required></textarea>
            
   
               </div>
                    <div class="mb-4">
                        <label for="funcSyntax" class="block text-sm font-medium text-gray-300 mb-1">Sintaxis (Ej.\nSELECT * FROM tabla;):</label>
                        <textarea id="funcSyntax" rows="3" class="w-full 
p-2 border border-gray-600 bg-gray-700 rounded-md font-mono text-gray-100" required></textarea>
                    </div>
                    
                    <button 
id="validateSyntaxButton" type="button" class="w-full btn-primary-bg text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition duration-200 mb-3">
                
          Pre-validar Sintaxis con IA ‚ú®
                    </button>
                    <div id="validationMessage" class="mt-4 text-center"></div>
             
                       <button id="addFunctionButton" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 
px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-200">
                        Guardar Comando
                    </button>
                </form>
                
 <div id="statusMessage" class="mt-4 text-center"></div>
            
 </section>
            
            </div>
    </div>

        <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100 text-gray-100">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Confirmaci√≥n Requerida</h3>
            <p id="confirmModalMessage" class="text-gray-300 mb-6">¬øEst√°s seguro de que 
quieres realizar esta acci√≥n?</p>
      
               <div class="flex justify-end space-x-3">
                <button id="cancelBtn" class="bg-gray-600 hover:bg-gray-500 text-gray-100 font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
           
               <button id="confirmBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition 
duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
