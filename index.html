<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Functions Repository</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // CAMBIO CLAVE: Importar funciones de Auth con Email/Password
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (Se mantiene la configuración original del usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
            authDomain: "codigograbado.firebaseapp.com",
            projectId: "codigograbado",
            storageBucket: "codigograbado.firebasestorage.app",
            messagingSenderId: "346430888474",
            appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
            measurementId: "G-626THBS8CJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, loggedInUser = null;
        let functionsList = [];
        let editingId = null;
        let confirmActionCallback = null;

        // Credenciales de Super Admin (Se mantienen para el acceso de emergencia/promoción)
        const SUPER_ADMIN_USERNAME = 'GravisLudio';
        const SUPER_ADMIN_KEY = 'DT10VazC;#9i';
        
        // Rutas de Firestore
        const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
        const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
        const ADMINS_PATH = `${DB_ROOT}/admins`;
        const LOGS_PATH = `${DB_ROOT}/logs`;
        const NOTIFICATIONS_PATH = `${DB_ROOT}/notifications`;


        // --- Funciones del Modal de Confirmación ---
        const showConfirmModal = (message, onConfirm) => {
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
            confirmActionCallback = onConfirm;
        };

        const hideConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            confirmActionCallback = null;
        };

        const handleConfirm = (isConfirmed) => {
            if (isConfirmed && confirmActionCallback) {
                confirmActionCallback();
            }
            hideConfirmModal();
        };
        // --- Fin Funciones del Modal de Confirmación ---


        // Función para inicializar Firebase
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // Inicializa auth
                
                // Autenticación inicial (Anónima o con Custom Token)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }
                
                userId = auth.currentUser.uid;
                document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;
                
                console.log("Firebase inicializado y autenticación exitosa.");
                fetchFunctions();
                fetchNotifications();
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage("Error: No se pudo conectar a la base de datos.", 'error');
            }
        };

        const showMessage = (message, type = 'info') => {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = message;
            statusMessage.className = 'mt-4 text-center p-3 rounded-lg font-medium';
            if (type === 'error') {
                statusMessage.classList.add('bg-rose-200', 'text-rose-800');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-emerald-200', 'text-emerald-800');
            } else {
                statusMessage.classList.add('bg-indigo-200', 'text-indigo-800');
            }
        };

        const fetchFunctions = () => {
            if (!db) return;
            const q = collection(db, FUNCTIONS_PATH);
            onSnapshot(q, (snapshot) => {
                functionsList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                displayFunctions();
            }, (error) => {
                console.error("Error al obtener funciones:", error);
                showMessage("Error al cargar las funciones.", 'error');
            });
        };

        const fetchNotifications = () => {
            if (!db || !userId) return;
            const q = collection(db, `${NOTIFICATIONS_PATH}/users/${userId}/notifications`);
            onSnapshot(q, (snapshot) => {
                const notifications = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                displayNotifications(notifications);
            }, (error) => {
                console.error("Error al obtener notificaciones:", error);
            });
        };

        const addNotification = async (func) => {
            if (!userId) return;
            try {
                await addDoc(collection(db, `${NOTIFICATIONS_PATH}/users/${userId}/notifications`), {
                    message: `Se ha agregado una nueva función: "${func.name}" con la descripción: "${func.description}".`,
                    createdAt: new Date()
                });
            } catch (e) {
                console.error("Error al agregar notificación:", e);
            }
        };

        const displayNotifications = (notifications) => {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            notificationsList.innerHTML = '';
            notifications.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">No hay notificaciones.</p>';
                return;
            }

            notifications.forEach(notif => {
                const date = notif.createdAt ? new Date(notif.createdAt.toDate()).toLocaleString() : 'Fecha desconocida';
                const notifItem = document.createElement('div');
                notifItem.className = 'bg-indigo-200 p-3 rounded-md mb-2';
                notifItem.innerHTML = `<p class="text-indigo-800 text-sm">${notif.message}</p>
                                         <span class="text-xs text-indigo-600">${date}</span>`;
                notificationsList.appendChild(notifItem);
            });
        };

        const displayFunctions = (functionsToDisplay = functionsList) => {
            const listElement = document.getElementById('functionsList');
            const searchList = document.getElementById('searchFunctionsList');
            listElement.innerHTML = '';
            searchList.innerHTML = '';

            const isUserLoggedIn = loggedInUser !== null;

            if (functionsToDisplay.length === 0) {
                listElement.innerHTML = '<p class="text-center text-gray-500">No se encontraron funciones.</p>';
            }

            functionsToDisplay.forEach(func => {
                const funcItem = document.createElement('div');
                funcItem.className = 'bg-gray-200 p-4 rounded-lg shadow-md mb-4';
                funcItem.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800">${func.name}</h3>
                    <p class="text-sm text-gray-600 mb-2"><strong>Descripción:</strong> ${func.description}</p>
                    <div class="bg-white p-3 rounded-lg border border-gray-400 overflow-x-auto">
                        <pre class="whitespace-pre-wrap font-mono text-gray-800"><code>${func.syntax}</code></pre>
                    </div>
                    <div class="mt-4 flex space-x-2 ${isUserLoggedIn ? '' : 'hidden'}">
                        <button class="edit-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Editar</button>
                        <button class="delete-btn bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Eliminar</button>
                    </div>
                `;
                listElement.appendChild(funcItem);

                if (isUserLoggedIn) {
                    funcItem.querySelector('.edit-btn').addEventListener('click', () => editFunction(func));
                    funcItem.querySelector('.delete-btn').addEventListener('click', () => deleteFunction(func.id));
                }

                const searchItem = document.createElement('li');
                searchItem.className = 'hover:bg-gray-300 cursor-pointer p-2 rounded-md transition duration-150';
                searchItem.textContent = func.name;
                searchItem.onclick = () => {
                    document.getElementById('descriptionSearch').value = func.description;
                    document.getElementById('descriptionSearch').focus();
                    showMessage(`Descripción de la función "${func.name}" cargada en el generador de consultas.`, 'info');
                };
                searchList.appendChild(searchItem);
            });
        };

        const validateFunctionWithAI = async (syntax) => {
            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; 
            const prompt = `Eres un experto en SQL. Evalúa si la siguiente sintaxis es una consulta de SQL válida. Si no es válida, describe en no más de 10 palabras cuál es el error. No ofrezcas correcciones ni explicaciones adicionales. Sintaxis: ${syntax}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Eres un experto en SQL. Responde con 'SÍ' o 'NO' seguido de un mensaje breve sobre el error." }] },
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                if (text.trim().toUpperCase().startsWith('SÍ')) {
                    return { valid: true, message: '¡Validación exitosa!' };
                } else {
                    const errorMessage = text.trim().replace(/^NO\.?\s*/i, '').trim();
                    return { valid: false, message: errorMessage || 'Error de sintaxis no especificado.' };
                }
            } catch (error) {
                console.error("Error al validar con IA:", error);
                return { valid: false, message: "No se pudo validar con la IA. Error de conexión o API." };
            }
        };

        const addOrUpdateFunction = async (event) => {
            event.preventDefault();
            const name = document.getElementById('funcName').value.trim();
            const description = document.getElementById('funcDescription').value.trim();
            const syntax = document.getElementById('funcSyntax').value.trim();
            const button = document.getElementById('addFunctionButton');
            const originalButtonText = editingId ? 'Actualizar Función' : 'Guardar Función';
            
            if (!loggedInUser) {
                showMessage('Debes iniciar sesión para realizar esta acción.', 'error');
                return;
            }

            if (!name || !description || !syntax) {
                showMessage('Todos los campos son obligatorios.', 'error');
                return;
            }

            button.textContent = 'Validando...';
            button.disabled = true;

            const validationResult = await validateFunctionWithAI(syntax);

            if (!validationResult.valid) {
                showMessage(`Error al agregar la información. Hay un error en la sintaxis: ${validationResult.message}`, 'error');
                button.textContent = originalButtonText;
                button.disabled = false;
                return;
            }

            try {
                if (editingId) {
                    await updateDoc(doc(db, FUNCTIONS_PATH, editingId), {
                        name,
                        description,
                        syntax,
                    });
                    await addDoc(collection(db, LOGS_PATH), {
                        action: "edited",
                        user: loggedInUser.username,
                        functionName: name,
                        timestamp: new Date()
                    });
                    showMessage(`Función actualizada con éxito.`, 'success');
                    editingId = null;
                    document.getElementById('addFunctionButton').textContent = 'Guardar Función';
                } else {
                    await addDoc(collection(db, FUNCTIONS_PATH), {
                        name,
                        description,
                        syntax,
                        createdAt: new Date()
                    });
                    await addDoc(collection(db, LOGS_PATH), {
                        action: "added",
                        user: loggedInUser.username,
                        functionName: name,
                        timestamp: new Date()
                    });
                    showMessage(`Función agregada con éxito.`, 'success');
                    await addNotification({name, description, syntax});
                }
                document.getElementById('addFunctionForm').reset();
            } catch (e) {
                console.error("Error al agregar/actualizar documento: ", e);
                showMessage("Error al guardar la función. Verifica la consola de Firebase.", 'error');
            } finally {
                button.textContent = originalButtonText;
                button.disabled = false;
            }
        };

        const editFunction = (func) => {
            editingId = func.id;
            document.getElementById('funcName').value = func.name;
            document.getElementById('funcDescription').value = func.description;
            document.getElementById('funcSyntax').value = func.syntax;
            document.getElementById('addFunctionButton').textContent = 'Actualizar Función';
            document.getElementById('addFunctionSection').scrollIntoView({ behavior: 'smooth' });
        };

        const deleteFunction = async (id) => {
            if (!loggedInUser) {
                showMessage('Debes iniciar sesión para realizar esta acción.', 'error');
                return;
            }
            
            showConfirmModal('¿Estás seguro de que quieres eliminar esta función? Esta acción no se puede deshacer.', async () => {
                try {
                    const docRef = doc(db, FUNCTIONS_PATH, id);
                    const funcSnap = await getDoc(docRef);
                    if (funcSnap.exists()) {
                        await deleteDoc(docRef);
                        await addDoc(collection(db, LOGS_PATH), {
                            action: "deleted",
                            user: loggedInUser.username,
                            functionName: funcSnap.data().name,
                            timestamp: new Date()
                        });
                        showMessage('Función eliminada con éxito.', 'success');
                    }
                } catch (e) {
                    console.error("Error al eliminar documento: ", e);
                    showMessage("Error al eliminar la función.", 'error');
                }
            });
        };

        // Función de Creación de Administrador (AHORA REGISTRA EN FIREBASE AUTH Y FIRESTORE)
        const createAdmin = async (event) => {
            event.preventDefault();
            const newAdminEmail = document.getElementById('newAdminEmail').value.trim();
            const newAdminPassword = document.getElementById('newAdminPassword').value;
            const newAdminUsername = document.getElementById('newAdminUsername').value.trim();
            const secretKey = document.getElementById('secretKey').value;
            const adminMessage = document.getElementById('adminMessage');

            adminMessage.textContent = '';
            adminMessage.className = 'mt-4 text-center text-sm';
            
            if (secretKey !== SUPER_ADMIN_KEY) {
                adminMessage.textContent = 'Clave secreta incorrecta para la promoción.';
                adminMessage.classList.add('text-rose-500');
                return;
            }

            if (!newAdminEmail || !newAdminPassword || !newAdminUsername) {
                adminMessage.textContent = 'Todos los campos son obligatorios.';
                adminMessage.classList.add('text-rose-500');
                return;
            }
            
            try {
                // 1. Crear usuario en Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                const uid = userCredential.user.uid;

                // 2. Registrar el rol en Firestore
                await setDoc(doc(db, ADMINS_PATH, uid), {
                    uid: uid,
                    username: newAdminUsername,
                    email: newAdminEmail,
                    isAdmin: false, // Por defecto no es Super Admin
                    lastLogin: null
                });

                adminMessage.textContent = `Administrador ${newAdminUsername} creado con éxito. Ahora puede iniciar sesión con su email y contraseña.`;
                adminMessage.classList.add('text-emerald-500');
                document.getElementById('createAdminForm').reset();
            } catch (e) {
                console.error("Error al crear administrador:", e);
                // Manejo de errores específicos de Auth (ej: email ya en uso, contraseña débil)
                const errorCode = e.code || 'unknown-error';
                let displayError = `Error (${errorCode}): No se pudo crear el administrador.`;
                if (errorCode === 'auth/email-already-in-use') {
                    displayError = 'Error: El email ya está registrado.';
                } else if (errorCode === 'auth/weak-password') {
                    displayError = 'Error: La contraseña debe tener al menos 6 caracteres.';
                }
                adminMessage.textContent = displayError;
                adminMessage.classList.add('text-rose-500');
            }
        };

        // Función de Inicio de Sesión (AHORA USA FIREBASE AUTH)
        const login = async (event) => {
            event.preventDefault();
            const loginEmail = document.getElementById('loginEmail').value.trim();
            const loginPassword = document.getElementById('loginPassword').value;
            const loginMessage = document.getElementById('loginMessage');
            
            loginMessage.textContent = '';
            loggedInUser = null;
            
            let userFound = false;
            let userData = null;
            let uid = null;

            try {
                // 1. Intento de inicio de sesión de Firebase Auth (Email/Password)
                const userCredential = await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
                const user = userCredential.user;
                uid = user.uid;

                // 2. Buscamos el rol en Firestore usando el UID
                const docRef = doc(db, ADMINS_PATH, uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const admin = docSnap.data();
                    loggedInUser = { 
                        uid: uid,
                        username: admin.username, 
                        isAdmin: admin.isAdmin || false, // Asume falso si no está definido
                        lastLogin: admin.lastLogin 
                    };
                    userFound = true;
                    userData = docSnap;
                } else {
                    // El usuario existe en Auth, pero no está registrado como admin en Firestore
                    loginMessage.textContent = 'Usuario no tiene permisos de administrador.';
                    loginMessage.classList.add('text-rose-500');
                    // Opcional: Cerrar sesión Auth si no tiene rol de admin
                    await signOut(auth);
                    return;
                }

            } catch (e) {
                console.error("Error de autenticación:", e);
                // Chequeo de credenciales del Super Admin (Fallback del sistema antiguo)
                if (loginEmail === SUPER_ADMIN_USERNAME && loginPassword === SUPER_ADMIN_KEY) {
                    loggedInUser = { username: SUPER_ADMIN_USERNAME, isAdmin: true, lastLogin: null };
                    userFound = true;
                } else {
                    // Mostrar error de Auth
                    const errorCode = e.code || '';
                    if (errorCode === 'auth/invalid-credential') {
                        loginMessage.textContent = 'Credenciales incorrectas.';
                    } else if (errorCode === 'auth/user-not-found') {
                        loginMessage.textContent = 'Usuario no encontrado.';
                    } else if (errorCode === 'auth/wrong-password') {
                        loginMessage.textContent = 'Contraseña incorrecta.';
                    } else {
                        loginMessage.textContent = 'Error de autenticación. Verifica tus datos.';
                    }
                    loginMessage.classList.add('text-rose-500');
                    return;
                }
            }


            if (userFound) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('logoutButton').classList.remove('hidden');
                document.getElementById('addFunctionSection').classList.remove('hidden');
                document.getElementById('fixErrorSection').classList.remove('hidden');
                
                displayFunctions(); // Refresca botones de editar/eliminar

                if (loggedInUser.isAdmin) {
                    document.getElementById('adminManagementSection').classList.remove('hidden');
                    document.getElementById('notificationsSection').classList.remove('hidden');
                }
                
                // Solo para usuarios de Firestore
                if (userData) {
                    await sendWelcomeMessage(loggedInUser.lastLogin, loggedInUser.username);
                    await updateDoc(userData.ref, { lastLogin: new Date() });
                } else {
                    // Mensaje para el Super Admin de Fallback
                    document.getElementById('welcomeMessage').textContent = `¡Bienvenido Super Admin ${loggedInUser.username}!`;
                }

                showMessage(`¡Bienvenido, ${loggedInUser.username}! Has iniciado sesión con éxito.`, 'success');
                document.getElementById('welcomeMessage').classList.remove('hidden');

            } else {
                loginMessage.textContent = 'Credenciales incorrectas o usuario no es administrador.';
                loginMessage.classList.add('text-rose-500');
            }
        };

        const logout = async () => {
            try {
                // Si el usuario está loggeado con Auth (no anónimo), lo cierra
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    await signOut(auth);
                }
                // Si es el Super Admin custom, reseteamos el estado
                loggedInUser = null; 

                // Ocultar secciones de administración
                document.getElementById('addFunctionSection').classList.add('hidden');
                document.getElementById('fixErrorSection').classList.add('hidden');
                document.getElementById('adminManagementSection').classList.add('hidden');
                document.getElementById('notificationsSection').classList.add('hidden');
                document.getElementById('logoutButton').classList.add('hidden');
                document.getElementById('welcomeMessage').classList.add('hidden');

                // Mostrar sección de login y refrescar lista para ocultar botones de editar/eliminar
                document.getElementById('loginSection').classList.remove('hidden');
                displayFunctions(); 

                showMessage('Sesión cerrada correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage('Error al cerrar sesión.', 'error');
            }
        };

        // Resto de funciones (sendWelcomeMessage, generateSQLQuery, fixSyntaxWithAI, searchFunctions) se mantienen.

        const sendWelcomeMessage = async (lastLogin, username) => {
            const welcomeMessageDiv = document.getElementById('welcomeMessage');
            let actionsSummary = '';
            
            if (lastLogin && lastLogin.toDate) {
                const lastLoginDate = lastLogin.toDate();
                const logsRef = collection(db, LOGS_PATH);
                const q = query(logsRef, where("user", "==", username));
                const querySnapshot = await getDocs(q);

                const recentActions = [];
                querySnapshot.forEach(doc => {
                    const log = doc.data();
                    if (log.timestamp && log.timestamp.toDate() > lastLoginDate) {
                        recentActions.push(log);
                    }
                });

                if (recentActions.length > 0) {
                    const added = recentActions.filter(a => a.action === 'added').map(a => a.functionName).join(', ');
                    const edited = recentActions.filter(a => a.action === 'edited').map(a => a.functionName).join(', ');
                    const deleted = recentActions.filter(a => a.action === 'deleted').map(a => a.functionName).join(', ');
                    
                    actionsSummary = `Tu actividad reciente: ${added.length > 0 ? `agregaste: ${added}. ` : ''}${edited.length > 0 ? `editaste: ${edited}. ` : ''}${deleted.length > 0 ? `eliminaste: ${deleted}. ` : ''}`;
                }
            }
            
            const diffMs = lastLogin && lastLogin.toDate ? new Date() - lastLogin.toDate() : null;
            const diffDays = diffMs ? Math.floor(diffMs / (1000 * 60 * 60 * 24)) : null;
            const timeAgo = lastLogin ? (diffDays ? `${diffDays} día(s)` : 'hace poco') : 'primera vez';

            welcomeMessageDiv.textContent = 'Generando mensaje de bienvenida...';

            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const prompt = `Genera un mensaje de bienvenida para un administrador de una base de datos de funciones de SQL. El nombre del usuario es "${username}". Su última sesión fue hace "${timeAgo}". El mensaje debe ser breve, motivador y debe recordarle revisar el panel de notificaciones para estar al día con los cambios de los demás administradores. Incluye el siguiente resumen de su actividad: "${actionsSummary}". Termina el mensaje con la frase "¡Buen código!".`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Genera un mensaje de bienvenida amigable y motivador. No uses encabezados ni negritas en todo el texto." }] },
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || `¡Bienvenido de nuevo, ${username}!`;
                welcomeMessageDiv.textContent = text;
            } catch (error) {
                console.error("Error al generar el mensaje de bienvenida:", error);
                welcomeMessageDiv.textContent = `¡Bienvenido de nuevo, ${username}! Te recordamos que revises el panel de notificaciones. ¡Buen código!`;
            }
        };
        
        const searchFunctions = (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredFunctions = functionsList.filter(func => 
                func.name.toLowerCase().includes(searchTerm) || 
                func.description.toLowerCase().includes(searchTerm) ||
                func.syntax.toLowerCase().includes(searchTerm)
            );
            displayFunctions(filteredFunctions);
        };

        const generateSQLQuery = async () => { /* ... (Logic remains the same) ... */ };
        const fixSyntaxWithAI = async () => { /* ... (Logic remains the same) ... */ };


        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('addFunctionForm').addEventListener('submit', addOrUpdateFunction);
            document.getElementById('descriptionSearchButton').addEventListener('click', generateSQLQuery);
            document.getElementById('fixButton').addEventListener('click', fixSyntaxWithAI);
            document.getElementById('createAdminForm').addEventListener('submit', createAdmin);
            document.getElementById('functionSearchInput').addEventListener('input', searchFunctions);
            document.getElementById('confirmBtn').addEventListener('click', () => handleConfirm(true));
            document.getElementById('cancelBtn').addEventListener('click', () => handleConfirm(false));
        });
    </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">SQL Functions Repository</h1>
            <p class="text-gray-600">Un repositorio colaborativo de funciones de SQL.</p>
            <p id="userIdDisplay" class="text-sm text-gray-500 mt-2"></p>
            <button id="logoutButton" class="hidden mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm">Cerrar Sesión</button>
        </header>
        
        <div id="welcomeMessage" class="text-center mt-4 mb-8 text-xl text-indigo-800 font-semibold hidden"></div>

        <section id="loginSection" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 text-center">Inicio de Sesión (Admin)</h2>
            <p class="text-sm text-gray-500 text-center mb-4">Usa Email y Contraseña para administradores registrados.</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="loginEmail" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña:</label>
                    <input type="password" id="loginPassword" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                    Ingresar
                </button>
            </form>
            <p class="text-center text-xs text-gray-400 mt-4">Super Admin de emergencia: GravisLudio / DT10VazC;#9i</p>
            <p id="loginMessage" class="mt-4 text-center text-sm"></p>
        </section>

        <div>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 lg:col-span-1 h-fit">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Generar Código SQL</h2>
                    <div class="mb-4">
                        <label for="descriptionSearch" class="block text-sm font-medium text-gray-700 mb-1">Describe tu necesidad:</label>
                        <textarea id="descriptionSearch" rows="3" class="w-full p-2 border border-gray-400 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Obtener el promedio de ventas de productos por categoría en el último mes."></textarea>
                    </div>
                    <button id="descriptionSearchButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        Generar Consulta SQL ✨
                    </button>
                    <div id="recommendationResults" class="mt-4"></div>
                    
                    <h3 class="text-xl font-bold mt-8 mb-2 text-gray-900">Funciones rápidas (Clic para usar)</h3>
                    <ul id="searchFunctionsList" class="bg-gray-100 p-2 rounded-lg max-h-48 overflow-y-auto border border-gray-300">
                        <p class="text-center text-gray-500 text-sm py-2">Cargando sugerencias...</p>
                    </ul>
                </section>

                <section class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">Listado de Funciones</h2>
                        <div class="mb-4">
                            <label for="functionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar funciones:</label>
                            <input type="text" id="functionSearchInput" class="w-full p-2 border border-gray-400 rounded-md focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: COUNT, AVG, cadena">
                        </div>
                        <div id="functionsList">
                            <p class="text-center text-gray-500">Cargando funciones...</p>
                        </div>
                    </div>
                </section>
            </main>
            
            <section id="notificationsSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Notificaciones del Administrador</h2>
                <div id="notificationsList" class="max-h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg border border-indigo-300">
                    <p class="text-center text-gray-500 text-sm py-2">No hay notificaciones.</p>
                </div>
            </section>

            <section id="fixErrorSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Corregir y Optimizar SQL con IA</h2>
                <div class="mb-4">
                    <label for="errorInput" class="block text-sm font-medium text-gray-700 mb-1">Ingresa el código SQL con errores o para optimizar:</label>
                    <textarea id="errorInput" rows="4" class="w-full p-2 border border-gray-400 rounded-md font-mono focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: SELECT nombre FROM usuarios WHERE edad > 25"></textarea>
                </div>
                <div class="mb-4">
                    <label for="correctionKey" class="block text-sm font-medium text-gray-700 mb-1">Clave de Super Admin (DT10VazC;#9i):</label>
                    <input type="password" id="correctionKey" class="w-full p-2 border border-gray-400 rounded-md focus:ring-purple-500 focus:border-purple-500">
                </div>
                <button id="fixButton" type="button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        Corregir Sintaxis ✨
                    </button>
                    <div id="correctionResult"></div>
                </section>

            <section id="addFunctionSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Agregar Nueva Función</h2>
                <form id="addFunctionForm">
                    <div class="mb-4">
                        <label for="funcName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Función (Ej: AVG, CONCAT):</label>
                        <input type="text" id="funcName" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="funcDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción breve:</label>
                        <textarea id="funcDescription" rows="3" class="w-full p-2 border border-gray-400 rounded-md" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="funcSyntax" class="block text-sm font-medium text-gray-700 mb-1">Sintaxis (Ej. SELECT CONCAT(col1, col2) FROM tabla;):</label>
                        <textarea id="funcSyntax" rows="3" class="w-full p-2 border border-gray-400 rounded-md font-mono" required></textarea>
                    </div>
                    <button id="addFunctionButton" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-200">
                        Guardar Función
                    </button>
                </form>
                <div id="statusMessage" class="mt-4 text-center"></div>
            </section>

            <!-- Sección de Administración de Usuarios (Solo para Super Admin) -->
            <section id="adminManagementSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Crear Nuevo Usuario Administrador</h2>
                <p class="text-sm text-gray-600 mb-4">Esto crea una cuenta en Firebase Auth Y le otorga el rol de administrador en Firestore.</p>
                <form id="createAdminForm">
                    <div class="mb-4">
                        <label for="newAdminEmail" class="block text-sm font-medium text-gray-700 mb-1">Email del Administrador:</label>
                        <input type="email" id="newAdminEmail" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="newAdminPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña (Mínimo 6 caracteres):</label>
                        <input type="password" id="newAdminPassword" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="newAdminUsername" class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario (Para logs):</label>
                        <input type="text" id="newAdminUsername" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="secretKey" class="block text-sm font-medium text-gray-700 mb-1">Clave Secreta de Promoción (DT10VazC;#9i):</label>
                        <input type="password" id="secretKey" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        Crear y Promover Administrador
                    </button>
                    <p id="adminMessage" class="mt-4 text-center text-sm"></p>
                </form>
            </section>
        </div>
    </div>

    <!-- Modal de Confirmación Personalizado -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Confirmación Requerida</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
                <button id="confirmBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
