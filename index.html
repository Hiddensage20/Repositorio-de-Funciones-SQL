<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Grabado</title>

    <script>
        (function() {
            try {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                let isDark = localStorage.getItem('darkMode') === 'true';

                if (localStorage.getItem('darkMode') === null) {
                    isDark = prefersDark;
                }

                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } catch (e) {
                console.error("Error applying theme pre-load script:", e);
            }
        })();
    </script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        // Opcional: Puedes agregar otras configuraciones de Tailwind aquí si las necesitas
        theme: {
          extend: {},
        },
        plugins: [],
      }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Estilo para el menú desplegable */
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        /* Estilos base del toggle */
        .theme-toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .theme-toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Estilos adicionales si son necesarios (Mantén los tuyos si los tienes) */
        .code-container {
            background-color: #ffffff; /* bg-white */
            border: 1px solid #d1d5db; /* border-gray-300 */
            transition: all 0.3s;
        }
        .dark .code-container {
            background-color: #374151; /* bg-gray-700 */
            border-color: #4b5563; /* border-gray-600 */
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, getDoc, query, where, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Añadido Timestamp

        // Configuración de Firebase
        const firebaseConfig = {
             apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
             authDomain: "codigograbado.firebaseapp.com",
             projectId: "codigograbado",
             storageBucket: "codigograbado.appspot.com", // Corregido el dominio si es appspot.com
             messagingSenderId: "346430888474",
             appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
             measurementId: "G-626THBS8CJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, loggedInUser = null;
        let functionsList = [];
        let editingId = null;
        let confirmActionCallback = null;
        let isSyntaxValid = false;
        const SUPER_ADMIN_KEY = 'DT10VazC;#9i';

        // Rutas de Firestore
        const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
        const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
        const ADMINS_PATH = `${DB_ROOT}/admins`;
        const LOGS_PATH = `${DB_ROOT}/logs`;
        // const NOTIFICATIONS_PATH = `${DB_ROOT}/notifications`; // Comentado si no se usa

        // --- Funciones de Tema (Actualizadas) ---
        const applyThemeToBody = (isDark) => {
            document.body.classList.toggle('bg-gray-100', !isDark);
            document.body.classList.toggle('bg-gray-800', isDark);
            document.body.classList.toggle('text-gray-800', !isDark);
            document.body.classList.toggle('text-gray-100', isDark);
        };

        const initializeTheme = () => {
            const isDark = document.documentElement.classList.contains('dark');
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) {
                toggle.checked = isDark;
            }
            applyThemeToBody(isDark); // Aplicar estilo inicial al body
        };

        const toggleDarkMode = () => {
            const htmlElement = document.documentElement;
            const isDark = !htmlElement.classList.contains('dark');
            htmlElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            applyThemeToBody(isDark); // Aplicar estilo al body al cambiar
        };

        // --- Funciones del Modal de Confirmación ---
        const showConfirmModal = (message, onConfirm) => {
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
            confirmActionCallback = onConfirm;
        };
        const hideConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            confirmActionCallback = null;
        };
        const handleConfirm = (isConfirmed) => {
            if (isConfirmed && typeof confirmActionCallback === 'function') {
                 try {
                    confirmActionCallback();
                 } catch (e) {
                    console.error("Error executing confirm callback:", e);
                    showMessage("Ocurrió un error al confirmar la acción.", "error");
                 }
            }
            hideConfirmModal();
        };

        // --- Función showMessage (Restaurada y Verificada) ---
        const showMessage = (message, type = 'info', targetId = null) => {
            let targetElement;
            if (targetId) {
                targetElement = document.getElementById(targetId);
            } else {
                 // Intenta usar validationMessage si existe, sino statusMessage, sino recommendationResults
                 targetElement = document.getElementById('validationMessage') || document.getElementById('statusMessage') || document.getElementById('recommendationResults');
            }

             if (!targetElement) {
                console.warn("Target element for showMessage not found:", targetId || "default targets");
                return;
             }

            // Crea el elemento del mensaje
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.className = 'mt-4 text-center p-3 rounded-lg font-medium'; // Clases base

            // Aplica clases de color según el tipo
            if (type === 'error') {
                messageDiv.classList.add('bg-rose-200', 'text-rose-800');
            } else if (type === 'success') {
                messageDiv.classList.add('bg-emerald-200', 'text-emerald-800');
            } else { // 'info' o por defecto
                messageDiv.classList.add('bg-indigo-200', 'text-indigo-800');
            }

             // Limpia el contenido anterior y añade el nuevo mensaje
            targetElement.innerHTML = '';
            targetElement.appendChild(messageDiv);


            // Ocultar mensaje automáticamente (excepto errores persistentes en validationMessage)
            if (targetElement.id !== 'validationMessage' || type !== 'error') {
                 setTimeout(() => {
                     // Verifica si el mensaje sigue siendo el mismo antes de borrarlo
                     if (targetElement.firstChild === messageDiv) {
                        targetElement.innerHTML = '';
                     }
                 }, 5000); // Oculta después de 5 segundos
            }
        };


        // --- Resto de tus funciones (Firebase, Lógica de la App, IA, etc.) ---
        // (El código que sigue es el tuyo original, con mínimas correcciones si fueran necesarias)

        const initFirebase = async () => {
             try {
                 const app = initializeApp(firebaseConfig);
                 db = getFirestore(app);
                 auth = getAuth(app);

                 if (initialAuthToken) {
                     await signInWithCustomToken(auth, initialAuthToken);
                 } else {
                     // Intentar iniciar sesión anónimamente si no hay token
                     await signInAnonymously(auth).catch(anonError => {
                         console.error("Anonymous sign-in failed:", anonError);
                         // Podrías mostrar un error al usuario aquí si el inicio anónimo es crucial
                     });
                 }

                 userId = auth.currentUser ? auth.currentUser.uid : 'anonimo'; // Manejar caso donde no hay usuario
                 const userIdDisplay = document.getElementById('userIdDisplay');
                  if (userIdDisplay) {
                    userIdDisplay.textContent = `Tu ID de usuario: ${userId}`;
                  }


                 console.log("Firebase initialized. User ID:", userId);
                 fetchFunctions(); // Carga las funciones después de inicializar
             } catch (error) {
                 console.error("Error initializing Firebase:", error);
                 showMessage("Error crítico: No se pudo conectar a la base de datos.", 'error');
             }
        };

        const fetchFunctions = () => {
            if (!db) {
                console.error("Firestore DB not initialized for fetchFunctions.");
                return;
            }
             const q = query(collection(db, FUNCTIONS_PATH), orderBy("name")); // Ordenar por nombre
             try {
                onSnapshot(q, (snapshot) => {
                    functionsList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    displayFunctions();
                }, (error) => {
                    console.error("Error fetching functions:", error);
                    showMessage("Error al cargar los comandos.", 'error', 'functionsList'); // Mostrar error en el listado
                });
             } catch (e) {
                 console.error("Error setting up snapshot listener:", e);
                 showMessage("Error de conexión al cargar comandos.", 'error', 'functionsList');
             }
        };

        const displayFunctions = (functionsToDisplay = functionsList) => {
            const listElement = document.getElementById('functionsList');
            const searchList = document.getElementById('searchFunctionsList'); // Para "Comandos Rápidos"

            if (!listElement || !searchList) {
                console.error("Required elements for displayFunctions not found.");
                return;
            }

            listElement.innerHTML = ''; // Limpiar lista principal
            searchList.innerHTML = ''; // Limpiar lista de comandos rápidos

            const isUserLoggedIn = loggedInUser !== null; // Verifica si hay un admin logueado

            if (functionsToDisplay.length === 0) {
                listElement.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No se encontraron comandos.</p>';
                searchList.innerHTML = '<li class="text-center text-gray-500 dark:text-gray-400 text-sm py-2">No hay comandos rápidos.</li>';
            } else {
                functionsToDisplay.forEach(func => {
                    // --- Crear elemento para la lista principal ---
                    const funcItem = document.createElement('div');
                    funcItem.className = 'p-4 rounded-lg shadow-md mb-4 bg-gray-100 dark:bg-gray-600'; // Ajustado bg-gray-100 para modo claro
                    funcItem.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${func.name}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2"><strong>Descripción:</strong> ${func.description || 'Sin descripción'}</p>
                        <div class="code-container p-3 rounded-lg border border-gray-300 dark:border-gray-500 overflow-x-auto">
                            <pre class="whitespace-pre-wrap font-mono text-sm text-gray-800 dark:text-gray-200"><code>${func.syntax || ''}</code></pre>
                        </div>
                        <div class="mt-4 flex space-x-2 ${isUserLoggedIn ? '' : 'hidden'}">
                            <button class="edit-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Editar</button>
                            <button class="delete-btn bg-rose-600 hover:bg-rose-700 text-white font-bold py-1 px-3 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Eliminar</button>
                        </div>
                    `;

                    // Añadir listeners a los botones si el usuario está logueado
                    if (isUserLoggedIn) {
                        const editBtn = funcItem.querySelector('.edit-btn');
                        const deleteBtn = funcItem.querySelector('.delete-btn');
                        if(editBtn) editBtn.addEventListener('click', () => editFunction(func));
                        if(deleteBtn) deleteBtn.addEventListener('click', () => deleteFunction(func.id, func.name)); // Pasar nombre para el log
                    }

                    listElement.appendChild(funcItem);

                    // --- Crear elemento para la lista de "Comandos Rápidos" ---
                    const searchItem = document.createElement('li');
                    searchItem.className = 'hover:bg-gray-300 dark:hover:bg-gray-500 cursor-pointer p-2 rounded-md transition duration-150 text-sm';
                    searchItem.textContent = func.name;
                    searchItem.onclick = () => {
                        const descriptionInput = document.getElementById('descriptionSearch');
                        if (descriptionInput) {
                            descriptionInput.value = func.description || ''; // Usar descripción en el generador
                            descriptionInput.focus();
                            // Mostrar mensaje en el contenedor de resultados del generador
                            showMessage(`"${func.name}" cargado en el generador.`, 'info', 'recommendationResults');
                        }
                    };
                    searchList.appendChild(searchItem);
                });
            }
        };


        const validateFunctionWithAI = async () => {
             const name = document.getElementById('funcName').value.trim();
             const description = document.getElementById('funcDescription').value.trim();
             const syntax = document.getElementById('funcSyntax').value.trim();
             const validationMessageDiv = document.getElementById('validationMessage');
             const validateButton = document.getElementById('validateSyntaxButton');

             if (!validationMessageDiv || !validateButton) return; // Salir si falta algún elemento

             if (!loggedInUser) {
                 showMessage('Debes iniciar sesión para pre-validar la sintaxis.', 'error', 'validationMessage');
                 return;
             }

             if (!name || !description || !syntax) {
                 showMessage('Completa Nombre, Descripción y Sintaxis para validar.', 'error', 'validationMessage');
                 return;
             }

             validateButton.textContent = 'Validando...';
             validateButton.disabled = true;
             validationMessageDiv.innerHTML = `<p class="mt-2 text-center p-3 rounded-lg font-medium bg-indigo-200 text-indigo-800">Analizando sintaxis con IA...</p>`;
             isSyntaxValid = false;

             const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // Asegúrate que esta key es correcta y está activa
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; // Modelo actualizado sugerido

             let prompt = `Eres un experto en SQL. Evalúa si la siguiente sintaxis SQL es válida y coherente con el nombre y descripción dados.
                Nombre: "${name}"
                Descripción: "${description}"
                Sintaxis: "${syntax}"
                Responde EXACTAMENTE con "SI:VALIDA" si es válida, o con "NO:Sugerencia:[sugerencia corta y comando corregido]" si no es válida o incoherente.`;

             const payload = {
                 contents: [{ parts: [{ text: prompt }] }],
                 // systemInstruction opcional para guiar más al modelo
             };

             try {
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error:", response.status, errorBody);
                    throw new Error(`Error ${response.status} de la API de IA.`);
                 }

                 const result = await response.json();
                 // Acceso seguro a la respuesta
                 const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';

                 if (text.startsWith('SI:VALIDA')) {
                     isSyntaxValid = true;
                     showMessage('¡Validación exitosa! La sintaxis parece válida.', 'success', 'validationMessage');
                 } else if (text.startsWith('NO:Sugerencia:')) {
                     const suggestion = text.substring('NO:Sugerencia:'.length).trim();
                     showMessage(`Sintaxis inválida o incoherente. IA sugiere: ${suggestion}`, 'error', 'validationMessage');
                 } else {
                     // Respuesta inesperada de la IA
                     console.warn("Unexpected AI response:", text);
                     showMessage('La IA dio una respuesta inesperada. Revisa la sintaxis manualmente.', 'error', 'validationMessage');
                 }
             } catch (error) {
                 console.error("Error validating with AI:", error);
                 showMessage(`Error al validar: ${error.message}`, 'error', 'validationMessage');
             } finally {
                 validateButton.textContent = 'Pre-validar Sintaxis con IA ✨';
                 validateButton.disabled = false;
             }
        };

        const generateSQLQuery = async () => {
             const description = document.getElementById('descriptionSearch').value.trim();
             const button = document.getElementById('descriptionSearchButton');
             const resultsDiv = document.getElementById('recommendationResults');

             if (!resultsDiv || !button) return;

             if (!description) {
                 showMessage('Describe tu necesidad para generar la consulta.', 'error', 'recommendationResults');
                 return;
             }

             button.textContent = 'Generando...';
             button.disabled = true;
             showMessage('Generando consulta SQL...', 'info', 'recommendationResults'); // Mensaje de carga

             const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // Misma API Key
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

             const prompt = `Genera SOLAMENTE el código SQL (sin explicaciones, comentarios ni markdown como \`\`\`sql) para esta descripción: "${description}"`;

             const payload = {
                 contents: [{ parts: [{ text: prompt }] }],
                 // Configuración para generar solo código podría ir aquí (si la API lo soporta directamente)
             };

             try {
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error:", response.status, errorBody);
                     throw new Error(`Error ${response.status} de la API de IA.`);
                 }

                 const result = await response.json();
                 const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';

                 // Limpiar cualquier markdown residual (aunque el prompt lo pide evitar)
                 const sqlCode = text.replace(/```sql|```/g, '').trim();

                 if (!sqlCode) {
                     throw new Error("La IA no generó ningún código.");
                 }

                 // Mostrar resultado
                 resultsDiv.innerHTML = `
                     <h3 class="text-xl font-bold mt-4 mb-2 text-gray-900 dark:text-gray-100">Consulta Generada:</h3>
                     <div class="code-container p-3 rounded-lg border border-gray-400 dark:border-gray-600 overflow-x-auto">
                         <pre class="whitespace-pre-wrap font-mono text-gray-800 dark:text-gray-200"><code>${sqlCode}</code></pre>
                     </div>
                 `;
             } catch (error) {
                 console.error("Error generating SQL query:", error);
                 showMessage(`Error al generar: ${error.message}`, 'error', 'recommendationResults');
             } finally {
                 button.textContent = 'Generar Consulta SQL ✨';
                 button.disabled = false;
             }
        };

        const addOrUpdateFunction = async (event) => {
             event.preventDefault(); // Prevenir recarga de página
             const name = document.getElementById('funcName').value.trim();
             const description = document.getElementById('funcDescription').value.trim();
             const syntax = document.getElementById('funcSyntax').value.trim();
             const button = document.getElementById('addFunctionButton');
             const validationMessageDiv = document.getElementById('validationMessage');

             if (!button || !validationMessageDiv) return;

             if (!loggedInUser) {
                 showMessage('Debes iniciar sesión para guardar comandos.', 'error', 'validationMessage');
                 return;
             }

             if (!name || !description || !syntax) {
                 showMessage('Todos los campos son obligatorios.', 'error', 'validationMessage');
                 return;
             }

             if (!isSyntaxValid && !editingId) { // Solo requerir validación al añadir, no al editar
                 showMessage('La sintaxis no ha sido validada o falló. Usa "Pre-validar".', 'error', 'validationMessage');
                 return;
             }

             const originalButtonText = editingId ? 'Actualizar Comando' : 'Guardar Comando';
             button.textContent = editingId ? 'Actualizando...' : 'Guardando...';
             button.disabled = true;

             try {
                 const data = { name, description, syntax };
                 let actionLog = "";

                 if (editingId) {
                     // Actualizar
                     await updateDoc(doc(db, FUNCTIONS_PATH, editingId), data);
                     actionLog = "edited";
                     showMessage(`Comando "${name}" actualizado.`, 'success', 'validationMessage');
                     editingId = null; // Salir del modo edición
                     button.textContent = 'Guardar Comando'; // Restaurar texto del botón
                 } else {
                     // Añadir nuevo
                     data.createdAt = Timestamp.now(); // Añadir fecha de creación
                     await addDoc(collection(db, FUNCTIONS_PATH), data);
                     actionLog = "added";
                     showMessage(`Comando "${name}" agregado.`, 'success', 'validationMessage');
                 }

                 // Registrar Log
                 await addDoc(collection(db, LOGS_PATH), {
                     action: actionLog,
                     user: loggedInUser.username,
                     functionName: name,
                     timestamp: Timestamp.now()
                 });

                 document.getElementById('addFunctionForm').reset(); // Limpiar formulario
                 validationMessageDiv.innerHTML = ''; // Limpiar mensaje de validación
                 isSyntaxValid = false; // Resetear estado de validación

             } catch (e) {
                 console.error("Error saving function:", e);
                 showMessage("Error al guardar el comando.", 'error', 'validationMessage');
             } finally {
                 // Asegurarse de restaurar el estado del botón incluso si hay error
                 button.textContent = editingId ? 'Actualizar Comando' : 'Guardar Comando'; // Usar estado actual de editingId
                 button.disabled = false;
                 // Si estábamos editando y hubo error, permanecemos en modo edición
                 if (editingId) {
                     button.textContent = 'Actualizar Comando';
                 }
             }
        };

        const editFunction = (func) => {
             if (!func || !func.id) return;
             editingId = func.id;
             document.getElementById('funcName').value = func.name || '';
             document.getElementById('funcDescription').value = func.description || '';
             document.getElementById('funcSyntax').value = func.syntax || '';
             document.getElementById('addFunctionButton').textContent = 'Actualizar Comando';
             isSyntaxValid = true; // Permitir guardar sin re-validar al editar
             showMessage('Modo Edición: Puedes actualizar el comando.', 'info', 'validationMessage');
             const addSection = document.getElementById('addFunctionSection');
             if(addSection) addSection.scrollIntoView({ behavior: 'smooth' });
        };

        const deleteFunction = async (id, funcName) => { // Añadido funcName para el log
             if (!loggedInUser) {
                 showMessage('Debes iniciar sesión para eliminar.', 'error'); // Mostrar en statusMessage
                 return;
             }
             if (!id) return;

             showConfirmModal(`¿Seguro que quieres eliminar el comando "${funcName || id}"?`, async () => {
                 try {
                     await deleteDoc(doc(db, FUNCTIONS_PATH, id));

                     // Registrar Log
                     await addDoc(collection(db, LOGS_PATH), {
                         action: "deleted",
                         user: loggedInUser.username,
                         functionName: funcName || id, // Usar nombre si está disponible
                         timestamp: Timestamp.now()
                     });

                     showMessage(`Comando "${funcName || id}" eliminado.`, 'success'); // Mostrar en statusMessage
                     // Opcional: limpiar formulario si el comando eliminado se estaba editando
                     if (editingId === id) {
                         document.getElementById('addFunctionForm').reset();
                         editingId = null;
                         document.getElementById('addFunctionButton').textContent = 'Guardar Comando';
                         isSyntaxValid = false;
                         document.getElementById('validationMessage').innerHTML = '';
                     }
                 } catch (e) {
                     console.error("Error deleting function:", e);
                     showMessage("Error al eliminar el comando.", 'error');
                 }
             });
        };

        // --- Funciones de Admin (Login, Logout, Crear Admin) ---
        const createAdmin = async (event) => {
            event.preventDefault();
            const emailInput = document.getElementById('newAdminEmail');
            const passwordInput = document.getElementById('newAdminPassword');
            const usernameInput = document.getElementById('newAdminUsername');
            const secretKeyInput = document.getElementById('secretKey'); // Puede no existir en el modal simplificado
            const adminMessageP = document.getElementById('adminMessage');

            if (!emailInput || !passwordInput || !usernameInput || !adminMessageP) return; // Verificar elementos

            const newAdminEmail = emailInput.value.trim();
            const newAdminPassword = passwordInput.value;
            const newAdminUsername = usernameInput.value.trim();
            const secretKey = secretKeyInput ? secretKeyInput.value : ''; // Manejar si no existe

            adminMessageP.textContent = ''; // Limpiar mensaje previo
            adminMessageP.className = 'mt-4 text-center text-sm'; // Resetear clases

            if (!newAdminEmail || !newAdminPassword || !newAdminUsername) {
                adminMessageP.textContent = 'Email, Contraseña y Nombre de Usuario son obligatorios.';
                adminMessageP.classList.add('text-rose-500');
                return;
            }
            if (newAdminPassword.length < 6) {
                 adminMessageP.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                 adminMessageP.classList.add('text-rose-500');
                 return;
            }

            const isPromoting = secretKey === SUPER_ADMIN_KEY;
            let uid = null;

            try {
                // Intenta crear el usuario
                const userCredential = await createUserWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                uid = userCredential.user.uid;
                adminMessageP.textContent = 'Cuenta de autenticación creada...';
                adminMessageP.classList.add('text-yellow-500');

            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    if (isPromoting) {
                        try {
                            // Intenta iniciar sesión para obtener UID si la clave secreta es correcta
                            const existingUserCredential = await signInWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                            uid = existingUserCredential.user.uid;
                            await signOut(auth); // Desloguear inmediatamente después de obtener UID
                            adminMessageP.textContent = 'Email existente, promoviendo a admin...';
                            adminMessageP.classList.add('text-yellow-500');
                        } catch (signInError) {
                            adminMessageP.textContent = 'Email existente, pero la contraseña no coincide. No se puede promover.';
                            adminMessageP.classList.add('text-rose-500');
                            return; // Detener ejecución
                        }
                    } else {
                        adminMessageP.textContent = 'El email ya está registrado. Usa la clave secreta si quieres promoverlo.';
                        adminMessageP.classList.add('text-rose-500');
                        return; // Detener ejecución
                    }
                } else {
                    console.error("Error creating auth user:", error);
                    adminMessageP.textContent = `Error al crear usuario: ${error.message}`;
                    adminMessageP.classList.add('text-rose-500');
                    return; // Detener ejecución
                }
            }

            // Si llegamos aquí, tenemos un UID (nuevo o existente promovido)
            if (uid) {
                try {
                    // Establecer/Actualizar documento en Firestore
                    await setDoc(doc(db, ADMINS_PATH, uid), {
                        uid: uid,
                        username: newAdminUsername,
                        email: newAdminEmail, // Guardar email para referencia
                        isAdmin: true,
                        lastLogin: null // Se actualizará al primer login real
                    }, { merge: true }); // Usar merge para no sobrescribir lastLogin si ya existía

                    adminMessageP.textContent = `¡Admin ${newAdminUsername} ${isPromoting ? 'promovido' : 'creado'} con éxito!`;
                    adminMessageP.classList.remove('text-yellow-500');
                    adminMessageP.classList.add('text-emerald-500');
                    // Limpiar formulario específico de creación de admin
                    const createAdminForm = document.getElementById('createAdminForm');
                    if (createAdminForm) createAdminForm.reset();


                } catch (firestoreError) {
                    console.error("Error setting admin doc in Firestore:", firestoreError);
                    adminMessageP.textContent = 'Error al guardar permisos de admin en la base de datos.';
                    adminMessageP.classList.add('text-rose-500');
                }
            }
        };

        const logout = async () => {
             try {
                 if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    await signOut(auth);
                 }
                 loggedInUser = null;

                 // Ocultar secciones de admin
                 document.getElementById('addFunctionSection').classList.add('hidden');
                 document.getElementById('fixErrorSection').classList.add('hidden');
                 // Oculta adminManagementSection si no está dentro del modal
                 const adminManagementSection = document.getElementById('adminManagementSection');
                 if (adminManagementSection && !adminManagementSection.closest('#adminLoginModal')) {
                     adminManagementSection.classList.add('hidden');
                 }
                 // Ocultar notificaciones si existe
                 const notificationsSection = document.getElementById('notificationsSection');
                 if(notificationsSection) notificationsSection.classList.add('hidden');


                 // Actualizar UI del menú dropdown
                 document.getElementById('adminDropdownLogin').classList.remove('hidden');
                 document.getElementById('adminDropdownLogout').classList.add('hidden');
                 document.getElementById('adminDropdownManagement').classList.add('hidden');
                 document.getElementById('welcomeMessage').classList.add('hidden');

                 // Re-autenticar anónimamente
                 await signInAnonymously(auth);
                 userId = auth.currentUser.uid;
                 const userIdDisplay = document.getElementById('userIdDisplay');
                  if (userIdDisplay) {
                     userIdDisplay.textContent = `Tu ID de usuario: ${userId}`;
                  }


                 displayFunctions(); // Actualizar vista (sin botones de admin)
                 showMessage('Sesión cerrada.', 'info'); // Usar statusMessage por defecto

             } catch (error) {
                 console.error("Error during logout:", error);
                 showMessage('Error al cerrar sesión.', 'error');
             }
        };

        const login = async (event) => {
             event.preventDefault();
             const emailInput = document.getElementById('loginEmail');
             const passwordInput = document.getElementById('loginPassword');
             const loginMessageP = document.getElementById('loginMessage');

             if(!emailInput || !passwordInput || !loginMessageP) return;

             const loginEmail = emailInput.value.trim();
             const loginPassword = passwordInput.value;

             loginMessageP.textContent = ''; // Limpiar mensaje
             loginMessageP.className = 'mt-4 text-center text-sm'; // Resetear

             if (!loginEmail || !loginPassword) {
                 loginMessageP.textContent = 'Email y Contraseña son requeridos.';
                 loginMessageP.classList.add('text-rose-500');
                 return;
             }

             try {
                 const userCredential = await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
                 const user = userCredential.user;
                 const uid = user.uid;

                 // Verificar si es admin en Firestore
                 const adminDocRef = doc(db, ADMINS_PATH, uid);
                 const adminDocSnap = await getDoc(adminDocRef);

                 if (adminDocSnap.exists() && adminDocSnap.data().isAdmin === true) {
                     loggedInUser = {
                         uid: uid,
                         username: adminDocSnap.data().username || loginEmail.split('@')[0], // Usar username de Firestore si existe
                         email: loginEmail,
                         lastLogin: adminDocSnap.data().lastLogin || null // Obtener último login
                     };

                     closeAdminModal(); // Cerrar modal al loguear

                     // Mostrar secciones de admin
                     document.getElementById('addFunctionSection').classList.remove('hidden');
                     document.getElementById('fixErrorSection').classList.remove('hidden');
                     // Muestra adminManagementSection si no está dentro del modal
                     const adminManagementSection = document.getElementById('adminManagementSection');
                     if (adminManagementSection && !adminManagementSection.closest('#adminLoginModal')) {
                         adminManagementSection.classList.remove('hidden');
                     }
                      // Mostrar notificaciones si existe
                     const notificationsSection = document.getElementById('notificationsSection');
                     if(notificationsSection) notificationsSection.classList.remove('hidden');

                     // Actualizar UI del menú dropdown
                     document.getElementById('adminDropdownLogin').classList.add('hidden');
                     document.getElementById('adminDropdownLogout').classList.remove('hidden');
                     document.getElementById('adminDropdownManagement').classList.remove('hidden');

                     displayFunctions(); // Actualizar vista (con botones de admin)

                     await sendWelcomeMessage(loggedInUser.lastLogin, loggedInUser.username); // Enviar saludo

                     // Actualizar lastLogin en Firestore
                     await setDoc(adminDocRef, { lastLogin: Timestamp.now() }, { merge: true });

                     showMessage(`¡Bienvenido, ${loggedInUser.username}!`, 'success'); // Mensaje general
                     document.getElementById('welcomeMessage').classList.remove('hidden'); // Mostrar saludo personalizado

                 } else {
                     // No es admin o no existe en la colección de admins
                     loggedInUser = null;
                     await signOut(auth); // Desloguear si no es admin
                     await signInAnonymously(auth); // Volver a anónimo
                     loginMessageP.textContent = 'No tienes permisos de administrador.';
                     loginMessageP.classList.add('text-rose-500');
                 }

             } catch (error) {
                 console.error("Login error:", error);
                 if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                     loginMessageP.textContent = 'Credenciales incorrectas.';
                 } else {
                     loginMessageP.textContent = 'Error de autenticación.';
                 }
                 loginMessageP.classList.add('text-rose-500');
                 loggedInUser = null;
                 // Asegurarse de estar como anónimo si el login falla
                 if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                    await signOut(auth).catch(() => {}); // Intentar desloguear si no es anónimo
                    await signInAnonymously(auth).catch(() => {}); // Intentar volver a anónimo
                 }
             }
        };

        const sendWelcomeMessage = async (lastLoginTimestamp, username) => {
             const welcomeMessageDiv = document.getElementById('welcomeMessage');
             if (!welcomeMessageDiv) return;

             let actionsSummary = 'No hay actividad reciente.';
             let timeAgo = 'primera vez';

             if (lastLoginTimestamp && typeof lastLoginTimestamp.toDate === 'function') {
                const lastLoginDate = lastLoginTimestamp.toDate();
                 const diffMs = new Date() - lastLoginDate;
                 const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                 timeAgo = diffDays > 0 ? `${diffDays} día(s)` : 'hoy';

                 // Buscar logs desde el último login
                 try {
                     const logsRef = collection(db, LOGS_PATH);
                     // Importante: Asegúrate de tener un índice compuesto en Firestore para esta consulta
                     // (user ASC, timestamp DESC) o (user ASC, timestamp ASC)
                     const q = query(logsRef, where("user", "==", username), where("timestamp", ">", lastLoginTimestamp), orderBy("timestamp", "desc"));
                     const querySnapshot = await getDocs(q);

                     const recentActions = [];
                     querySnapshot.forEach(doc => recentActions.push(doc.data()));

                     if (recentActions.length > 0) {
                         const added = recentActions.filter(a => a.action === 'added').length;
                         const edited = recentActions.filter(a => a.action === 'edited').length;
                         const deleted = recentActions.filter(a => a.action === 'deleted').length;
                         actionsSummary = `Resumen: ${added} agregados, ${edited} editados, ${deleted} eliminados.`;
                     }
                 } catch (error) {
                     console.error("Error fetching recent logs:", error);
                     actionsSummary = "No se pudo cargar el resumen de actividad.";
                 }
             }

             // Generar mensaje con IA (opcional, puedes usar un mensaje fijo)
             welcomeMessageDiv.textContent = `¡Bienvenido de vuelta, ${username}! Tu última sesión fue hace ${timeAgo}. ${actionsSummary} Recuerda revisar los logs. ¡Buen código!`;
             // Aquí iría la llamada a la IA si prefieres un mensaje generado
        };

        const searchFunctions = (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredFunctions = functionsList.filter(func =>
                (func.name && func.name.toLowerCase().includes(searchTerm)) ||
                (func.description && func.description.toLowerCase().includes(searchTerm)) ||
                (func.syntax && func.syntax.toLowerCase().includes(searchTerm))
            );
            displayFunctions(filteredFunctions);
        };

        // --- Funciones para Abrir/Cerrar Modales ---
        const showAdminLogin = () => {
             const modal = document.getElementById('adminLoginModal');
             const loginContainer = document.getElementById('adminLoginContainer');
             const createContainer = document.getElementById('createAdminContainer');
             if(modal && loginContainer && createContainer) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                loginContainer.classList.remove('hidden');
                createContainer.classList.add('hidden');
             }
        };

        const showAdminManagement = () => {
             const modal = document.getElementById('adminLoginModal');
             const loginContainer = document.getElementById('adminLoginContainer');
             const createContainer = document.getElementById('createAdminContainer');
             if(modal && loginContainer && createContainer) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                loginContainer.classList.add('hidden');
                createContainer.classList.remove('hidden');
             }
        };

        const closeAdminModal = () => {
             const modal = document.getElementById('adminLoginModal');
             if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
             }
             // Limpiar mensajes de error/éxito al cerrar
             const loginMessageP = document.getElementById('loginMessage');
             const adminMessageP = document.getElementById('adminMessage');
             if(loginMessageP) loginMessageP.textContent = '';
             if(adminMessageP) adminMessageP.textContent = '';
        };

        // --- Inicialización al Cargar la Página ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar tema (sincroniza toggle y body basado en <html>)
            initializeTheme();
            // Inicializar Firebase y cargar datos
            initFirebase();

            // --- Asignación de Event Listeners ---
            // Toggle de tema
            document.getElementById('darkModeToggle')?.addEventListener('change', toggleDarkMode);

            // Menú Admin Dropdown
            document.getElementById('showLoginButton')?.addEventListener('click', showAdminLogin);
            document.getElementById('logoutButton')?.addEventListener('click', logout);
            document.getElementById('showAdminManagementButton')?.addEventListener('click', showAdminManagement);

            // Modal Admin
            document.getElementById('closeAdminModalButton')?.addEventListener('click', closeAdminModal);
            document.getElementById('loginForm')?.addEventListener('submit', login);
             // Asignar listener al formulario de creación DENTRO del modal si existe
             const createAdminFormInModal = document.querySelector('#createAdminContainer form');
             createAdminFormInModal?.addEventListener('submit', createAdmin);


            // Formulario Añadir/Editar Comando
            document.getElementById('addFunctionForm')?.addEventListener('submit', addOrUpdateFunction);
            document.getElementById('validateSyntaxButton')?.addEventListener('click', validateFunctionWithAI);

            // Generador SQL
            document.getElementById('descriptionSearchButton')?.addEventListener('click', generateSQLQuery);

             // Corrector SQL (si existe el botón)
             document.getElementById('fixButton')?.addEventListener('click', fixSyntaxWithAI);

            // Búsqueda
            document.getElementById('functionSearchInput')?.addEventListener('input', searchFunctions);

            // Modal de Confirmación
            document.getElementById('confirmBtn')?.addEventListener('click', () => handleConfirm(true));
            document.getElementById('cancelBtn')?.addEventListener('click', () => handleConfirm(false));

            // Resetear validación al cambiar campos del formulario
            const resetValidation = () => {
                isSyntaxValid = false;
                 const validationMsgDiv = document.getElementById('validationMessage');
                 // Solo limpiar si no estamos en modo edición (para no borrar el mensaje "Modo Edición")
                 if (!editingId && validationMsgDiv) {
                     validationMsgDiv.innerHTML = '';
                 }
            };
            document.getElementById('funcName')?.addEventListener('input', resetValidation);
            document.getElementById('funcDescription')?.addEventListener('input', resetValidation);
            document.getElementById('funcSyntax')?.addEventListener('input', resetValidation);

             // Asignar listener al formulario de creación FUERA del modal (si existe)
             const createAdminFormOutside = document.querySelector('#adminManagementSection:not(#adminLoginModal *) form');
             createAdminFormOutside?.addEventListener('submit', createAdmin);

        });

    </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal text-gray-800 transition-colors duration-300">

    <header class="bg-white shadow-md sticky top-0 z-10 dark:bg-gray-700 transition-colors duration-300">
        <div class="container mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-gray-900 dark:text-gray-100">Código Grabado</h1>

            <div class="flex items-center space-x-4">

                <div class="flex items-center space-x-2">
                    <span class="text-gray-600 dark:text-gray-300 text-sm">Claro</span>
                    <label class="theme-toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="text-gray-600 dark:text-gray-300 text-sm">Oscuro</span>
                </div>

                <div class="dropdown inline-block relative">
                    <button class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded inline-flex items-center hover:bg-indigo-700 transition duration-200">
                        <span class="mr-1">Admin</span>
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </button>
                    <ul class="dropdown-menu absolute hidden text-gray-700 pt-1 right-0 z-20 w-64 shadow-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg overflow-hidden transition-colors duration-300">
                        <li id="adminDropdownLogin">
                            <a id="showLoginButton" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">
                                Iniciar Sesión
                            </a>
                        </li>
                        <li id="adminDropdownManagement" class="hidden">
                            <a id="showAdminManagementButton" class="bg-purple-100 hover:bg-purple-200 dark:bg-purple-800 dark:text-gray-100 dark:hover:bg-purple-900 py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm font-medium transition-colors duration-300">
                                Crear Admin
                            </a>
                        </li>
                        <li id="adminDropdownLogout" class="hidden">
                            <a id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">
                                Cerrar Sesión
                            </a>
                        </li>
                        <li class="p-2 border-t dark:border-gray-600 text-xs text-gray-500 dark:text-gray-400">
                            <p id="userIdDisplay">Tu ID de usuario: ...</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>


    <div class="container mx-auto p-4 md:p-8">

        <div id="welcomeMessage" class="text-center mt-4 mb-8 text-xl text-indigo-800 dark:text-gray-100 font-semibold hidden transition-colors duration-300"></div>

        <div id="adminLoginModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 max-w-md w-full relative dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                <button id="closeAdminModalButton" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-100">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>

                <div id="adminLoginContainer">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100 text-center">Inicio de Sesión (Admin)</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">Ingresa con tu email y contraseña.</p>
                    <form id="loginForm">
                        <div class="mb-4">
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email:</label>
                            <input type="email" id="loginEmail" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required>
                        </div>
                        <div class="mb-4">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contraseña:</label>
                            <input type="password" id="loginPassword" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                            Ingresar
                        </button>
                    </form>
                    <p id="loginMessage" class="mt-4 text-center text-sm"></p>
                </div>

                <div id="createAdminContainer" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100 text-center">Crear Nuevo Admin</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 text-center">Crea una cuenta y asigna permisos.</p>
                    <form id="createAdminForm">
                        <div class="mb-4">
                            <label for="newAdminEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email:</label>
                            <input type="email" id="newAdminEmail" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required>
                        </div>
                        <div class="mb-4">
                            <label for="newAdminPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contraseña (Mín. 6):</label>
                            <input type="password" id="newAdminPassword" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required>
                        </div>
                        <div class="mb-4">
                            <label for="newAdminUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre Usuario (Logs):</label>
                            <input type="text" id="newAdminUsername" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required>
                        </div>
                        <div class="mb-4">
                            <label for="secretKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Clave Promoción (Opcional):</label>
                            <input type="password" id="secretKey" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100">
                        </div>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                            Crear y Promover
                        </button>
                    </form>
                     <p id="adminMessage" class="mt-4 text-center text-sm"></p>
                </div>
            </div>
        </div>

        <div>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 lg:col-span-1 h-fit dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Generar Código SQL</h2>
                    <div class="mb-4">
                        <label for="descriptionSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Describe tu necesidad:</label>
                        <textarea id="descriptionSearch" rows="3" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:text-gray-100" placeholder="Ej: Obtener el promedio de ventas..."></textarea>
                    </div>
                    <button id="descriptionSearchButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        Generar Consulta SQL ✨
                    </button>
                    <div id="recommendationResults" class="mt-4">
                        </div>

                    <h3 class="text-xl font-bold mt-8 mb-2 text-gray-900 dark:text-gray-100">Comandos Rápidos</h3>
                    <ul id="searchFunctionsList" class="p-2 rounded-lg max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">
                        <p class="text-center text-gray-500 dark:text-gray-400 text-sm py-2">Cargando...</p>
                    </ul>
                </section>

                <section class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Listado de Comandos SQL</h2>
                        <div class="mb-4">
                            <label for="functionSearchInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buscar comandos:</label>
                            <input type="text" id="functionSearchInput" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-600 dark:text-gray-100" placeholder="Ej: SELECT, UPDATE, JOIN...">
                        </div>
                        <div id="functionsList">
                            <p class="text-center text-gray-500 dark:text-gray-400">Cargando comandos...</p>
                        </div>
                    </div>
                </section>
            </main>

            <section id="addFunctionSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 hidden dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Agregar/Editar Comando</h2>
                <form id="addFunctionForm">
                    <div class="mb-4">
                        <label for="funcName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre Comando/Concepto:</label>
                        <input type="text" id="funcName" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required>
                    </div>
                    <div class="mb-4">
                        <label for="funcDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción:</label>
                        <textarea id="funcDescription" rows="3" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md dark:bg-gray-600 dark:text-gray-100" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="funcSyntax" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sintaxis:</label>
                        <textarea id="funcSyntax" rows="3" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md font-mono dark:bg-gray-600 dark:text-gray-100" required></textarea>
                    </div>

                    <button id="validateSyntaxButton" type="button" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 transition duration-200 mb-3">
                        Pre-validar Sintaxis con IA ✨
                    </button>
                    <div id="validationMessage" class="mt-2 mb-3 text-center"></div>
                    <button id="addFunctionButton" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-200">
                        Guardar Comando
                    </button>
                </form>
                 <div id="statusMessage" class="mt-4 text-center"></div>
            </section>

             <section id="fixErrorSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 my-8 hidden dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                 <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Corregir/Optimizar SQL</h2>
                 <div class="mb-4">
                     <label for="errorInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Código SQL a corregir:</label>
                     <textarea id="errorInput" rows="4" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md font-mono focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-600 dark:text-gray-100" placeholder="Pega aquí tu código SQL..."></textarea>
                 </div>
                 <div class="mb-4">
                     <label for="correctionKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Clave Promoción (Admin):</label>
                     <input type="password" id="correctionKey" class="w-full p-2 border border-gray-400 dark:border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-600 dark:text-gray-100">
                 </div>
                 <button id="fixButton" type="button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                     Corregir Sintaxis ✨
                 </button>
                 <div id="correctionResult" class="mt-4"></div>
             </section>

             <section id="adminManagementSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 my-8 hidden dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
                  <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100 text-center">Gestión de Administradores</h2>
                 <p class="text-center text-gray-600 dark:text-gray-400">Aquí podrías añadir más funcionalidades, como listar o eliminar admins.</p>
                 </section>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100 dark:bg-gray-700 dark:text-gray-100">
            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Confirmación Requerida</h3>
            <p id="confirmModalMessage" class="text-gray-700 dark:text-gray-300 mb-6">¿Estás seguro?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200">
                    Cancelar
                </button>
                <button id="confirmBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
