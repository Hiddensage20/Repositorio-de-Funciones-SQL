<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Grabado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para el menú desplegable */
        .dropdown:hover .dropdown-menu {
            display: block;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // CAMBIO CLAVE: Importar funciones de Auth con Email/Password
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importar orderBy para ordenar los logs
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, getDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (Se mantiene la configuración original del usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
            authDomain: "codigograbado.firebaseapp.com",
            projectId: "codigograbado",
            storageBucket: "codigograbado.firebasestorage.app",
            messagingSenderId: "346430888474",
            appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
            measurementId: "G-626THBS8CJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, loggedInUser = null;
        let functionsList = [];
        let editingId = null;
        let confirmActionCallback = null;
        
        let isSyntaxValid = false; 

        // SE ELIMINAN LAS CREDENCIALES CODIFICADAS DEL SUPER ADMIN
        const SUPER_ADMIN_KEY = 'DT10VazC;#9i'; // Clave Mantenida SOLO para PROMOCIÓN, no para LOGIN
        
        // Rutas de Firestore
        const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
        const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
        const ADMINS_PATH = `${DB_ROOT}/admins`;
        const LOGS_PATH = `${DB_ROOT}/logs`;
        const NOTIFICATIONS_PATH = `${DB_ROOT}/notifications`; 


        // --- Funciones del Modal de Confirmación ---
        const showConfirmModal = (message, onConfirm) => {
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
            confirmActionCallback = onConfirm;
        };

        const hideConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            confirmActionCallback = null;
        };

        const handleConfirm = (isConfirmed) => {
            if (isConfirmed && confirmActionCallback) {
                confirmActionCallback();
            }
            hideConfirmModal();
        };
        // --- Fin Funciones del Modal de Confirmación ---


        // Función para inicializar Firebase
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); // Inicializa auth
                
                // Autenticación inicial (Anónima o con Custom Token)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }
                
                userId = auth.currentUser.uid;
                document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;
                
                console.log("Firebase inicializado y autenticación exitosa.");
                fetchFunctions();
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage("Error: No se pudo conectar a la base de datos.", 'error');
            }
        };

        const showMessage = (message, type = 'info') => {
            const statusMessage = document.getElementById('statusMessage');
            let targetElement = statusMessage; 
            if (!targetElement) {
                targetElement = document.getElementById('recommendationResults');
            }

            if (!targetElement) return; 

            targetElement.innerHTML = `<div class="mt-4 text-center p-3 rounded-lg font-medium" id="tempStatusMessage">${message}</div>`;
            const tempStatusMessage = document.getElementById('tempStatusMessage');

            tempStatusMessage.className = 'mt-4 text-center p-3 rounded-lg font-medium';
            if (type === 'error') {
                tempStatusMessage.classList.add('bg-rose-200', 'text-rose-800');
            } else if (type === 'success') {
                tempStatusMessage.classList.add('bg-emerald-200', 'text-emerald-800');
            } else {
                tempStatusMessage.classList.add('bg-indigo-200', 'text-indigo-800');
            }

            if (targetElement !== statusMessage) {
                setTimeout(() => {
                    targetElement.innerHTML = '';
                }, 5000);
            }
        };

        const fetchFunctions = () => {
            if (!db) return;
            const q = collection(db, FUNCTIONS_PATH);
            onSnapshot(q, (snapshot) => {
                functionsList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                displayFunctions();
            }, (error) => {
                console.error("Error al obtener comandos:", error);
                showMessage("Error al cargar los comandos.", 'error');
            });
        };

        const fetchNotifications = () => {
            console.log("Carga de notificaciones deshabilitada en la interfaz.");
            return;
        };

        const addNotification = async (func) => { /* No hace nada, el log ya se crea en addOrUpdateFunction */ };
        const deleteNotification = async (functionName) => { /* No hace nada, el log ya se crea en deleteFunction */ };

        const displayNotifications = (notifications) => {
            const notificationsList = document.getElementById('notificationsList');
            if (notificationsList) {
                notificationsList.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">Esta funcionalidad está deshabilitada en la interfaz. La actividad se registra en Firestore Logs.</p>';
            }
        };

        const displayFunctions = (functionsToDisplay = functionsList) => {
            const listElement = document.getElementById('functionsList');
            const searchList = document.getElementById('searchFunctionsList');
            listElement.innerHTML = '';
            searchList.innerHTML = '';

            const isUserLoggedIn = loggedInUser !== null;

            if (functionsToDisplay.length === 0) {
                listElement.innerHTML = '<p class="text-center text-gray-500">No se encontraron comandos.</p>';
            }

            functionsToDisplay.forEach(func => {
                const funcItem = document.createElement('div');
                funcItem.className = 'bg-gray-200 p-4 rounded-lg shadow-md mb-4';
                funcItem.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800">${func.name}</h3>
                    <p class="text-sm text-gray-600 mb-2"><strong>Descripción:</strong> ${func.description}</p>
                    <div class="bg-white p-3 rounded-lg border border-gray-400 overflow-x-auto">
                        <pre class="whitespace-pre-wrap font-mono text-gray-800"><code>${func.syntax}</code></pre>
                    </div>
                    <div class="mt-4 flex space-x-2 ${isUserLoggedIn ? '' : 'hidden'}">
                        <button class="edit-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Editar</button>
                        <button class="delete-btn bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Eliminar</button>
                    </div>
                `;
                listElement.appendChild(funcItem);

                if (isUserLoggedIn) {
                    funcItem.querySelector('.edit-btn').addEventListener('click', () => editFunction(func));
                    funcItem.querySelector('.delete-btn').addEventListener('click', () => deleteFunction(func.id));
                }

                const searchItem = document.createElement('li');
                searchItem.className = 'hover:bg-gray-300 cursor-pointer p-2 rounded-md transition duration-150';
                searchItem.textContent = func.name;
                searchItem.onclick = () => {
                    document.getElementById('descriptionSearch').value = func.description;
                    document.getElementById('descriptionSearch').focus();
                    showMessage(`Descripción del comando "${func.name}" cargada en el generador de consultas.`, 'info');
                };
                searchList.appendChild(searchItem);
            });
        };
        
        // ************************************************************
        // ********* FUNCIÓN DE VALIDACIÓN AMPLIADA A CUALQUIER COMANDO SQL **************
        // ************************************************************
        const validateFunctionWithAI = async () => {
            const name = document.getElementById('funcName').value.trim();
            const description = document.getElementById('funcDescription').value.trim();
            const syntax = document.getElementById('funcSyntax').value.trim();
            const validationMessageDiv = document.getElementById('validationMessage');
            const validateButton = document.getElementById('validateSyntaxButton');

            if (!loggedInUser) {
                validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Debes iniciar sesión para pre-validar la sintaxis.</p>`;
                return;
            }

            if (!name || !description || !syntax) {
                validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Completa los campos Nombre, Descripción y Sintaxis para validar.</p>`;
                return;
            }

            validateButton.textContent = 'Validando...';
            validateButton.disabled = true;
            validationMessageDiv.innerHTML = `<p class="mt-2 text-center p-3 rounded-lg font-medium bg-indigo-200 text-indigo-800">Analizando sintaxis con IA...</p>`;
            isSyntaxValid = false; 

            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; 
            
            let prompt = `Eres un experto en SQL. El usuario está intentando guardar un comando SQL.

            1. **Comando/Concepto Intendado:** "${name}"
            2. **Descripción:** "${description}"
            3. **Sintaxis proporcionada:** "${syntax}"

            Evalúa si la 'Sintaxis proporcionada' es un comando SQL bien formado (DDL, DML, TCL, o una función SQL) y que esté razonablemente relacionado con el 'Comando/Concepto Intendado'.

            - Si la Sintaxis es un comando SQL válido, responde con: SI:VALIDA
            - Si la Sintaxis NO es un comando SQL válido (ej. está incompleto o es erróneo), analiza la sintaxis y la descripción para sugerir el comando SQL que el usuario probablemente pretendía usar.
            
            Responde con: NO:Sugerencia de Comando: [Comando/Corrección sugerida]`;


            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Responde estrictamente con 'SI:VALIDA' o 'NO:Sugerencia de Comando: [COMANDO SUGERIDO/CORRECCIÓN]'. No uses comillas ni explicaciones adicionales." }] },
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                const responseText = text.trim().toUpperCase();

                if (responseText.startsWith('SI:VALIDA')) {
                    isSyntaxValid = true;
                    validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-emerald-800 bg-emerald-200 p-3 rounded-lg">¡Validación exitosa! La sintaxis es un comando SQL válido. Puedes guardar.</p>`;
                    return { valid: true };
                } else if (responseText.startsWith('NO:SUGERENCIA DE COMANDO:')) {
                    const suggestion = responseText.replace('NO:SUGERENCIA DE COMANDO:', '').trim();
                    
                    const userMessage = `Error de Sintaxis: Lo que ingresaste NO es un comando SQL válido. Sugerencia de la IA: **${suggestion}**. Por favor, ajusta la sintaxis y vuelve a validar.`;
                    
                    validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">${userMessage}</p>`;
                    return { valid: false };
                } else {
                    validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Error: La sintaxis no es válida. Inténtalo de nuevo.</p>`;
                    return { valid: false };
                }
            } catch (error) {
                console.error("Error al validar con IA:", error);
                validationMessageDiv.innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Error de conexión: No se pudo validar con la IA.</p>`;
                return { valid: false };
            } finally {
                validateButton.textContent = 'Pre-validar Sintaxis con IA ✨';
                validateButton.disabled = false;
            }
        };


        // ************************************************************
        // ********* LÓGICA DE GUARDADO (CREA EL LOG) *****************
        // ************************************************************
        const addOrUpdateFunction = async (event) => {
            event.preventDefault();
            const name = document.getElementById('funcName').value.trim();
            const description = document.getElementById('funcDescription').value.trim();
            const syntax = document.getElementById('funcSyntax').value.trim();
            const button = document.getElementById('addFunctionButton');
            const originalButtonText = editingId ? 'Actualizar Comando' : 'Guardar Comando';
            
            if (!loggedInUser) {
                showMessage('Debes iniciar sesión para realizar esta acción.', 'error');
                return;
            }

            if (!name || !description || !syntax) {
                showMessage('Todos los campos son obligatorios.', 'error');
                return;
            }
            
            if (!isSyntaxValid && !editingId) {
                document.getElementById('validationMessage').innerHTML = `<p class="mt-2 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">¡Atención! La sintaxis no ha sido pre-validada o la validación falló. Usa el botón "Pre-validar" antes de guardar.</p>`;
                return;
            }

            button.textContent = 'Guardando...';
            button.disabled = true;

            try {
                if (editingId) {
                    await updateDoc(doc(db, FUNCTIONS_PATH, editingId), {
                        name,
                        description,
                        syntax,
                    });
                    // ********** CREACIÓN DE LOG **********
                    await addDoc(collection(db, LOGS_PATH), {
                        action: "edited",
                        user: loggedInUser.username,
                        functionName: name,
                        timestamp: new Date()
                    });
                    // *************************************
                    showMessage(`Comando actualizado con éxito.`, 'success');
                    editingId = null;
                    document.getElementById('addFunctionButton').textContent = 'Guardar Comando';
                } else {
                    await addDoc(collection(db, FUNCTIONS_PATH), {
                        name,
                        description,
                        syntax,
                        createdAt: new Date()
                    });
                    // ********** CREACIÓN DE LOG **********
                    await addDoc(collection(db, LOGS_PATH), {
                        action: "added",
                        user: loggedInUser.username,
                        functionName: name,
                        timestamp: new Date()
                    });
                    // *************************************
                    showMessage(`Comando agregado con éxito.`, 'success');
                }
                document.getElementById('addFunctionForm').reset();
                document.getElementById('validationMessage').innerHTML = ''; 
                isSyntaxValid = false; 
            } catch (e) {
                console.error("Error al agregar/actualizar documento: ", e);
                showMessage("Error al guardar el comando. Verifica la consola de Firebase.", 'error');
            } finally {
                button.textContent = originalButtonText;
                button.disabled = false;
            }
        };

        const editFunction = (func) => {
            editingId = func.id;
            document.getElementById('funcName').value = func.name;
            document.getElementById('funcDescription').value = func.description;
            document.getElementById('funcSyntax').value = func.syntax;
            document.getElementById('addFunctionButton').textContent = 'Actualizar Comando';
            document.getElementById('addFunctionSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('validationMessage').innerHTML = '<p class="mt-2 text-center text-indigo-800 bg-indigo-200 p-3 rounded-lg">Modo Edición: La validación previa se omite al guardar.</p>';
            isSyntaxValid = true; 
        };

        const deleteFunction = async (id) => {
            if (!loggedInUser) {
                showMessage('Debes iniciar sesión para realizar esta acción.', 'error');
                return;
            }
            
            showConfirmModal('¿Estás seguro de que quieres eliminar este comando? Esta acción no se puede deshacer.', async () => {
                try {
                    const docRef = doc(db, FUNCTIONS_PATH, id);
                    const funcSnap = await getDoc(docRef);
                    if (funcSnap.exists()) {
                        await deleteDoc(docRef);
                        
                        // ********** CREACIÓN DE LOG **********
                        await addDoc(collection(db, LOGS_PATH), {
                            action: "deleted",
                            user: loggedInUser.username,
                            functionName: funcSnap.data().name,
                            timestamp: new Date()
                        });
                        // *************************************

                        showMessage('Comando eliminado con éxito.', 'success');
                    }
                } catch (e) {
                    console.error("Error al eliminar documento: ", e);
                    showMessage("Error al eliminar el comando.", 'error');
                }
            });
        };

        // Función de Creación de Administrador
        const createAdmin = async (event) => {
            event.preventDefault();
            const newAdminEmail = document.getElementById('newAdminEmail').value.trim();
            const newAdminPassword = document.getElementById('newAdminPassword').value;
            const newAdminUsername = document.getElementById('newAdminUsername').value.trim();
            const secretKey = document.getElementById('secretKey').value;
            const adminMessage = document.getElementById('adminMessage');

            adminMessage.textContent = '';
            adminMessage.className = 'mt-4 text-center text-sm';
            
            // La clave secreta ahora solo es obligatoria si el email ya existe
            const isPromotingExistingUser = secretKey === SUPER_ADMIN_KEY;
            
            if (!newAdminEmail || !newAdminPassword || !newAdminUsername) {
                adminMessage.textContent = 'Todos los campos son obligatorios.';
                adminMessage.classList.add('text-rose-500');
                return;
            }
            
            let uid = null;

            try {
                // 1. Intentar crear usuario en Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                uid = userCredential.user.uid;
            } catch (e) {
                if (e.code === 'auth/email-already-in-use') {
                    // Si el email ya está en uso, intentamos obtener el UID SÓLO si se proporciona la clave de promoción.
                    if (isPromotingExistingUser) {
                        try {
                            // Temporalmente loguea al usuario para obtener el UID
                            const userCredential = await signInWithEmailAndPassword(auth, newAdminEmail, newAdminPassword);
                            uid = userCredential.user.uid;
                            // Cierra la sesión temporal para no interrumpir al Admin que está creando la cuenta.
                            await signOut(auth); 
                            adminMessage.textContent = 'Advertencia: El email ya existía. Se asignarán permisos de administrador.';
                            adminMessage.classList.add('text-yellow-500');
                        } catch (signInError) {
                             let displayError = 'Error: El email ya está registrado, pero la contraseña no coincide. No se puede obtener el UID para asignar permisos.';
                             adminMessage.textContent = displayError;
                             adminMessage.classList.add('text-rose-500');
                             return;
                        }
                    } else {
                        adminMessage.textContent = 'Error: El email ya está registrado. Para promocionar a un usuario existente, ingrese la clave secreta.';
                        adminMessage.classList.add('text-rose-500');
                        return;
                    }
                } else if (e.code === 'auth/weak-password') {
                    adminMessage.textContent = 'Error: La contraseña debe tener al menos 6 caracteres.';
                    adminMessage.classList.add('text-rose-500');
                    return;
                } else {
                    console.error("Error al crear usuario Auth:", e);
                    adminMessage.textContent = `Error (${e.code || 'unknown-error'}): No se pudo crear la cuenta de usuario.`;
                    adminMessage.classList.add('text-rose-500');
                    return;
                }
            }
            
            if (!uid) { return; } // Salir si no se pudo obtener el UID.


            // 2. Registrar el rol en Firestore usando el UID (tanto para usuarios nuevos como existentes)
            try {
                await setDoc(doc(db, ADMINS_PATH, uid), {
                    uid: uid,
                    username: newAdminUsername,
                    email: newAdminEmail,
                    isAdmin: true, // Establecer como true para que sea admin de Firestore
                    lastLogin: null
                }, { merge: true }); // Usar merge: true para no sobrescribir lastLogin si ya existe.

                if (!adminMessage.classList.contains('text-yellow-500')) {
                    adminMessage.textContent = `Administrador ${newAdminUsername} creado con éxito. Ahora puede iniciar sesión con su email y contraseña.`;
                    adminMessage.classList.add('text-emerald-500');
                }
                document.getElementById('createAdminForm').reset();
            } catch (e) {
                console.error("Error al registrar administrador en Firestore:", e);
                adminMessage.textContent = 'Error: Se creó la cuenta de Auth, pero falló el registro de permisos en Firestore.';
                adminMessage.classList.add('text-rose-500');
            }
        };

        const logout = async () => {
            try {
                // Siempre cierra la sesión de Firebase Auth, si existe.
                if (auth.currentUser) {
                    await signOut(auth);
                }
                
                // Reseteamos el estado de la aplicación
                loggedInUser = null; 

                // Ocultar secciones de administración
                document.getElementById('addFunctionSection').classList.add('hidden');
                document.getElementById('fixErrorSection').classList.add('hidden');
                document.getElementById('adminManagementSection').classList.add('hidden');
                document.getElementById('notificationsSection').classList.add('hidden');
                
                // Ocultar elementos del menú
                document.getElementById('adminDropdownLogin').classList.remove('hidden');
                document.getElementById('adminDropdownLogout').classList.add('hidden');
                document.getElementById('adminDropdownManagement').classList.add('hidden');
                document.getElementById('welcomeMessage').classList.add('hidden');


                // Volver a iniciar sesión anónima para acceder a funciones de lectura pública
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;

                // Mostrar sección de login y refrescar lista para ocultar botones de editar/eliminar
                document.getElementById('loginSection').classList.add('hidden'); // Siempre oculta ahora
                displayFunctions(); 

                showMessage('Sesión cerrada correctamente.', 'info');
            } catch (error) {
                console.error("Error al cerrar sesión o al re-autenticar anónimamente:", error);
                showMessage('Error al cerrar sesión.', 'error');
            }
        };

        // MODIFICACIÓN CRÍTICA: Se elimina la verificación estricta del rol de Firestore.
        const login = async (event) => {
            event.preventDefault();
            const loginEmail = document.getElementById('loginEmail').value.trim();
            const loginPassword = document.getElementById('loginPassword').value;
            const loginMessage = document.getElementById('loginMessage');
            
            loginMessage.textContent = '';
            loggedInUser = null; 
            
            let userFound = false;
            let uid = null;

            try {
                // 1. Intento de inicio de sesión de Firebase Auth (Email/Password)
                const userCredential = await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
                const user = userCredential.user;
                uid = user.uid;

                // 2. ASUMIMOS QUE EL USUARIO AUTENTICADO ES EL ADMIN 
                loggedInUser = { 
                    uid: uid,
                    // Usamos la parte del email antes del @ como nombre de usuario por defecto
                    username: loginEmail.split('@')[0], 
                    isAdmin: true, // Asumir permisos de administrador
                    lastLogin: null // Se obtendrá y actualizará después
                };
                userFound = true;

                // Opcional: Intento de obtener el documento de Firestore si existiera
                try {
                    const docRef = doc(db, ADMINS_PATH, uid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        loggedInUser.lastLogin = docSnap.data().lastLogin;
                        loggedInUser.username = docSnap.data().username || loggedInUser.username;
                    }
                } catch (e) {
                    console.warn("No se pudo obtener el documento de admin para la verificación de logs.", e);
                }

            } catch (e) {
                console.error("Error de autenticación:", e);
                const errorCode = e.code || '';
                
                // Manejo de errores comunes de Firebase Auth
                if (errorCode === 'auth/invalid-credential' || errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                    loginMessage.textContent = 'Credenciales incorrectas.';
                } else {
                    loginMessage.textContent = 'Error de autenticación. Verifica tus datos.';
                }
                loginMessage.classList.add('text-rose-500');
                return;
            }


            if (userFound) {
                // La sesión de Firebase Auth ya está activa (userCredential la inició)
                document.getElementById('loginSection').classList.add('hidden'); // Ocultar formulario de login
                
                // Mostrar botones de administración en el menú
                document.getElementById('adminDropdownLogin').classList.add('hidden');
                document.getElementById('adminDropdownLogout').classList.remove('hidden');
                document.getElementById('adminDropdownManagement').classList.remove('hidden');


                document.getElementById('addFunctionSection').classList.remove('hidden');
                document.getElementById('fixErrorSection').classList.remove('hidden');
                document.getElementById('adminManagementSection').classList.remove('hidden');
                
                displayFunctions(); // Refresca botones de editar/eliminar

                // Actualizar log y mensaje de bienvenida
                const userDataRef = doc(db, ADMINS_PATH, loggedInUser.uid);
                
                await sendWelcomeMessage(loggedInUser.lastLogin, loggedInUser.username);
                
                // Actualizamos o creamos el documento mínimo en ADMINS_PATH después de un login exitoso.
                await setDoc(userDataRef, { 
                    lastLogin: new Date(),
                    username: loggedInUser.username,
                    uid: loggedInUser.uid,
                    isAdmin: true 
                }, { merge: true });

                showMessage(`¡Bienvenido, ${loggedInUser.username}! Has iniciado sesión con éxito.`, 'success');
                document.getElementById('welcomeMessage').classList.remove('hidden');
            }
        };


        const sendWelcomeMessage = async (lastLogin, username) => {
            const welcomeMessageDiv = document.getElementById('welcomeMessage');
            let actionsSummary = '';
            
            if (lastLogin) {
                const logsRef = collection(db, LOGS_PATH);
                const q = query(logsRef, where("user", "==", username));
                try {
                    const querySnapshot = await getDocs(q);

                    const recentActions = [];
                    querySnapshot.forEach(doc => {
                        const log = doc.data();
                        if (log.timestamp.toDate() > lastLogin.toDate()) {
                            recentActions.push(log);
                        }
                    });

                    if (recentActions.length > 0) {
                        const added = recentActions.filter(a => a.action === 'added').map(a => a.functionName).join(', ');
                        const edited = recentActions.filter(a => a.action === 'edited').map(a => a.functionName).join(', ');
                        const deleted = recentActions.filter(a => a.action === 'deleted').map(a => a.functionName).join(', ');
                        actionsSummary = `Resumen de tu actividad: ${added.length > 0 ? `agregaste: ${added}. ` : ''}${edited.length > 0 ? `editaste: ${edited}. ` : ''}${deleted.length > 0 ? `eliminaste: ${deleted}. ` : ''}`;
                    }
                } catch (error) {
                    console.error("Error al obtener logs:", error);
                }
            }
            
            const diffMs = lastLogin ? new Date() - lastLogin.toDate() : null;
            const diffDays = diffMs ? Math.floor(diffMs / (1000 * 60 * 60 * 24)) : null;
            const timeAgo = diffDays !== null ? `${diffDays} día(s)` : 'primera vez';

            welcomeMessageDiv.textContent = 'Generando mensaje de bienvenida...';

            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const prompt = `Genera un mensaje de bienvenida para un administrador de una base de datos de comandos de SQL. El nombre del usuario es "${username}". Su última sesión fue hace "${timeAgo}". El mensaje debe ser breve, motivador y debe recordarle revisar el panel de logs. Incluye el siguiente resumen de su actividad: "${actionsSummary}". Termina el mensaje con la frase "¡Buen código!".`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Genera un mensaje de bienvenida amigable y motivador." }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || `¡Bienvenido de nuevo, ${username}!`;
                welcomeMessageDiv.textContent = text;
            } catch (error) {
                console.error("Error al generar el mensaje de bienvenida:", error);
                welcomeMessageDiv.textContent = `¡Bienvenido de nuevo, ${username}! Te recordamos que revises el panel de logs. ¡Buen código!`;
            }
        };
        
        // ************************************************************
        // ********* FUNCIÓN IMPLEMENTADA PARA GENERAR CONSULTA *********
        // ************************************************************
        const generateSQLQuery = async () => {
            const description = document.getElementById('descriptionSearch').value.trim();
            const button = document.getElementById('descriptionSearchButton');
            const resultsDiv = document.getElementById('recommendationResults');
            
            if (!description) {
                showMessage('Por favor, describe tu necesidad para generar la consulta.', 'error');
                return;
            }

            button.textContent = 'Generando...';
            button.disabled = true;
            resultsDiv.innerHTML = '';
            
            // Usamos un mensaje temporal dentro del div de resultados para informar
            resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-indigo-200 text-indigo-800">Generando consulta SQL...</p>`;


            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // Usando tu API Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Prompts para la generación de código SQL
            const prompt = `Eres un experto en SQL. Genera una consulta SQL (solo el código, no expliques nada) basada en la siguiente descripción. No incluyas comentarios o texto adicional. Descripción: "${description}".`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Genera exclusivamente código SQL para bases de datos relacionales, sin ningún texto, explicación o comentarios." }] },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // Limpieza básica para asegurar que solo sea código (remueve markdown si lo hay)
                const sqlCode = text.replace(/```sql|```/g, '').trim(); 
                
                resultsDiv.innerHTML = `
                    <h3 class="text-xl font-bold mt-4 mb-2 text-gray-900">Consulta Generada:</h3>
                    <div class="bg-indigo-100 p-4 rounded-lg border border-indigo-400 overflow-x-auto">
                        <pre class="whitespace-pre-wrap font-mono text-indigo-800"><code>${sqlCode}</code></pre>
                    </div>
                `;
                // Usamos la función original de showMessage para el feedback general
                showMessage('Consulta SQL generada con éxito.', 'success');
                
            } catch (error) {
                console.error("Error al generar la consulta SQL:", error);
                resultsDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-rose-200 text-rose-800">Error al generar la consulta: ${error.message}. Intenta de nuevo.</p>`;
            } finally {
                button.textContent = 'Generar Consulta SQL ✨';
                button.disabled = false;
            }
        };

        const fixSyntaxWithAI = async () => {
            const syntax = document.getElementById('errorInput').value.trim();
            const correctionKey = document.getElementById('correctionKey').value.trim();
            const resultDiv = document.getElementById('correctionResult');
            const button = document.getElementById('fixButton');

            if (!syntax) {
                resultDiv.innerHTML = `<p class="mt-4 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Por favor, ingresa el código SQL a corregir.</p>`;
                return;
            }

            if (correctionKey !== SUPER_ADMIN_KEY) {
                resultDiv.innerHTML = `<p class="mt-4 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Clave de Promoción incorrecta. Debes ser administrador para usar esta función.</p>`;
                return;
            }

            button.textContent = 'Corrigiendo...';
            button.disabled = true;
            resultDiv.innerHTML = `<p class="mt-4 text-center p-3 rounded-lg font-medium bg-indigo-200 text-indigo-800">Analizando y corrigiendo sintaxis con IA...</p>`;

            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const prompt = `Eres un experto en optimización y corrección de código SQL. Corrige cualquier error de sintaxis en el siguiente código y, si es posible, ofréceme una versión optimizada. Devuelve SÓLO el código SQL final corregido y optimizado. No uses comentarios ni ninguna explicación. Código SQL: ${syntax}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Corrige y optimiza el código SQL, devolviendo exclusivamente la consulta SQL resultante." }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo generar una corrección.';

                const correctedCode = text.replace(/```sql|```/g, '').trim();

                resultDiv.innerHTML = `
                    <h3 class="text-xl font-bold mt-4 mb-2 text-gray-900">Código Corregido/Optimizado:</h3>
                    <div class="bg-emerald-100 p-4 rounded-lg border border-emerald-400 overflow-x-auto">
                        <pre class="whitespace-pre-wrap font-mono text-emerald-800"><code>${correctedCode}</code></pre>
                    </div>
                `;

            } catch (error) {
                console.error("Error al corregir con IA:", error);
                resultDiv.innerHTML = `<p class="mt-4 text-center text-rose-800 bg-rose-200 p-3 rounded-lg">Error al conectar con la IA para la corrección.</p>`;
            } finally {
                button.textContent = 'Corregir Sintaxis ✨';
                button.disabled = false;
            }
        };

        const searchFunctions = (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredFunctions = functionsList.filter(func => 
                func.name.toLowerCase().includes(searchTerm) || 
                func.description.toLowerCase().includes(searchTerm) || 
                func.syntax.toLowerCase().includes(searchTerm)
            );
            displayFunctions(filteredFunctions);
        };

        // Función para mostrar el formulario de login en el dropdown
        const showAdminLogin = () => {
            document.getElementById('adminLoginModal').classList.remove('hidden');
            document.getElementById('adminLoginModal').classList.add('flex');
            document.getElementById('adminLoginContainer').classList.remove('hidden');
            document.getElementById('createAdminContainer').classList.add('hidden');
        };

        // Función para mostrar el formulario de creación de admin
        const showAdminManagement = () => {
             document.getElementById('adminLoginModal').classList.remove('hidden');
             document.getElementById('adminLoginModal').classList.add('flex');
             document.getElementById('adminLoginContainer').classList.add('hidden');
             document.getElementById('createAdminContainer').classList.remove('hidden');
        };

        // Función para cerrar el modal de administración
        const closeAdminModal = () => {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminLoginModal').classList.remove('flex');
        };


        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            // Event Listeners para los botones del dropdown
            document.getElementById('showLoginButton').addEventListener('click', showAdminLogin);
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('showAdminManagementButton').addEventListener('click', showAdminManagement);
            document.getElementById('closeAdminModalButton').addEventListener('click', closeAdminModal);
            
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('addFunctionForm').addEventListener('submit', addOrUpdateFunction);
            
            // Event Listeners restantes
            document.getElementById('validateSyntaxButton').addEventListener('click', validateFunctionWithAI);
            document.getElementById('descriptionSearchButton').addEventListener('click', generateSQLQuery);
            document.getElementById('fixButton').addEventListener('click', fixSyntaxWithAI);
            document.getElementById('createAdminForm').addEventListener('submit', createAdmin);
            document.getElementById('functionSearchInput').addEventListener('input', searchFunctions);
            document.getElementById('confirmBtn').addEventListener('click', () => handleConfirm(true));
            document.getElementById('cancelBtn').addEventListener('click', () => handleConfirm(false));

            // Escuchar cambios en los campos para forzar una re-validación
            const resetValidation = () => {
                isSyntaxValid = false;
                document.getElementById('validationMessage').innerHTML = '';
                document.getElementById('statusMessage').innerHTML = '';
            };
            document.getElementById('funcName').addEventListener('input', resetValidation);
            document.getElementById('funcDescription').addEventListener('input', resetValidation);
            document.getElementById('funcSyntax').addEventListener('input', resetValidation);
        });
    </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 md:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-gray-900">Código Grabado</h1>
            
            <div class="dropdown inline-block relative">
                <button class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded inline-flex items-center hover:bg-indigo-700 transition duration-200">
                    <span class="mr-1">Admin</span>
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </button>
                <ul class="dropdown-menu absolute hidden text-gray-700 pt-1 right-0 z-20 w-64 shadow-xl border border-gray-200 bg-white rounded-lg overflow-hidden">
                    
                    <li id="adminDropdownLogin">
                        <a id="showLoginButton" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">
                            Iniciar Sesión
                        </a>
                    </li>

                    <li id="adminDropdownManagement" class="hidden">
                        <a id="showAdminManagementButton" class="bg-purple-100 hover:bg-purple-200 py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm font-medium">
                            Crear Admin
                        </a>
                    </li>
                    
                    <li id="adminDropdownLogout" class="hidden">
                        <a id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 block whitespace-no-wrap cursor-pointer text-sm">
                            Cerrar Sesión
                        </a>
                    </li>

                    <li class="p-2 border-t text-xs text-gray-500">
                        <p id="userIdDisplay">Tu ID de usuario: ...</p>
                    </li>
                </ul>
            </div>
        </div>
    </header>


    <div class="container mx-auto p-4 md:p-8">
        
        <div id="welcomeMessage" class="text-center mt-4 mb-8 text-xl text-indigo-800 font-semibold hidden"></div>

        <div id="adminLoginModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 max-w-md w-full relative">
                <button id="closeAdminModalButton" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>

                <div id="adminLoginContainer">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 text-center">Inicio de Sesión (Admin)</h2>
                    <p class="text-sm text-gray-500 text-center mb-4">Ingresa con tu email y contraseña de administrador.</p>
                    <form id="loginForm">
                        <div class="mb-4">
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                            <input type="email" id="loginEmail" class="w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña:</label>
                            <input type="password" id="loginPassword" class="w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                            Ingresar
                        </button>
                    </form>
                    <p id="loginMessage" class="mt-4 text-center text-sm"></p>
                </div>

                <div id="createAdminContainer" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 text-center">Crear Nuevo Usuario Administrador</h2>
                    <p class="text-sm text-gray-600 mb-4">Crea una nueva cuenta de Auth y asigna permisos de administrador en Firestore.</p>
                    <form id="createAdminForm">
                        <div class="mb-4">
                            <label for="newAdminEmail" class="block text-sm font-medium text-gray-700 mb-1">Email del Administrador:</label>
                            <input type="email" id="newAdminEmail" class="w-full p-2 border border-gray-400 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="newAdminPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña (Mínimo 6 caracteres):</label>
                            <input type="password" id="newAdminPassword" class="w-full p-2 border border-gray-400 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="newAdminUsername" class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario (Para logs):</label>
                            <input type="text" id="newAdminUsername" class="w-full p-2 border border-gray-400 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="secretKey" class="block text-sm font-medium text-gray-700 mb-1">Clave de Promoción (Opcional, para usuarios existentes):</label>
                            <input type="password" id="secretKey" class="w-full p-2 border border-gray-400 rounded-md">
                        </div>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                            Crear y Promover Administrador
                        </button>
                        <p id="adminMessage" class="mt-4 text-center text-sm"></p>
                    </form>
                </div>
            </div>
        </div>
        <div>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 lg:col-span-1 h-fit">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Generar Código SQL</h2>
                    <div class="mb-4">
                        <label for="descriptionSearch" class="block text-sm font-medium text-gray-700 mb-1">Describe tu necesidad:</label>
                        <textarea id="descriptionSearch" rows="3" class="w-full p-2 border border-gray-400 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Obtener el promedio de ventas de productos por categoría en el último mes.">devuelve datos de una tabla</textarea>
                    </div>
                    <button id="descriptionSearchButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        Generar Consulta SQL ✨
                    </button>
                    <div id="recommendationResults" class="mt-4"></div>
                    
                    <h3 class="text-xl font-bold mt-8 mb-2 text-gray-900">Comandos Rápidos (Clic para usar)</h3> 
                    <ul id="searchFunctionsList" class="bg-gray-100 p-2 rounded-lg max-h-48 overflow-y-auto border border-gray-300">
                        <p class="text-center text-gray-500 text-sm py-2">Cargando sugerencias...</p>
                    </ul>
                </section>

                <section class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">Listado de Comandos SQL</h2> 
                        <div class="mb-4">
                            <label for="functionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar comandos:</label>
                            <input type="text" id="functionSearchInput" class="w-full p-2 border border-gray-400 rounded-md focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: SELECT, ADD, AVG, cadena">
                        </div>
                        <div id="functionsList">
                            <p class="text-center text-gray-500">Cargando comandos...</p>
                        </div>
                    </div>
                </section>
            </main>
            
            <section id="notificationsSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Notificaciones del Administrador</h2>
                <div id="notificationsList" class="max-h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg border border-indigo-300">
                    <p class="text-center text-gray-500 text-sm py-2">Esta funcionalidad está deshabilitada en la interfaz. La actividad se registra en Firestore Logs.</p>
                </div>
            </section>
            
            <section id="fixErrorSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Corregir y Optimizar SQL con IA</h2>
                <div class="mb-4">
                    <label for="errorInput" class="block text-sm font-medium text-gray-700 mb-1">Ingresa el código SQL con errores o para optimizar:</label>
                    <textarea id="errorInput" rows="4" class="w-full p-2 border border-gray-400 rounded-md font-mono focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: SELECT nombre FROM usuarios WHERE edad > 25"></textarea>
                </div>
                <div class="mb-4">
                    <label for="correctionKey" class="block text-sm font-medium text-gray-700 mb-1">Clave de Promoción (DT10VazC;#9i):</label>
                    <input type="password" id="correctionKey" class="w-full p-2 border border-gray-400 rounded-md focus:ring-purple-500 focus:border-purple-500">
                </div>
                <button id="fixButton" type="button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        Corregir Sintaxis ✨
                    </button>
                    <div id="correctionResult"></div>
                </section>

            <section id="addFunctionSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Agregar Nuevo Comando/Concepto</h2> 
                <form id="addFunctionForm">
                    <div class="mb-4">
                        <label for="funcName" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Comando/Concepto (Ej: SELECT, UPDATE, AVG, DDL):</label> 
                        <input type="text" id="funcName" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="funcDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción breve:</label>
                        <textarea id="funcDescription" rows="3" class="w-full p-2 border border-gray-400 rounded-md" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="funcSyntax" class="block text-sm font-medium text-gray-700 mb-1">Sintaxis (Ej. SELECT * FROM tabla;):</label>
                        <textarea id="funcSyntax" rows="3" class="w-full p-2 border border-gray-400 rounded-md font-mono" required></textarea>
                    </div>
                    
                    <button id="validateSyntaxButton" type="button" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 transition duration-200 mb-3">
                        Pre-validar Sintaxis con IA ✨
                    </button>
                    <div id="validationMessage" class="mt-4 text-center"></div>
                    <button id="addFunctionButton" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-200">
                        Guardar Comando
                    </button>
                </form>
                <div id="statusMessage" class="mt-4 text-center"></div>
            </section>

                        <section id="adminManagementSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Crear Nuevo Usuario Administrador</h2>
                <p class="text-sm text-gray-600 mb-4">Crea una nueva cuenta de Auth y asigna permisos de administrador en Firestore.</p>
                <form id="createAdminForm">
                    <div class="mb-4">
                        <label for="newAdminEmail" class="block text-sm font-medium text-gray-700 mb-1">Email del Administrador:</label>
                        <input type="email" id="newAdminEmail" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="newAdminPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña (Mínimo 6 caracteres):</label>
                        <input type="password" id="newAdminPassword" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="newAdminUsername" class="block text-sm font-medium text-gray-700 mb-1">Nombre de Usuario (Para logs):</label>
                        <input type="text" id="newAdminUsername" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="secretKey" class="block text-sm font-medium text-gray-700 mb-1">Clave de Promoción (Opcional, para usuarios existentes):</label>
                        <input type="password" id="secretKey" class="w-full p-2 border border-gray-400 rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        Crear y Promover Administrador
                    </button>
                    <p id="adminMessage" class="mt-4 text-center text-sm"></p>
                </form>
            </section>
        </div>
    </div>

        <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Confirmación Requerida</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
                <button id="confirmBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
