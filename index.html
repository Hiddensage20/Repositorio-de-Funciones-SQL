<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test - Código Grabado (single file)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(10,10,10,0.06); padding: 20px; background: white; }
    .dark .card { background: #1f2937; color:#e5e7eb; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    #recommendationResults pre { white-space: pre-wrap; word-wrap: break-word; }
    .center { max-width:900px; margin: 18px auto; padding: 0 16px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="center">
    <header class="flex justify-between items-center py-6">
      <h1 class="text-2xl font-extrabold">Código <span class="text-indigo-600">Grabado</span></h1>
      <div>
        <label class="mr-4">Claro <input id="darkModeToggle" type="checkbox" /></label>
        <button id="adminDropdown" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Admin ▼</button>
      </div>
    </header>

    <section class="card mb-6">
      <h2 class="text-xl font-bold mb-3">Generar Código SQL</h2>
      <label class="block text-sm mb-2">Describe tu necesidad:</label>
      <textarea id="descriptionSearch" rows="3" class="w-full p-2 border rounded-md"></textarea>
      <button id="descriptionSearchButton" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg">Generar Consulta SQL ✨</button>
      <div id="recommendationResults" class="mt-4"></div>
    </section>

    <section class="card mb-6">
      <h2 class="text-xl font-bold mb-3">Listado de Comandos SQL</h2>
      <input id="searchInput" placeholder="Buscar comandos..." class="w-full p-2 border rounded-md mb-3" />
      <div id="functionsList"></div>
    </section>

    <!-- admin hidden panels -->
    <section id="addFunctionSection" class="card mb-6 hidden">
      <h3 class="font-bold mb-2">Agregar / Editar Comando</h3>
      <form id="addFunctionForm">
        <input id="funcName" placeholder="Nombre" class="w-full p-2 border rounded-md mb-2" />
        <textarea id="funcDescription" placeholder="Descripción" class="w-full p-2 border rounded-md mb-2"></textarea>
        <textarea id="funcSyntax" placeholder="Sintaxis SQL" class="w-full p-2 border rounded-md mb-2"></textarea>
        <div class="flex gap-2">
          <button id="validateSyntaxButton" type="button" class="bg-indigo-500 text-white px-3 py-2 rounded">Validar IA</button>
          <button id="addFunctionButton" type="submit" class="bg-emerald-600 text-white px-3 py-2 rounded">Guardar</button>
        </div>
        <div id="validationMessage" class="mt-3"></div>
      </form>
    </section>

    <section id="fixErrorSection" class="card mb-6 hidden">
      <h3 class="font-bold mb-2">Corregir con IA</h3>
      <textarea id="errorInput" rows="3" class="w-full p-2 border rounded-md mb-2"></textarea>
      <input id="correctionKey" placeholder="Clave admin (opcional)" class="w-full p-2 border rounded-md mb-2" />
      <button id="fixButton" class="bg-purple-600 text-white px-4 py-2 rounded block w-full">Corregir</button>
      <div id="correctionResult" class="mt-3"></div>
    </section>

    <section id="adminManagementSection" class="card mb-6 hidden">
      <h3 class="font-bold mb-2">Crear Admin</h3>
      <form id="createAdminForm">
        <input id="newAdminEmail" type="email" placeholder="Email" class="w-full p-2 border rounded-md mb-2" />
        <input id="newAdminUsername" placeholder="Usuario" class="w-full p-2 border rounded-md mb-2" />
        <input id="newAdminPassword" type="password" placeholder="Contraseña" class="w-full p-2 border rounded-md mb-2" />
        <button class="bg-purple-600 text-white px-4 py-2 rounded w-full">Crear Admin</button>
        <p id="adminMessage" class="mt-2"></p>
      </form>
    </section>

    <!-- login modal (simple) -->
    <div id="adminLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
      <div class="bg-white p-6 rounded-lg w-full max-w-sm">
        <h3 class="font-bold mb-3">Iniciar Sesión</h3>
        <form id="loginForm">
          <input id="adminEmail" type="email" placeholder="Email" class="w-full p-2 border rounded-md mb-2" required />
          <input id="adminPassword" type="password" placeholder="Contraseña" class="w-full p-2 border rounded-md mb-2" required />
          <div class="flex gap-2">
            <button class="bg-indigo-600 text-white px-3 py-2 rounded" type="submit">Entrar</button>
            <button id="closeAdminModalButton" type="button" class="bg-gray-300 px-3 py-2 rounded">Cerrar</button>
          </div>
          <p id="loginMessage" class="mt-2"></p>
        </form>
      </div>
    </div>

  </div>

  <!-- inline JS (module) -->
  <script type="module">
  // -------------- imports (firebase) --------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    signInAnonymously,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    doc,
    deleteDoc,
    updateDoc,
    getDoc,
    setDoc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ========== config (same keys you confirmed) ==========
  const firebaseConfig = {
    apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
    authDomain: "codigograbado.firebaseapp.com",
    projectId: "codigograbado",
    storageBucket: "codigograbado.firebasestorage.app",
    messagingSenderId: "346430888474",
    appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
    measurementId: "G-626THBS8CJ"
  };
  const GEMINI_API_KEY = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q"; // tu key IA

  const SUPER_ADMIN_KEY = "DT10VazC;#9i";
  const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
  const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
  const ADMINS_PATH = `${DB_ROOT}/admins`;
  const LOGS_PATH = `${DB_ROOT}/logs`;

  // state
  let db, auth, userId, loggedInUser = null, functionsList = [], editingId = null, isSyntaxValid = false;

  // util
  const el = (id)=> document.getElementById(id);
  const show = (id)=> el(id)?.classList.remove('hidden');
  const hide = (id)=> el(id)?.classList.add('hidden');

  const showMessage = (targetId, text, type='info')=>{
    const tgt = el(targetId);
    if(!tgt) return;
    let color = 'bg-indigo-200 text-indigo-800';
    if(type==='error') color='bg-rose-200 text-rose-800';
    if(type==='success') color='bg-emerald-200 text-emerald-800';
    tgt.innerHTML = `<div class="p-3 rounded ${color}">${text}</div>`;
  };

  // theme
  const initializeTheme = ()=>{
    const isDark = localStorage.getItem('darkMode') === 'true';
    if(isDark) document.body.classList.add('dark');
    el('darkModeToggle').checked = !!isDark;
    el('darkModeToggle').addEventListener('change', ()=>{
      const now = el('darkModeToggle').checked;
      localStorage.setItem('darkMode', now);
      document.body.classList.toggle('dark', now);
    });
  };

  // firebase init
  async function initFirebase(){
    try{
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      await signInAnonymously(auth);
      userId = auth.currentUser?.uid;
      console.log('Firebase OK, uid=', userId);
      watchFunctions();
    }catch(e){ console.error('FB init error', e); showMessage('recommendationResults','Error inicializando Firebase: '+e.message,'error'); }
  }

  // watch functions
  function watchFunctions(){
    if(!db) return;
    const q = collection(db, FUNCTIONS_PATH);
    onSnapshot(q, snapshot=>{
      functionsList = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
      renderFunctions();
    }, err=>{
      console.error('listen err', err);
      showMessage('recommendationResults','No se pudo cargar comandos','error');
    });
  }

  function renderFunctions(){
    const out = el('functionsList');
    if(!out) return;
    out.innerHTML = '';
    if(!functionsList.length) { out.innerHTML = '<p class="text-gray-500">No hay comandos.</p>'; return; }
    functionsList.forEach(f=>{
      const card = document.createElement('div');
      card.className = 'mb-4 p-3 border rounded';
      card.innerHTML = `<h4 class="font-bold">${f.name}</h4>
        <p class="text-sm">${f.description||''}</p>
        <pre class="mt-2 p-2 bg-gray-50 rounded text-sm">${(f.syntax||'').replace(/</g,'&lt;')}</pre>
        <div class="mt-2"><button class="edit inline-block mr-2 px-3 py-1 bg-purple-600 text-white rounded">Editar</button><button class="del inline-block px-3 py-1 bg-rose-600 text-white rounded">Eliminar</button></div>`;
      out.appendChild(card);
      const editBtn = card.querySelector('.edit');
      const delBtn = card.querySelector('.del');
      editBtn?.addEventListener('click', ()=> {
        el('funcName').value = f.name||'';
        el('funcDescription').value = f.description||'';
        el('funcSyntax').value = f.syntax||'';
        editingId = f.id;
        show('addFunctionSection');
        window.scrollTo({top:0,behavior:'smooth'});
      });
      delBtn?.addEventListener('click', async ()=>{
        if(!confirm('Eliminar comando?')) return;
        try{
          await deleteDoc(doc(db, FUNCTIONS_PATH, f.id));
          alert('Eliminado');
        }catch(e){ alert('err '+e); }
      });
    });
  }

  // GENERATE SQL (Gemini)
  async function generateSQLQuery(){
    const description = el('descriptionSearch')?.value.trim();
    if(!description){ showMessage('recommendationResults','Describe la necesidad primero','error'); return; }
    const btn = el('descriptionSearchButton'); btn.disabled = true; btn.textContent = 'Generando...';
    const resultsDiv = el('recommendationResults'); if(resultsDiv) resultsDiv.innerHTML = '';
    try{
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
      const prompt = `Eres un experto en SQL. Genera SOLO la consulta SQL basándote en: "${description}". Sólo devuelve código SQL.`;
      const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: "Solo devuelve código SQL." }] } };
      const r = await fetch(apiUrl, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!r.ok) throw new Error('API status '+r.status);
      const data = await r.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const sql = text.replace(/```sql|```/g,'').trim();
      if(resultsDiv) resultsDiv.innerHTML = `<h4 class="font-bold">Consulta generada</h4><pre class="mt-2 p-3 bg-indigo-50 rounded">${(sql||'').replace(/</g,'&lt;')}</pre>`;
    }catch(e){
      console.error('gen err', e);
      if(resultsDiv) resultsDiv.innerHTML = `<p class="text-rose-600">Error generando: ${e.message}</p>`;
    } finally {
      if(btn){ btn.disabled = false; btn.textContent = 'Generar Consulta SQL ✨'; }
    }
  }

  // LOGIN
  async function login(e){
    if(e && e.preventDefault) e.preventDefault();
    const email = el('adminEmail')?.value?.trim();
    const pass = el('adminPassword')?.value;
    const msg = el('loginMessage'); if(msg) msg.textContent = '';
    try{
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;
      loggedInUser = { uid, username: email.split('@')[0] };
      // show admin panels
      ['addFunctionSection','fixErrorSection','adminManagementSection'].forEach(show);
      hide('adminLoginModal');
      el('adminEmail').value = ''; el('adminPassword').value='';
      alert('Login OK como '+loggedInUser.username);
    }catch(err){
      console.error('login err', err);
      if(msg) msg.textContent = 'Credenciales incorrectas o error.';
    }
  }

  // add/update function
  async function addOrUpdateFunction(e){ 
    e.preventDefault();
    if(!loggedInUser){ alert('Inicia sesión primero'); return; }
    const name = el('funcName')?.value.trim(), description = el('funcDescription')?.value.trim(), syntax = el('funcSyntax')?.value.trim();
    if(!name||!description||!syntax){ alert('Completa campos'); return; }
    try{
      if(editingId){
        await updateDoc(doc(db, FUNCTIONS_PATH, editingId), { name, description, syntax });
        editingId = null;
        alert('Actualizado');
      } else {
        await addDoc(collection(db, FUNCTIONS_PATH), { name, description, syntax, createdAt: new Date() });
        alert('Agregado');
      }
      el('addFunctionForm').reset();
    }catch(e){ alert('Error: '+e.message); }
  }

  // other small features
  async function createAdmin(e){
    e.preventDefault();
    const email = el('newAdminEmail')?.value.trim();
    const pass = el('newAdminPassword')?.value;
    const username = el('newAdminUsername')?.value.trim();
    if(!email||!pass||!username){ el('adminMessage').textContent = 'Completa todos los campos'; return; }
    try{
      const uc = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, ADMINS_PATH, uc.user.uid), { uid: uc.user.uid, username, email, isAdmin:true, lastLogin:null });
      el('adminMessage').textContent = 'Admin creado';
      el('createAdminForm').reset();
    }catch(err){ el('adminMessage').textContent = 'Err: '+(err.code||err.message); }
  }

  // FIX SYNTAX (IA)
  async function fixSyntaxWithAI(){
    const syntax = el('errorInput')?.value?.trim();
    const key = el('correctionKey')?.value?.trim();
    const out = el('correctionResult');
    if(!syntax){ if(out) out.innerHTML = 'Ingresa SQL'; return; }
    if(key && key !== SUPER_ADMIN_KEY){ if(out) out.innerHTML = 'Clave incorrecta'; return; }
    try{
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
      const prompt = `Corrige y optimiza este SQL, devuelve solo el código: ${syntax}`;
      const payload = { contents:[{ parts:[{ text: prompt }] }], systemInstruction:{ parts:[{ text: "Devuelve solo SQL" }] } };
      const r = await fetch(apiUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await r.json();
      const txt = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const corrected = txt.replace(/```sql|```/g,'').trim();
      if(out) out.innerHTML = `<pre class="p-2 bg-emerald-50 rounded">${(corrected||'').replace(/</g,'&lt;')}</pre>`;
    }catch(e){ if(out) out.innerHTML = 'Error IA: '+e.message; }
  }

  // wiring listeners & exposing to window for debug
  document.addEventListener('DOMContentLoaded', ()=>{
    initializeTheme();
    initFirebase();

    el('descriptionSearchButton')?.addEventListener('click', generateSQLQuery);
    el('adminDropdown')?.addEventListener('click', ()=> el('adminLoginModal').classList.toggle('hidden'));
    el('showAdminLogin')?.addEventListener && el('showAdminLogin').addEventListener('click', ()=> el('adminLoginModal').classList.remove('hidden'));
    el('closeAdminModalButton')?.addEventListener('click', ()=> el('adminLoginModal').classList.add('hidden'));
    el('loginForm')?.addEventListener('submit', login);
    el('addFunctionForm')?.addEventListener('submit', addOrUpdateFunction);
    el('createAdminForm')?.addEventListener('submit', createAdmin);
    el('fixButton')?.addEventListener('click', fixSyntaxWithAI);
    el('searchInput')?.addEventListener('input', (e)=> {
      const term = e.target.value.toLowerCase();
      const filtered = functionsList.filter(f => ((f.name||'')+(f.description||'')+(f.syntax||'')).toLowerCase().includes(term));
      renderFunctions(filtered);
    });

    // expose
    window.generateSQLQuery = generateSQLQuery;
    window.login = login;
    window.fixSyntaxWithAI = fixSyntaxWithAI;

    console.log('Test UI ready');
  });
  </script>
</body>
</html>