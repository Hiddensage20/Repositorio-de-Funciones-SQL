<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Functions Repository</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Asegúrate de importar getAuth
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDocs, setDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (Se mantiene la configuración original del usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
            authDomain: "codigograbado.firebaseapp.com",
            projectId: "codigograbado",
            storageBucket: "codigograbado.firebasestorage.app",
            messagingSenderId: "346430888474",
            appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
            measurementId: "G-626THBS8CJ"
        };
        // Usamos el token inicial si está disponible, sino null.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, loggedInUser = null;
        let functionsList = [];
        let editingId = null;
        let confirmActionCallback = null; // Para el modal de confirmación

        // Credenciales de Super Admin (Recuperadas del código original)
        const SUPER_ADMIN_USERNAME = 'GravisLudio';
        const SUPER_ADMIN_KEY = 'DT10VazC;#9i';
        
        // Rutas de Firestore (Se asume que la ruta pública incluye el appId correcto)
        const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
        const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
        const ADMINS_PATH = `${DB_ROOT}/admins`;
        const LOGS_PATH = `${DB_ROOT}/logs`;
        const NOTIFICATIONS_PATH = `${DB_ROOT}/notifications`;

        // Función para manejar el modal de confirmación (reemplaza a window.confirm)
        const showConfirmModal = (message, onConfirm) => {
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');
            confirmActionCallback = onConfirm;
        };

        const hideConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
            confirmActionCallback = null;
        };

        const handleConfirm = (isConfirmed) => {
            if (isConfirmed && confirmActionCallback) {
                confirmActionCallback();
            }
            hideConfirmModal();
        };

        // Función para inicializar Firebase (CORREGIDA)
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // ✨ CORRECCIÓN CLAVE: Inicializar auth aquí
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;
                
                console.log("Firebase inicializado y autenticación exitosa.");
                fetchFunctions();
                fetchNotifications();
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage("Error: No se pudo conectar a la base de datos.", 'error');
            }
        };

        const showMessage = (message, type = 'info') => {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = message;
            statusMessage.className = 'mt-4 text-center p-3 rounded-lg font-medium';
            if (type === 'error') {
                statusMessage.classList.add('bg-rose-200', 'text-rose-800');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-emerald-200', 'text-emerald-800');
            } else {
                statusMessage.classList.add('bg-indigo-200', 'text-indigo-800');
            }
        };

        const fetchFunctions = () => {
            if (!db) {
                console.error("Firestore no está inicializado.");
                return;
            }
            const q = collection(db, FUNCTIONS_PATH);
            onSnapshot(q, (snapshot) => {
                functionsList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                displayFunctions();
            }, (error) => {
                console.error("Error al obtener funciones:", error);
                showMessage("Error al cargar las funciones.", 'error');
            });
        };

        const fetchNotifications = () => {
            if (!db || !userId) {
                console.error("Firestore no está inicializado o el ID de usuario no está disponible.");
                return;
            }
            // Nota: El path de las notificaciones está en una estructura diferente, asumo que es para un solo usuario loggeado.
            const q = collection(db, `${NOTIFICATIONS_PATH}/users/${userId}/notifications`);
            onSnapshot(q, (snapshot) => {
                // Mapeamos los datos y convertimos la marca de tiempo a un objeto Date para ordenar
                const notifications = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                displayNotifications(notifications);
            }, (error) => {
                console.error("Error al obtener notificaciones:", error);
            });
        };

        const addNotification = async (func) => {
            if (!userId) {
                console.error("ID de usuario no disponible, no se puede agregar la notificación.");
                return;
            }
            try {
                // Se utiliza el ID del usuario loggeado para guardar la notificación
                await addDoc(collection(db, `${NOTIFICATIONS_PATH}/users/${userId}/notifications`), {
                    message: `Se ha agregado una nueva función: "${func.name}" con la descripción: "${func.description}".`,
                    createdAt: new Date()
                });
            } catch (e) {
                console.error("Error al agregar notificación:", e);
            }
        };

        const displayNotifications = (notifications) => {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            notificationsList.innerHTML = '';
            // Ordenar por fecha de creación (más reciente primero)
            notifications.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-center text-gray-500">No hay notificaciones.</p>';
                return;
            }

            notifications.forEach(notif => {
                const date = notif.createdAt ? new Date(notif.createdAt.toDate()).toLocaleString() : 'Fecha desconocida';
                const notifItem = document.createElement('div');
                notifItem.className = 'bg-indigo-200 p-3 rounded-md mb-2';
                notifItem.innerHTML = `<p class="text-indigo-800 text-sm">${notif.message}</p>
                                         <span class="text-xs text-indigo-600">${date}</span>`;
                notificationsList.appendChild(notifItem);
            });
        };

        const displayFunctions = (functionsToDisplay = functionsList) => {
            const listElement = document.getElementById('functionsList');
            const searchList = document.getElementById('searchFunctionsList');
            listElement.innerHTML = '';
            searchList.innerHTML = '';

            // Verifica si el usuario está loggeado (sección de agregar/editar es visible)
            const isUserLoggedIn = loggedInUser !== null;

            if (functionsToDisplay.length === 0) {
                listElement.innerHTML = '<p class="text-center text-gray-500">No se encontraron funciones.</p>';
            }

            functionsToDisplay.forEach(func => {
                const funcItem = document.createElement('div');
                funcItem.className = 'bg-gray-200 p-4 rounded-lg shadow-md mb-4';
                funcItem.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800">${func.name}</h3>
                    <p class="text-sm text-gray-600 mb-2"><strong>Descripción:</strong> ${func.description}</p>
                    <div class="bg-white p-3 rounded-lg border border-gray-400 overflow-x-auto">
                        <pre class="whitespace-pre-wrap font-mono text-gray-800"><code>${func.syntax}</code></pre>
                    </div>
                    <div class="mt-4 flex space-x-2 ${isUserLoggedIn ? '' : 'hidden'}">
                        <button class="edit-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Editar</button>
                        <button class="delete-btn bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm" data-id="${func.id}">Eliminar</button>
                    </div>
                `;
                listElement.appendChild(funcItem);

                if (isUserLoggedIn) {
                    funcItem.querySelector('.edit-btn').addEventListener('click', () => editFunction(func));
                    funcItem.querySelector('.delete-btn').addEventListener('click', () => deleteFunction(func.id));
                }

                const searchItem = document.createElement('li');
                searchItem.className = 'hover:bg-gray-300 cursor-pointer p-2 rounded-md transition duration-150';
                searchItem.textContent = func.name;
                searchItem.onclick = () => {
                    // Al hacer clic en la lista rápida, rellena el campo de búsqueda de IA
                    document.getElementById('descriptionSearch').value = func.description;
                    document.getElementById('descriptionSearch').focus();
                    showMessage(`Descripción de la función "${func.name}" cargada en el generador de consultas.`, 'info');
                };
                searchList.appendChild(searchItem);
            });
        };

        const validateFunctionWithAI = async (syntax) => {
            // La clave de la API se mantiene la del código del usuario
            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; // Usando el modelo de preview más reciente
            const prompt = `Eres un experto en SQL. Evalúa si la siguiente sintaxis es una consulta de SQL válida. Si no es válida, describe en no más de 10 palabras cuál es el error. No ofrezcas correcciones ni explicaciones adicionales. Sintaxis: ${syntax}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Eres un experto en SQL. Responde con 'SÍ' o 'NO' seguido de un mensaje breve sobre el error." }] },
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                if (text.trim().toUpperCase().startsWith('SÍ')) {
                    return { valid: true, message: '¡Validación exitosa!' };
                } else {
                    // Limpia el prefijo 'NO.' del mensaje de error
                    const errorMessage = text.trim().replace(/^NO\.?\s*/i, '').trim();
                    return { valid: false, message: errorMessage || 'Error de sintaxis no especificado.' };
                }
            } catch (error) {
                console.error("Error al validar con IA:", error);
                return { valid: false, message: "No se pudo validar con la IA. Error de conexión o API." };
            }
        };

        const addOrUpdateFunction = async (event) => {
            event.preventDefault();
            const name = document.getElementById('funcName').value.trim();
            const description = document.getElementById('funcDescription').value.trim();
            const syntax = document.getElementById('funcSyntax').value.trim();
            const button = document.getElementById('addFunctionButton');
            const originalButtonText = editingId ? 'Actualizar Función' : 'Guardar Función';
            
            if (!loggedInUser) {
                showMessage('Debes iniciar sesión para realizar esta acción.', 'error');
                return;
            }

            if (!name || !description || !syntax) {
                showMessage('Todos los campos son obligatorios.', 'error');
                return;
            }

            button.textContent = 'Validando...';
            button.disabled = true;

            const validationResult = await validateFunctionWithAI(syntax);

            if (!validationResult.valid) {
                showMessage(`Error al agregar la información. Hay un error en la sintaxis: ${validationResult.message}`, 'error');
                button.textContent = originalButtonText;
                button.disabled = false;
                return;
            }

            try {
                if (editingId) {
                    // Actualizar
                    await updateDoc(doc(db, FUNCTIONS_PATH, editingId), {
                        name,
                        description,
                        syntax,
                    });
                    await addDoc(collection(db, LOGS_PATH), {
                        action: "edited",
                        user: loggedInUser.username,
                        functionName: name,
                        timestamp: new Date()
                    });
                    showMessage(`Función actualizada con éxito.`, 'success');
                    editingId = null;
                    document.getElementById('addFunctionButton').textContent = 'Guardar Función';
                } else {
                    // Agregar
                    await addDoc(collection(db, FUNCTIONS_PATH), {
                        name,
                        description,
                        syntax,
                        createdAt: new Date()
                    });
                    await addDoc(collection(db, LOGS_PATH), {
                        action: "added",
                        user: loggedInUser.username,
                        functionName: name,
                        timestamp: new Date()
                    });
                    showMessage(`Función agregada con éxito.`, 'success');
                    await addNotification({name, description, syntax});
                }
                document.getElementById('addFunctionForm').reset();
            } catch (e) {
                console.error("Error al agregar/actualizar documento: ", e);
                showMessage("Error al guardar la función. Verifica la consola de Firebase.", 'error');
            } finally {
                button.textContent = originalButtonText;
                button.disabled = false;
            }
        };

        const editFunction = (func) => {
            editingId = func.id;
            document.getElementById('funcName').value = func.name;
            document.getElementById('funcDescription').value = func.description;
            document.getElementById('funcSyntax').value = func.syntax;
            document.getElementById('addFunctionButton').textContent = 'Actualizar Función';
            // Scroll suave a la sección de edición
            document.getElementById('addFunctionSection').scrollIntoView({ behavior: 'smooth' });
        };

        // Función de eliminación (ACTUALIZADA con modal)
        const deleteFunction = async (id) => {
            if (!loggedInUser) {
                showMessage('Debes iniciar sesión para realizar esta acción.', 'error');
                return;
            }
            
            showConfirmModal('¿Estás seguro de que quieres eliminar esta función? Esta acción no se puede deshacer.', async () => {
                try {
                    const docRef = doc(db, FUNCTIONS_PATH, id);
                    const funcSnap = await getDoc(docRef);
                    if (funcSnap.exists()) {
                        await deleteDoc(docRef);
                        await addDoc(collection(db, LOGS_PATH), {
                            action: "deleted",
                            user: loggedInUser.username,
                            functionName: funcSnap.data().name,
                            timestamp: new Date()
                        });
                        showMessage('Función eliminada con éxito.', 'success');
                    }
                } catch (e) {
                    console.error("Error al eliminar documento: ", e);
                    showMessage("Error al eliminar la función.", 'error');
                }
            });
        };

        const generateSQLQuery = async () => {
            const description = document.getElementById('descriptionSearch').value.trim();
            const resultsDiv = document.getElementById('recommendationResults');
            if (!description) {
                resultsDiv.innerHTML = '<p class="text-rose-500 mt-2 text-center">Por favor, describe tu necesidad.</p>';
                return;
            }
            resultsDiv.innerHTML = '<p class="text-indigo-500 mt-2 text-center">Generando consulta... ✨</p>';
            
            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const prompt = `Eres un experto en SQL. Genera una consulta SQL para la siguiente descripción. Solo devuelve el código SQL, sin explicaciones, sin comentarios y sin encabezados markdown como 'sql'. Descripción: ${description}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: "Genera código SQL preciso y conciso. No incluyas ningún texto de explicación antes o después del código." }] },
            };

            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo generar la consulta. Intenta una descripción diferente.';
                resultsDiv.innerHTML = `<div class="bg-indigo-100 p-4 rounded-md mt-4">
                    <p class="font-bold text-indigo-700 mb-2">Consulta generada ✨:</p>
                    <pre class="bg-white p-2 rounded-md border border-indigo-300 whitespace-pre-wrap text-indigo-800 overflow-x-auto"><code>${text.trim().replace(/^```sql\n|```$/g, '').trim()}</code></pre>
                </div>`;
            } catch (error) {
                console.error("Error al generar la consulta:", error);
                resultsDiv.innerHTML = '<p class="text-rose-500 mt-2">Error al generar la consulta. Vuelve a intentarlo.</p>';
            }
        };

        const fixSyntaxWithAI = async () => {
            const correctionKey = document.getElementById('correctionKey').value;
            const errorArea = document.getElementById('errorInput').value.trim();
            const correctionResult = document.getElementById('correctionResult');

            if (correctionKey !== SUPER_ADMIN_KEY) { // Usamos la clave del Super Admin
                correctionResult.innerHTML = `<p class="text-rose-500 mt-4">Clave incorrecta. No se puede corregir el error.</p>`;
                return;
            }

            if (!errorArea) {
                correctionResult.innerHTML = `<p class="text-rose-500 mt-4">Por favor, ingresa el código con errores.</p>`;
                return;
            }

            correctionResult.innerHTML = '<p class="text-indigo-500 mt-4 text-center">Corrigiendo sintaxis... ✨</p>';

            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const prompt = `Corrige y mejora el siguiente fragmento de código SQL. Si el código es sintácticamente correcto, optimízalo si es posible. Solo devuelve el código SQL corregido o mejorado, sin explicaciones adicionales, sin comentarios y sin encabezados markdown como 'sql': ${errorArea}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: "Eres un experto en SQL y tu única tarea es corregir y optimizar el código SQL. No agregues texto adicional." }] },
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No se pudo corregir. Intenta de nuevo.';
                const cleanText = text.trim().replace(/^```sql\n|```$/g, '').trim();

                correctionResult.innerHTML = `<div class="bg-emerald-100 p-4 rounded-md mt-4">
                    <p class="font-bold text-emerald-700">¡Clave correcta! A continuación se presenta la corrección ✨:</p>
                    <pre class="bg-white p-2 rounded-md border border-emerald-300 whitespace-pre-wrap text-emerald-800 overflow-x-auto"><code>${cleanText}</code></pre>
                </div>`;
            } catch (error) {
                console.error("Error al corregir el código:", error);
                correctionResult.innerHTML = '<p class="text-rose-500 mt-4">Error al corregir el código. Vuelve a intentarlo.</p>';
            }
        };
        
        const createAdmin = async (event) => {
            event.preventDefault();
            const newAdminUsername = document.getElementById('newAdminUsername').value.trim();
            const newAdminKey = document.getElementById('newAdminKey').value;
            const adminMessage = document.getElementById('adminMessage');

            adminMessage.textContent = ''; // Limpiar mensajes anteriores

            if (!newAdminUsername || !newAdminKey) {
                adminMessage.textContent = 'Ambos campos son obligatorios.';
                adminMessage.className = 'mt-4 text-center text-rose-500 text-sm';
                return;
            }
            
            const adminCollectionPath = ADMINS_PATH;
            console.log(`Creating new admin at: ${adminCollectionPath}/${newAdminUsername}`);

            try {
                await setDoc(doc(db, adminCollectionPath, newAdminUsername), {
                    username: newAdminUsername,
                    key: newAdminKey,
                    lastLogin: null
                });
                adminMessage.textContent = `Administrador ${newAdminUsername} creado con éxito.`;
                adminMessage.className = 'mt-4 text-center text-emerald-500 text-sm';
                document.getElementById('createAdminForm').reset();
            } catch (e) {
                console.error("Error al crear administrador:", e);
                adminMessage.textContent = `Error al crear administrador: ${e.message}`;
                adminMessage.className = 'mt-4 text-center text-rose-500 text-sm';
            }
        };

        const login = async (event) => {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const key = document.getElementById('loginKey').value;
            const loginMessage = document.getElementById('loginMessage');
            
            loginMessage.textContent = ''; // Limpiar
            loggedInUser = null; // Resetear el estado de inicio de sesión
            
            let userFound = false;
            let userData = null;

            if (username === SUPER_ADMIN_USERNAME && key === SUPER_ADMIN_KEY) {
                loggedInUser = { username: SUPER_ADMIN_USERNAME, isAdmin: true, lastLogin: null };
                userFound = true;
            } else {
                try {
                    const docRef = doc(db, ADMINS_PATH, username); // Consulta directa por nombre de usuario
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const admin = docSnap.data();
                        if (admin.key === key) {
                            loggedInUser = { username: admin.username, isAdmin: false, lastLogin: admin.lastLogin };
                            userFound = true;
                            userData = docSnap;
                        }
                    }
                } catch (e) {
                    console.error("Error al buscar administrador:", e);
                }
            }

            if (userFound) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('addFunctionSection').classList.remove('hidden');
                document.getElementById('fixErrorSection').classList.remove('hidden');
                
                // Actualizar visibilidad de botones en la lista actual
                displayFunctions();

                if (loggedInUser.isAdmin) {
                    document.getElementById('adminManagementSection').classList.remove('hidden');
                    document.getElementById('notificationsSection').classList.remove('hidden');
                } else {
                    // Si no es Super Admin, generar mensaje de bienvenida
                    await sendWelcomeMessage(loggedInUser.lastLogin, loggedInUser.username);
                    if (userData) {
                        // Actualizar la hora del último inicio de sesión para el próximo login
                        await updateDoc(userData.ref, { lastLogin: new Date() });
                    }
                }
                showMessage(`¡Bienvenido, ${loggedInUser.username}! Has iniciado sesión con éxito.`, 'success');
                document.getElementById('welcomeMessage').classList.remove('hidden');

            } else {
                loginMessage.textContent = 'Usuario o clave incorrecta.';
                loginMessage.classList.remove('text-emerald-500');
                loginMessage.classList.add('text-rose-500');
            }
        };

        const sendWelcomeMessage = async (lastLogin, username) => {
            const welcomeMessageDiv = document.getElementById('welcomeMessage');
            let actionsSummary = '';
            
            // Calculamos el resumen de acciones desde el último login
            if (lastLogin && lastLogin.toDate) {
                const lastLoginDate = lastLogin.toDate();
                const logsRef = collection(db, LOGS_PATH);
                // No usamos orderBy aquí para evitar problemas de índice
                const q = query(logsRef, where("user", "==", username));
                const querySnapshot = await getDocs(q);

                const recentActions = [];
                querySnapshot.forEach(doc => {
                    const log = doc.data();
                    // Comparamos la fecha de registro (timestamp) con la fecha del último login
                    if (log.timestamp && log.timestamp.toDate() > lastLoginDate) {
                        recentActions.push(log);
                    }
                });

                if (recentActions.length > 0) {
                    const added = recentActions.filter(a => a.action === 'added').map(a => a.functionName).join(', ');
                    const edited = recentActions.filter(a => a.action === 'edited').map(a => a.functionName).join(', ');
                    const deleted = recentActions.filter(a => a.action === 'deleted').map(a => a.functionName).join(', ');
                    
                    actionsSummary = `Tu actividad reciente: ${added.length > 0 ? `agregaste: ${added}. ` : ''}${edited.length > 0 ? `editaste: ${edited}. ` : ''}${deleted.length > 0 ? `eliminaste: ${deleted}. ` : ''}`;
                }
            }
            
            const diffMs = lastLogin && lastLogin.toDate ? new Date() - lastLogin.toDate() : null;
            const diffDays = diffMs ? Math.floor(diffMs / (1000 * 60 * 60 * 24)) : null;
            const timeAgo = lastLogin ? (diffDays ? `${diffDays} día(s)` : 'hace poco') : 'primera vez';

            welcomeMessageDiv.textContent = 'Generando mensaje de bienvenida...';

            const apiKey = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const prompt = `Genera un mensaje de bienvenida para un administrador de una base de datos de funciones de SQL. El nombre del usuario es "${username}". Su última sesión fue hace "${timeAgo}". El mensaje debe ser breve, motivador y debe recordarle revisar el panel de notificaciones para estar al día con los cambios de los demás administradores. Incluye el siguiente resumen de su actividad: "${actionsSummary}". Termina el mensaje con la frase "¡Buen código!".`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Genera un mensaje de bienvenida amigable y motivador. No uses encabezados ni negritas en todo el texto." }] },
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            const initialDelay = 1000;

            const makeApiCall = async () => {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && attempts < maxAttempts - 1) {
                    throw new Error("Rate limit exceeded");
                }
                return response;
            };

            try {
                let response;
                while (attempts < maxAttempts) {
                    try {
                        response = await makeApiCall();
                        break;
                    } catch (error) {
                        if (error.message === "Rate limit exceeded") {
                            const delay = initialDelay * Math.pow(2, attempts);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempts++;
                        } else {
                            throw error;
                        }
                    }
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || `¡Bienvenido de nuevo, ${username}!`;
                welcomeMessageDiv.textContent = text;
            } catch (error) {
                console.error("Error al generar el mensaje de bienvenida:", error);
                welcomeMessageDiv.textContent = `¡Bienvenido de nuevo, ${username}! Te recordamos que revises el panel de notificaciones. ¡Buen código!`;
            }
        };
        
        const searchFunctions = (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const filteredFunctions = functionsList.filter(func => 
                func.name.toLowerCase().includes(searchTerm) || 
                func.description.toLowerCase().includes(searchTerm) ||
                func.syntax.toLowerCase().includes(searchTerm)
            );
            displayFunctions(filteredFunctions);
        };


        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('addFunctionForm').addEventListener('submit', addOrUpdateFunction);
            document.getElementById('descriptionSearchButton').addEventListener('click', generateSQLQuery);
            document.getElementById('fixButton').addEventListener('click', fixSyntaxWithAI);
            document.getElementById('createAdminForm').addEventListener('submit', createAdmin);
            document.getElementById('functionSearchInput').addEventListener('input', searchFunctions);
            // Eventos para el modal de confirmación
            document.getElementById('confirmBtn').addEventListener('click', () => handleConfirm(true));
            document.getElementById('cancelBtn').addEventListener('click', () => handleConfirm(false));
        });
    </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">SQL Functions Repository</h1>
            <p class="text-gray-600">Un repositorio colaborativo de funciones de SQL.</p>
            <p id="userIdDisplay" class="text-sm text-gray-500 mt-2"></p>
        </header>
        
        <div id="welcomeMessage" class="text-center mt-4 mb-8 text-xl text-indigo-800 font-semibold hidden"></div>

        <section id="loginSection" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 text-center">Iniciar Sesión (Admin)</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">Usuario (GravisLudio):</label>
                    <input type="text" id="loginUsername" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="loginKey" class="block text-sm font-medium text-gray-700 mb-1">Clave (DT10VazC;#9i):</label>
                    <input type="password" id="loginKey" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                    Ingresar
                </button>
            </form>
            <p id="loginMessage" class="mt-4 text-center text-sm"></p>
        </section>

        <div>
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 lg:col-span-1 h-fit">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Generar Código SQL</h2>
                    <div class="mb-4">
                        <label for="descriptionSearch" class="block text-sm font-medium text-gray-700 mb-1">Describe tu necesidad:</label>
                        <textarea id="descriptionSearch" rows="3" class="w-full p-2 border border-gray-400 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Obtener el promedio de ventas de productos por categoría en el último mes."></textarea>
                    </div>
                    <button id="descriptionSearchButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        Generar Consulta SQL ✨
                    </button>
                    <div id="recommendationResults" class="mt-4"></div>
                    
                    <h3 class="text-xl font-bold mt-8 mb-2 text-gray-900">Funciones rápidas (Clic para usar)</h3>
                    <ul id="searchFunctionsList" class="bg-gray-100 p-2 rounded-lg max-h-48 overflow-y-auto border border-gray-300">
                        <p class="text-center text-gray-500 text-sm py-2">Cargando sugerencias...</p>
                    </ul>
                </section>

                <section class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">Listado de Funciones</h2>
                        <div class="mb-4">
                            <label for="functionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar funciones:</label>
                            <input type="text" id="functionSearchInput" class="w-full p-2 border border-gray-400 rounded-md focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: COUNT, AVG, cadena">
                        </div>
                        <div id="functionsList">
                            <p class="text-center text-gray-500">Cargando funciones...</p>
                        </div>
                    </div>
                </section>
            </main>
            
            <section id="notificationsSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Notificaciones del Administrador</h2>
                <div id="notificationsList" class="max-h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg border border-indigo-300">
                    <p class="text-center text-gray-500 text-sm">No hay notificaciones.</p>
                </div>
            </section>

            <section id="fixErrorSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Corregir y Optimizar SQL con IA</h2>
                <div class="mb-4">
                    <label for="errorInput" class="block text-sm font-medium text-gray-700 mb-1">Ingresa el código SQL con errores o para optimizar:</label>
                    <textarea id="errorInput" rows="4" class="w-full p-2 border border-gray-400 rounded-md font-mono focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: SELECT nombre FROM usuarios WHERE edad > 25"></textarea>
                </div>
                <div class="mb-4">
                    <label for="correctionKey" class="block text-sm font-medium text-gray-700 mb-1">Clave de Super Admin (DT10VazC;#9i):</label>
                    <input type="password" id="correctionKey" class="w-full p-2 border border-gray-400 rounded-md focus:ring-purple-500 focus:border-purple-500">
                </div>
                <button id="fixButton" type="button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        Corregir Sintaxis ✨
                    </button>
                    <div id="correctionResult"></div>
                </section>

            <section id="addFunctionSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Agregar Nueva Función</h2>
                <form id="addFunctionForm">
                    <div class="mb-4">
                        <label for="funcName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Función (Ej: AVG, CONCAT):</label>
                        <input type="text" id="funcName" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="funcDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción breve:</label>
                        <textarea id="funcDescription" rows="3" class="w-full p-2 border border-gray-400 rounded-md" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="funcSyntax" class="block text-sm font-medium text-gray-700 mb-1">Sintaxis (Ej. SELECT CONCAT(col1, col2) FROM tabla;):</label>
                        <textarea id="funcSyntax" rows="3" class="w-full p-2 border border-gray-400 rounded-md font-mono" required></textarea>
                    </div>
                    <button id="addFunctionButton" type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-200">
                        Guardar Función
                    </button>
                </form>
                <div id="statusMessage" class="mt-4 text-center"></div>
            </section>

            <!-- Sección de Administración de Usuarios (Solo para Super Admin) -->
            <section id="adminManagementSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Gestión de Usuarios Admin</h2>
                <form id="createAdminForm">
                    <p class="text-sm text-gray-600 mb-4">Esta sección solo es visible para el Super Admin.</p>
                    <div class="mb-4">
                        <label for="newAdminUsername" class="block text-sm font-medium text-gray-700 mb-1">Nuevo Usuario:</label>
                        <input type="text" id="newAdminUsername" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="newAdminKey" class="block text-sm font-medium text-gray-700 mb-1">Clave:</label>
                        <input type="password" id="newAdminKey" class="w-full p-2 border border-gray-400 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                        Crear Administrador
                    </button>
                    <p id="adminMessage" class="mt-4 text-center text-sm"></p>
                </form>
            </section>
        </div>
    </div>

    <!-- Modal de Confirmación Personalizado (Reemplaza a window.confirm) -->
    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Confirmación Requerida</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
                <button id="confirmBtn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
