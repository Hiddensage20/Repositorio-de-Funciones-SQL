<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Código Grabado</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ===== Estilo Blueberry-Dark Moderno (tema único oscuro) ===== -->
  <style>
    /* Reset ligero */
    :root {
      --bg: #0B1220;         /* fondo principal */
      --panel: #111827;      /* paneles / cards (base) */
      --panel-2: #152235;    /* variante panel */
      --accent: #5A84D1;     /* blueberry accent */
      --muted: #9FB3D9;      /* texto secundario */
      --text: #E8EEF8;       /* texto principal */
      --glass: rgba(255,255,255,0.04);
    }

    html,body { height:100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg) 0%, #07101A 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 240ms ease, color 240ms ease;
    }

    /* Container */
    .center {
      max-width: 980px;
      margin: 18px auto;
      padding: 18px;
    }

    header {
      background: linear-gradient(90deg, rgba(12,18,30,0.9), rgba(10,14,24,0.9));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-radius: 10px;
      box-shadow: 0 6px 24px rgba(3,6,12,0.6);
    }
    header h1 {
      margin:0;
      font-weight:800;
      font-size:20px;
      color: var(--accent);
      letter-spacing: -0.02em;
    }

    /* Card base */
    .card {
      border-radius: 12px;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      color: var(--text);
      box-shadow: 0 8px 30px rgba(3,6,12,0.6);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(90,132,209,0.06);
    }

    /* Inputs / textarea */
    input[type="text"], input[type="email"], input[type="password"], textarea {
      background: rgba(255,255,255,0.03);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.04);
      padding: 10px 12px;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 6px 20px rgba(90,132,209,0.12);
    }

    /* Buttons */
    button {
      background-color: var(--accent);
      color: #061025;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.12s ease;
      box-shadow: 0 6px 16px rgba(24,44,88,0.25);
    }
    button:hover { transform: translateY(-3px); filter: brightness(1.05); }
    button:active { transform: translateY(0); }
    button.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: none;
    }
    button.ghost {
      background: rgba(255,255,255,0.03);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.02);
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    /* Titles */
    h2 { margin:0 0 10px 0; font-size:18px; color:var(--text); }
    h3 { margin:0 0 8px 0; font-size:16px; color:var(--muted); }

    /* Small helpers */
    .muted { color: var(--muted); font-size:13px; }
    .mt-4 { margin-top:16px; }
    .mb-2 { margin-bottom:8px; }
    .p-2 { padding:8px; }

    /* Recommendation results */
    #recommendationResults pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding: 14px;
      border-radius: 8px;
      border: 1px solid rgba(90,132,209,0.04);
      color: var(--text);
      overflow-x: auto;
    }

    /* List / functions */
    #functionsList .card-item {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.02);
    }

    /* Admin modal */
    #adminLoginModal {
      position: fixed;
      inset: 0;
      display: none; /* controlado por JS */
      align-items: center;
      justify-content: center;
      background: rgba(2,6,11,0.6);
      z-index: 60;
    }
    #adminLoginModal .modal-body {
      max-width: 420px;
      width: calc(100% - 32px);
      background: linear-gradient(180deg, rgba(20,28,42,0.98), rgba(12,18,28,0.98));
      padding: 18px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* Responsive small tweaks */
    @media (max-width: 720px) {
      .center { padding: 12px; }
      header h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="center">
    <header>
      <h1>Código <span style="color:var(--accent)">Grabado</span></h1>
      <div style="display:flex;align-items:center;gap:10px;">
        <!-- Mantengo el switch por compatibilidad pero el tema es oscuro por defecto -->
        <label class="muted" style="display:none;">
          Claro <input id="darkModeToggle" type="checkbox" />
        </label>
        <div style="position:relative;">
          <button id="adminDropdown" class="ghost">Admin ▼</button>
          <!-- Opcional: pequeño menú, controlado por JS -->
        </div>
      </div>
    </header>

    <!-- Generador -->
    <section class="card mt-4">
      <h2>Generar Código SQL</h2>
      <p class="muted mb-2">Describe tu necesidad:</p>
      <textarea id="descriptionSearch" rows="3" style="min-height:72px;"></textarea>
      <button id="descriptionSearchButton" class="mt-4" style="width:100%;">Generar Consulta SQL ✨</button>
      <div id="recommendationResults" class="mt-4"></div>
    </section>

    <!-- Listado -->
    <section class="card">
      <h2>Listado de Comandos SQL</h2>
      <input id="searchInput" type="text" placeholder="Buscar comandos..." class="mt-4 mb-2" />
      <div id="functionsList" class="mt-4"></div>
    </section>

    <!-- Panel admin oculto -->
    <section id="addFunctionSection" class="card" style="display:none;">
      <h2>Agregar / Editar Comando</h2>
      <form id="addFunctionForm" class="mt-4">
        <input id="funcName" placeholder="Nombre" class="mb-2" />
        <textarea id="funcDescription" placeholder="Descripción" class="mb-2"></textarea>
        <textarea id="funcSyntax" placeholder="Sintaxis SQL" class="mb-2"></textarea>
        <div style="display:flex;gap:8px;">
          <button id="validateSyntaxButton" type="button" class="secondary">Validar con IA ✨</button>
          <button id="addFunctionButton" type="submit">Guardar</button>
        </div>
        <div id="validationMessage" class="mt-4 muted"></div>
      </form>
    </section>

    <section id="fixErrorSection" class="card" style="display:none;">
      <h2>Corregir Sintaxis SQL con IA</h2>
      <textarea id="errorInput" rows="3" placeholder="Pega aquí tu SQL con error" class="mt-4"></textarea>
      <input id="correctionKey" placeholder="Clave de Promoción (Admin)" class="mt-2" />
      <button id="fixButton" class="mt-3" style="width:100%;">Corregir Sintaxis ✨</button>
      <div id="correctionResult" class="mt-4"></div>
    </section>

    <section id="adminManagementSection" class="card" style="display:none;">
      <h2>Crear Nuevo Administrador</h2>
      <form id="createAdminForm" class="mt-4">
        <input id="newAdminEmail" type="email" placeholder="Email" class="mb-2" required />
        <input id="newAdminUsername" placeholder="Usuario" class="mb-2" required />
        <input id="newAdminPassword" type="password" placeholder="Contraseña" class="mb-2" required />
        <button style="width:100%;">Crear Admin</button>
        <p id="adminMessage" class="mt-3 muted"></p>
      </form>
    </section>

    <!-- login modal -->
    <div id="adminLoginModal">
      <div class="modal-body">
        <h3 style="margin:0 0 12px 0">Iniciar Sesión</h3>
        <form id="loginForm">
          <input id="adminEmail" type="email" placeholder="Email" class="mb-2" required />
          <input id="adminPassword" type="password" placeholder="Contraseña" class="mb-2" required />
          <div style="display:flex;gap:8px;">
            <button type="submit">Entrar</button>
            <button id="closeAdminModalButton" type="button" class="secondary">Cerrar</button>
          </div>
          <p id="loginMessage" class="mt-3 muted"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== JS (igual que tu versión funcional, con Firebase & Gemini) ===== -->
  <script type="module">
    // -------------- imports (firebase) --------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      doc,
      deleteDoc,
      updateDoc,
      getDoc,
      setDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ========== config ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCeD4TAPK2GuW01J5WQl7vJjmJWC671f-Y",
      authDomain: "codigograbado.firebaseapp.com",
      projectId: "codigograbado",
      storageBucket: "codigograbado.firebasestorage.app",
      messagingSenderId: "346430888474",
      appId: "1:346430888474:web:cbaa641fbf4fc62bca4fa3",
      measurementId: "G-626THBS8CJ"
    };
    const GEMINI_API_KEY = "AIzaSyBUjsv2ZW2vRjLuD2pAwVtgurMdTkXCO4Q";

    const SUPER_ADMIN_KEY = "DT10VazC;#9i";
    const DB_ROOT = `/artifacts/public/data/aTvZxvxzBtCnCNlURVrQ`;
    const FUNCTIONS_PATH = `${DB_ROOT}/sql_functions`;
    const ADMINS_PATH = `${DB_ROOT}/admins`;
    const LOGS_PATH = `${DB_ROOT}/logs`;

    // ========== global state ==========
    let db, auth, userId, loggedInUser = null, functionsList = [], editingId = null, isSyntaxValid = false;

    // ========== utils ==========
    const el = (id) => document.getElementById(id);
    const show = (id) => { const e = el(id); if (e) e.style.display = ''; };
    const hide = (id) => { const e = el(id); if (e) e.style.display = 'none'; };

    const showMessage = (targetId, text, type = 'info') => {
      const tgt = el(targetId);
      if (!tgt) return;
      let color = 'bg-indigo-200 text-indigo-800';
      if (type === 'error') color = 'bg-rose-200 text-rose-800';
      if (type === 'success') color = 'bg-emerald-200 text-emerald-800';
      tgt.innerHTML = `<div style="padding:10px;border-radius:8px;background:rgba(90,132,209,0.06);color:var(--text)">${text}</div>`;
    };

    // ========== theme init (fijo oscuro) ==========
    const initializeTheme = () => {
      // tema fijo oscuro: nada que alternar
      document.body.classList.add('dark');
      // esconder switch si existe
      const sw = el('darkModeToggle'); if (sw) sw.style.display = 'none';
    };

    // ========== firebase init ==========
    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        userId = auth.currentUser?.uid;
        console.log('Firebase OK, uid=', userId);
        watchFunctions();
      } catch (e) {
        console.error('FB init error', e);
        showMessage('recommendationResults', 'Error inicializando Firebase: ' + e.message, 'error');
      }
    }

    // ========== firestore sync ==========
    function watchFunctions() {
      if (!db) return;
      const q = collection(db, FUNCTIONS_PATH);
      onSnapshot(q, snapshot => {
        functionsList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderFunctions();
      }, err => {
        console.error('listen err', err);
        showMessage('recommendationResults', 'No se pudo cargar comandos', 'error');
      });
    }

    function renderFunctions() {
      const out = el('functionsList');
      if (!out) return;
      out.innerHTML = '';
      if (!functionsList.length) { out.innerHTML = '<p class="muted">No hay comandos.</p>'; return; }
      functionsList.forEach(f => {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.style.marginBottom = '10px';
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong style="color:var(--text)">${escapeHtml(f.name || 'Sin nombre')}</strong>
              <div class="muted" style="margin-top:6px">${escapeHtml(f.description || '')}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="ghost" data-id="${f.id}" style="padding:6px 10px">Ver</button>
              <button class="edit" style="padding:6px 10px;background:#445C9C;color:#fff;border-radius:8px;border:none" data-id="${f.id}">Editar</button>
              <button class="del" style="padding:6px 10px;background:#C2410C;color:#fff;border-radius:8px;border:none" data-id="${f.id}">Eliminar</button>
            </div>
          </div>
          <pre style="margin-top:8px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">${escapeHtml(f.syntax || '')}</pre>`;
        out.appendChild(card);

        const editBtn = card.querySelector('.edit');
        const delBtn = card.querySelector('.del');
        const viewBtn = card.querySelector('.ghost');

        viewBtn?.addEventListener('click', () => {
          el('descriptionSearch').value = f.description || '';
          el('descriptionSearch').focus();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        editBtn?.addEventListener('click', () => {
          el('funcName').value = f.name || '';
          el('funcDescription').value = f.description || '';
          el('funcSyntax').value = f.syntax || '';
          editingId = f.id;
          show('addFunctionSection');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        delBtn?.addEventListener('click', async () => {
          if (!loggedInUser) {
            alert('⚠️ Debes iniciar sesión como administrador para eliminar comandos.');
            return;
          }
          if (!confirm('¿Seguro que deseas eliminar este comando?')) return;
          try {
            await deleteDoc(doc(db, FUNCTIONS_PATH, f.id));
            alert('Comando eliminado con éxito.');
          } catch (e) {
            alert('Error al eliminar: ' + (e.message || e));
          }
        });

      });
    }

    // =========================
    // Helpers
    // =========================
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ========== GENERAR CONSULTA (Gemini) ==========
    async function generateSQLQuery() {
      const description = el('descriptionSearch')?.value.trim();
      if (!description) { showMessage('recommendationResults', 'Describe la necesidad primero', 'error'); return; }
      const btn = el('descriptionSearchButton'); if (btn) { btn.disabled = true; btn.textContent = 'Generando...'; }
      const resultsDiv = el('recommendationResults'); if (resultsDiv) resultsDiv.innerHTML = '';
      try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        const prompt = `Eres un experto en SQL. Genera SOLO la consulta SQL basándote en: "${description}". Sólo devuelve código SQL.`;
        const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: "Solo devuelve código SQL." }] } };
        const r = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!r.ok) throw new Error('API status ' + r.status);
        const data = await r.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const sql = text.replace(/```sql|```/g, '').trim();
        if (resultsDiv) {
          resultsDiv.innerHTML = `<h3 style="margin:0 0 8px 0">Consulta generada</h3><pre>${escapeHtml(sql)}</pre>`;
        }
      } catch (e) {
        console.error('gen err', e);
        if (el('recommendationResults')) el('recommendationResults').innerHTML = `<p style="color:#F97373">Error generando: ${e.message}</p>`;
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Generar Consulta SQL ✨'; }
      }
    }

    // ========== LOGIN ==========
    async function login(e) {
      if (e && e.preventDefault) e.preventDefault();
      const email = el('adminEmail')?.value?.trim();
      const pass = el('adminPassword')?.value;
      const msg = el('loginMessage'); if (msg) msg.textContent = '';
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;
        loggedInUser = { uid, username: email.split('@')[0] };
        ['addFunctionSection', 'fixErrorSection', 'adminManagementSection'].forEach(id => show(id));
        hide('adminLoginModal');
        el('adminEmail').value = ''; el('adminPassword').value = '';
        alert('Login OK como ' + loggedInUser.username);
      } catch (err) {
        console.error('login err', err);
        if (msg) {
          msg.textContent = 'Credenciales incorrectas o error.';
          msg.style.color = '#FCAEAE';
        }
      }
    }

    // ========== ADD / UPDATE FUNCTION ==========
    async function addOrUpdateFunction(e) {
      e.preventDefault();
      if (!loggedInUser) { alert('Inicia sesión primero'); return; }
      const name = el('funcName')?.value.trim(), description = el('funcDescription')?.value.trim(), syntax = el('funcSyntax')?.value.trim();
      if (!name || !description || !syntax) { alert('Completa campos'); return; }
      try {
        if (editingId) {
          await updateDoc(doc(db, FUNCTIONS_PATH, editingId), { name, description, syntax });
          editingId = null;
          alert('Actualizado');
        } else {
          await addDoc(collection(db, FUNCTIONS_PATH), { name, description, syntax, createdAt: new Date() });
          alert('Agregado');
        }
        el('addFunctionForm').reset();
      } catch (e) { alert('Error: ' + (e.message || e)); }
    }

    // ========== CREATE ADMIN ==========
    async function createAdmin(e) {
      e.preventDefault();
      const email = el('newAdminEmail')?.value.trim();
      const pass = el('newAdminPassword')?.value;
      const username = el('newAdminUsername')?.value.trim();
      if (!email || !pass || !username) { el('adminMessage').textContent = 'Completa todos los campos'; return; }
      try {
        const uc = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, ADMINS_PATH, uc.user.uid), { uid: uc.user.uid, username, email, isAdmin: true, lastLogin: null });
        el('adminMessage').textContent = 'Admin creado';
        el('createAdminForm').reset();
      } catch (err) { el('adminMessage').textContent = 'Err: ' + (err.code || err.message); }
    }

    // ========== FIX SQL (IA) ==========
    async function fixSyntaxWithAI() {
      const syntax = el('errorInput')?.value?.trim();
      const key = el('correctionKey')?.value?.trim();
      const out = el('correctionResult');
      if (!syntax) { if (out) out.innerHTML = 'Ingresa SQL'; return; }
      if (key && key !== SUPER_ADMIN_KEY) { if (out) out.innerHTML = 'Clave incorrecta'; return; }
      try {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        const prompt = `Corrige y optimiza este SQL, devuelve solo el código: ${syntax}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: "Devuelve solo SQL" }] } };
        const r = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await r.json();
        const txt = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const corrected = txt.replace(/```sql|```/g, '').trim();
        if (out) out.innerHTML = `<pre style="padding:10px;background:rgba(10,160,220,0.03);border-radius:8px">${escapeHtml(corrected)}</pre>`;
      } catch (e) { if (out) out.innerHTML = 'Error IA: ' + e.message; }
    }

    // ========== DOM Ready ==========
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      initFirebase();

      // UI wiring
      el('descriptionSearchButton')?.addEventListener('click', generateSQLQuery);
      el('adminDropdown')?.addEventListener('click', () => {
        const modal = el('adminLoginModal');
        if (modal) modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
      });
      el('closeAdminModalButton')?.addEventListener('click', () => el('adminLoginModal').style.display = 'none');

      el('loginForm')?.addEventListener('submit', login);
      el('addFunctionForm')?.addEventListener('submit', addOrUpdateFunction);
      el('createAdminForm')?.addEventListener('submit', createAdmin);
      el('fixButton')?.addEventListener('click', fixSyntaxWithAI);
      el('searchInput')?.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = functionsList.filter(f => ((f.name || '') + (f.description || '') + (f.syntax || '')).toLowerCase().includes(term));
        // render filtered list:
        const out = el('functionsList');
        if (!out) return;
        out.innerHTML = '';
        filtered.forEach(f => {
          const card = document.createElement('div');
          card.className = 'card-item';
          card.style.marginBottom = '10px';
          card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong style="color:var(--text)">${escapeHtml(f.name || 'Sin nombre')}</strong>
                <div class="muted" style="margin-top:6px">${escapeHtml(f.description || '')}</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="ghost" data-id="${f.id}" style="padding:6px 10px">Ver</button>
                <button class="edit" style="padding:6px 10px;background:#445C9C;color:#fff;border-radius:8px;border:none" data-id="${f.id}">Editar</button>
                <button class="del" style="padding:6px 10px;background:#C2410C;color:#fff;border-radius:8px;border:none" data-id="${f.id}">Eliminar</button>
              </div>
            </div>
            <pre style="margin-top:8px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">${escapeHtml(f.syntax || '')}</pre>`;
          out.appendChild(card);
        });
      });

      console.log('App JS listo con Blueberry-dark.');
    });
  </script>
</body>
</html>
